// 保存用戶遊戲到資料庫 - 修復RLS錯誤和用戶創建邏輯
        async function saveUserGamesToDB(steamId, games) {
            try {
                if (!supabase || !games || games.length === 0 || !currentUser) return;
                
                console.log(`嘗試保存用戶 ${steamId} 的 ${games.length} 個遊戲到資料庫`);
                
                // 首先檢查用戶是否存在
                let user = null;
                try {
                    const { data: existingUser, error: userError } = await supabase
                        .from('users')
                        .select('id, discord_id')
                        .eq('steam_id', steamId)
                        .maybeSingle(); // 使用 maybeSingle 避免 404 錯誤
                    
                    if (userError && userError.code !== 'PGRST116') {
                        console.warn('查詢用戶時發生錯誤:', userError.message);
                        return;
                    }
                    
                    user = existingUser;
                } catch (error) {
                    console.warn('用戶查詢失敗:', error.message);
                    return;
                }
                
                // 如果用戶不存在且是共享帳號，創建新用戶
                if (!user) {
                    const selectedUser = selectedUsers.find(u => u.id === steamId);
                    if (selectedUser?.isShared) {
                        try {
                            const { data: newUser, error: createError } = await supabase
                                .from('users')
                                .insert({
                                    discord_id: `shared_${steamId}`, // 為共享帳號使用特殊的 discord_id
                                    username: selectedUser.name,
                                    avatar_url: selectedUser.avatar || null,
                                    steam_id: steamId,
                                    is_shared: true,
                                    game_count: games.length,
                                    total_playtime: games.reduce((total, game) => total + (game.playtime_forever || 0), 0)
                                })
                                .select('id')
                                .single();
                            
                            if (createError) {
                                console.warn('創建共享用戶失敗:', createError.message);
                                return;
                            }
                            user = newUser;
                        } catch (error) {
                            console.warn('創建用戶時發生錯誤:', error.message);
                            return;
                        }
                    } else {
                        // 非共享帳號但不存在，跳過保存
                        console.log(`用戶 ${steamId} 不是共享帳號且不存在於資料庫中，跳過保存`);
                        return;
                    }
                }
