// ğŸ”§ ä¿®å¾©1: OAuthç‹€æ…‹éŒ¯èª¤è™•ç†
document.addEventListener('DOMContentLoaded', async () => {
    // æª¢æŸ¥URLä¸­æ˜¯å¦æœ‰OAuthéŒ¯èª¤åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const oauthError = urlParams.get('error');
    
    if (oauthError === 'invalid_request') {
        // æ¸…ç†éŒ¯èª¤åƒæ•¸ï¼Œé‡æ–°è¼‰å…¥ä¹¾æ·¨çš„é é¢
        console.log('æª¢æ¸¬åˆ°OAuthç‹€æ…‹éŒ¯èª¤ï¼Œæ¸…ç†URL...');
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // ä½†å…ˆå˜—è©¦å¾URL fragmentä¸­æå–access_token
        const fragment = window.location.hash.substring(1);
        const accessTokenMatch = fragment.match(/access_token=([^&]+)/);
        
        if (accessTokenMatch) {
            // å¦‚æœæœ‰access_tokenï¼Œè¡¨ç¤ºèªè­‰å¯¦éš›ä¸Šæ˜¯æˆåŠŸçš„
            console.log('ç™¼ç¾access_tokenï¼Œå˜—è©¦æ¢å¾©session...');
            
            // æ¸…ç†fragment
            window.location.hash = '';
            
            // ç­‰å¾…ä¸€ä¸‹è®“Supabaseè™•ç†
            setTimeout(async () => {
                await checkAuth();
                await loadUsers();
            }, 1000);
        }
    }
    
    // æ­£å¸¸åˆå§‹åŒ–æµç¨‹
    await checkAuth();
    await loadUsers();
    setupEventListeners();
    
    // é è¨­é¸ä¸­å…±äº«å¸³è™Ÿ
    selectedUsers = [...SHARED_ACCOUNTS];
    updateUserInterface();
    await loadGames();
});

// ğŸ”§ ä¿®å¾©2: æ›´æ›ä»£ç†æœå‹™å’ŒéŒ¯èª¤è™•ç†
const CORS_PROXIES = [
    'https://api.allorigins.win/get?url=',
    'https://corsproxy.io/?',
    'https://api.codetabs.com/v1/proxy?quest=',
    // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥å˜—è©¦ç„¡ä»£ç†ï¼ˆæŸäº›æƒ…æ³ä¸‹å¯èƒ½æœ‰æ•ˆï¼‰
    ''
];

let currentProxyIndex = 0;

async function fetchUserGames(steamId, retryCount = 0) {
    const maxRetries = CORS_PROXIES.length;
    
    if (retryCount >= maxRetries) {
        console.error(`æ‰€æœ‰ä»£ç†æœå‹™éƒ½å¤±æ•ˆï¼Œç„¡æ³•ç²å–ç”¨æˆ¶ ${steamId} çš„éŠæˆ²`);
        return [];
    }
    
    try {
        const steamUrl = `http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${STEAM_CONFIG.API_KEY}&steamid=${steamId}&format=json&include_appinfo=true`;
        
        const proxy = CORS_PROXIES[retryCount % CORS_PROXIES.length];
        const finalUrl = proxy ? `${proxy}${encodeURIComponent(steamUrl)}` : steamUrl;
        
        console.log(`å˜—è©¦ä»£ç† ${retryCount + 1}/${maxRetries}: ${proxy || 'ç›´æ¥è«‹æ±‚'}`);
        
        const response = await fetch(finalUrl, {
            method: 'GET',
            headers: proxy ? {} : {
                'Accept': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        let gameData;
        
        if (proxy) {
            // ä»£ç†æœå‹™é€šå¸¸æœƒåŒ…è£éŸ¿æ‡‰
            if (data.contents) {
                gameData = JSON.parse(data.contents);
            } else if (data.response) {
                gameData = data;
            } else {
                throw new Error('ä»£ç†éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤');
            }
        } else {
            // ç›´æ¥è«‹æ±‚
            gameData = data;
        }
        
        return gameData.response?.games || [];
        
    } catch (error) {
        console.error(`ä»£ç† ${retryCount + 1} å¤±æ•—:`, error.message);
        
        // å˜—è©¦ä¸‹ä¸€å€‹ä»£ç†
        return await fetchUserGames(steamId, retryCount + 1);
    }
}

// ğŸ”§ ä¿®å¾©3: æ”¹é€²çš„éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶åé¥‹
async function loadGames() {
    if (selectedUsers.length === 0) {
        allGames = [];
        filteredGames = [];
        updateGamesInterface();
        return;
    }
    
    showLoading(true);
    
    try {
        // é¡¯ç¤ºè©³ç´°è¼‰å…¥é€²åº¦
        showNotification('æ­£åœ¨è¼‰å…¥éŠæˆ²è³‡æ–™...', 'info');
        
        const allUserGames = [];
        const failedUsers = [];
        
        // é€å€‹è¼‰å…¥ç”¨æˆ¶éŠæˆ²ï¼Œæä¾›æ›´å¥½çš„éŒ¯èª¤è™•ç†
        for (let i = 0; i < selectedUsers.length; i++) {
            const user = selectedUsers[i];
            try {
                console.log(`è¼‰å…¥ç”¨æˆ¶ ${user.name} (${i + 1}/${selectedUsers.length}) çš„éŠæˆ²...`);
                const games = await fetchUserGames(user.id);
                allUserGames.push(games);
                
                if (games.length === 0) {
                    console.warn(`ç”¨æˆ¶ ${user.name} æ²’æœ‰éŠæˆ²æˆ–éŠæˆ²åº«ç‚ºç§äºº`);
                }
            } catch (error) {
                console.error(`è¼‰å…¥ç”¨æˆ¶ ${user.name} å¤±æ•—:`, error);
                failedUsers.push(user.name);
                allUserGames.push([]); // æ·»åŠ ç©ºé™£åˆ—ä¿æŒç´¢å¼•ä¸€è‡´
            }
        }
        
        if (failedUsers.length > 0) {
            showNotification(`éƒ¨åˆ†ç”¨æˆ¶è¼‰å…¥å¤±æ•—: ${failedUsers.join(', ')}`, 'warning');
        }
        
        allGames = calculateCommonGames(allUserGames);
        filterGames();
        
        if (allGames.length === 0) {
            showNotification('æ²’æœ‰æ‰¾åˆ°ä»»ä½•éŠæˆ²ï¼Œè«‹æª¢æŸ¥Steamå€‹äººæª”æ¡ˆæ˜¯å¦ç‚ºå…¬é–‹', 'warning');
        } else {
            showNotification(`æˆåŠŸè¼‰å…¥ ${allGames.length} å€‹éŠæˆ²`, 'success');
        }
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²å¤±æ•—:', error);
        showNotification('è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        allGames = [];
        filteredGames = [];
    } finally {
        showLoading(false);
        updateGamesInterface();
    }
}

// ğŸ”§ ä¿®å¾©4: æ”¹é€²çš„é€šçŸ¥ç³»çµ±
function showNotification(message, type = 'info') {
    // ç§»é™¤ç¾æœ‰é€šçŸ¥
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 max-w-sm ${
        type === 'error' ? 'bg-red-600' : 
        type === 'success' ? 'bg-green-600' : 
        type === 'warning' ? 'bg-yellow-600' :
        'bg-blue-600'
    } text-white`;
    
    notification.innerHTML = `
        <div class="flex items-start space-x-2">
            <div class="flex-1 text-sm">${message}</div>
            <button class="text-white/80 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // è‡ªå‹•ç§»é™¤ï¼ˆé™¤éæ˜¯éŒ¯èª¤è¨Šæ¯ï¼‰
    if (type !== 'error') {
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, type === 'warning' ? 5000 : 3000);
    }
}
