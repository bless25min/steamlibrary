// 🔧 修復1: OAuth狀態錯誤處理
document.addEventListener('DOMContentLoaded', async () => {
    // 檢查URL中是否有OAuth錯誤參數
    const urlParams = new URLSearchParams(window.location.search);
    const oauthError = urlParams.get('error');
    
    if (oauthError === 'invalid_request') {
        // 清理錯誤參數，重新載入乾淨的頁面
        console.log('檢測到OAuth狀態錯誤，清理URL...');
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // 但先嘗試從URL fragment中提取access_token
        const fragment = window.location.hash.substring(1);
        const accessTokenMatch = fragment.match(/access_token=([^&]+)/);
        
        if (accessTokenMatch) {
            // 如果有access_token，表示認證實際上是成功的
            console.log('發現access_token，嘗試恢復session...');
            
            // 清理fragment
            window.location.hash = '';
            
            // 等待一下讓Supabase處理
            setTimeout(async () => {
                await checkAuth();
                await loadUsers();
            }, 1000);
        }
    }
    
    // 正常初始化流程
    await checkAuth();
    await loadUsers();
    setupEventListeners();
    
    // 預設選中共享帳號
    selectedUsers = [...SHARED_ACCOUNTS];
    updateUserInterface();
    await loadGames();
});

// 🔧 修復2: 更換代理服務和錯誤處理
const CORS_PROXIES = [
    'https://api.allorigins.win/get?url=',
    'https://corsproxy.io/?',
    'https://api.codetabs.com/v1/proxy?quest=',
    // 備用方案：直接嘗試無代理（某些情況下可能有效）
    ''
];

let currentProxyIndex = 0;

async function fetchUserGames(steamId, retryCount = 0) {
    const maxRetries = CORS_PROXIES.length;
    
    if (retryCount >= maxRetries) {
        console.error(`所有代理服務都失效，無法獲取用戶 ${steamId} 的遊戲`);
        return [];
    }
    
    try {
        const steamUrl = `http://api.steampowered.com/IPlayerService/GetOwnedGames/v0001/?key=${STEAM_CONFIG.API_KEY}&steamid=${steamId}&format=json&include_appinfo=true`;
        
        const proxy = CORS_PROXIES[retryCount % CORS_PROXIES.length];
        const finalUrl = proxy ? `${proxy}${encodeURIComponent(steamUrl)}` : steamUrl;
        
        console.log(`嘗試代理 ${retryCount + 1}/${maxRetries}: ${proxy || '直接請求'}`);
        
        const response = await fetch(finalUrl, {
            method: 'GET',
            headers: proxy ? {} : {
                'Accept': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        let gameData;
        
        if (proxy) {
            // 代理服務通常會包裝響應
            if (data.contents) {
                gameData = JSON.parse(data.contents);
            } else if (data.response) {
                gameData = data;
            } else {
                throw new Error('代理響應格式錯誤');
            }
        } else {
            // 直接請求
            gameData = data;
        }
        
        return gameData.response?.games || [];
        
    } catch (error) {
        console.error(`代理 ${retryCount + 1} 失敗:`, error.message);
        
        // 嘗試下一個代理
        return await fetchUserGames(steamId, retryCount + 1);
    }
}

// 🔧 修復3: 改進的錯誤處理和用戶反饋
async function loadGames() {
    if (selectedUsers.length === 0) {
        allGames = [];
        filteredGames = [];
        updateGamesInterface();
        return;
    }
    
    showLoading(true);
    
    try {
        // 顯示詳細載入進度
        showNotification('正在載入遊戲資料...', 'info');
        
        const allUserGames = [];
        const failedUsers = [];
        
        // 逐個載入用戶遊戲，提供更好的錯誤處理
        for (let i = 0; i < selectedUsers.length; i++) {
            const user = selectedUsers[i];
            try {
                console.log(`載入用戶 ${user.name} (${i + 1}/${selectedUsers.length}) 的遊戲...`);
                const games = await fetchUserGames(user.id);
                allUserGames.push(games);
                
                if (games.length === 0) {
                    console.warn(`用戶 ${user.name} 沒有遊戲或遊戲庫為私人`);
                }
            } catch (error) {
                console.error(`載入用戶 ${user.name} 失敗:`, error);
                failedUsers.push(user.name);
                allUserGames.push([]); // 添加空陣列保持索引一致
            }
        }
        
        if (failedUsers.length > 0) {
            showNotification(`部分用戶載入失敗: ${failedUsers.join(', ')}`, 'warning');
        }
        
        allGames = calculateCommonGames(allUserGames);
        filterGames();
        
        if (allGames.length === 0) {
            showNotification('沒有找到任何遊戲，請檢查Steam個人檔案是否為公開', 'warning');
        } else {
            showNotification(`成功載入 ${allGames.length} 個遊戲`, 'success');
        }
        
    } catch (error) {
        console.error('載入遊戲失敗:', error);
        showNotification('載入遊戲資料失敗，請稍後再試', 'error');
        allGames = [];
        filteredGames = [];
    } finally {
        showLoading(false);
        updateGamesInterface();
    }
}

// 🔧 修復4: 改進的通知系統
function showNotification(message, type = 'info') {
    // 移除現有通知
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 max-w-sm ${
        type === 'error' ? 'bg-red-600' : 
        type === 'success' ? 'bg-green-600' : 
        type === 'warning' ? 'bg-yellow-600' :
        'bg-blue-600'
    } text-white`;
    
    notification.innerHTML = `
        <div class="flex items-start space-x-2">
            <div class="flex-1 text-sm">${message}</div>
            <button class="text-white/80 hover:text-white" onclick="this.parentElement.parentElement.remove()">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // 自動移除（除非是錯誤訊息）
    if (type !== 'error') {
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }, type === 'warning' ? 5000 : 3000);
    }
}
