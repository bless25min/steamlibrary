<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam 共通遊戲發現平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .glass-effect {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .game-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .game-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-avatar {
            transition: all 0.2s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
        }
        
        .filter-tag {
            transition: all 0.2s ease;
        }
        
        .filter-tag.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .notification {
            z-index: 9999;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 min-h-screen text-white">
    <!-- 導航欄 -->
    <nav class="glass-effect border-b border-slate-600/30 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        Steam 共通遊戲發現
                    </h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="hidden items-center space-x-3">
                        <img id="userAvatar" class="w-8 h-8 rounded-full border-2 border-blue-400" alt="用戶頭像">
                        <span id="userName" class="text-sm font-medium"></span>
                    </div>
                    <button id="helpBtn" class="text-slate-400 hover:text-white transition-colors" title="快捷鍵說明">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                    <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Discord 登入
                    </button>
                    <button id="logoutBtn" class="hidden bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        登出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 用戶選擇面板 -->
        <div id="userPanel" class="glass-effect rounded-xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 class="text-lg font-semibold mb-4 sm:mb-0">選擇用戶來比較遊戲庫</h2>
                <div class="flex space-x-2">
                    <button id="selectAllBtn" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm transition-colors">
                        全選
                    </button>
                    <button id="deselectAllBtn" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm transition-colors">
                        取消全選
                    </button>
                </div>
            </div>
            
            <div id="userList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- 用戶卡片會動態載入 -->
            </div>
        </div>

        <!-- 篩選和統計面板 -->
        <div class="glass-effect rounded-xl p-6 mb-8">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 篩選選項 -->
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-slate-300 mb-3">篩選遊戲</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-tag active px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="all">
                            全部遊戲
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="common">
                            共同遊戲
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="majority">
                            多數人擁有 (≥50%)
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="popular">
                            熱門 (≥75%)
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="highPlaytime">
                            高遊戲時間
                        </button>
                    </div>
                </div>
                
                <!-- 排序選項 -->
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-slate-300 mb-3">排序方式</h3>
                    <select id="sortSelect" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm w-full lg:w-auto focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="commonality">按共通度排序</option>
                        <option value="name">按名稱排序 (A-Z)</option>
                        <option value="playtime">按遊戲時間排序</option>
                        <option value="appid">按遊戲ID排序</option>
                    </select>
                </div>
                
                <!-- 搜尋框 -->
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-slate-300 mb-3">搜尋遊戲</h3>
                    <div class="relative">
                        <input id="searchInput" type="text" placeholder="輸入遊戲名稱..." 
                               class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 pr-10 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <button id="clearSearch" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white transition-colors hidden">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 統計資訊 -->
            <div id="statsPanel" class="mt-6 pt-6 border-t border-slate-600/30">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                    <div class="text-center">
                        <div id="totalGames" class="text-2xl font-bold text-blue-400">0</div>
                        <div class="text-sm text-slate-400">總遊戲數</div>
                    </div>
                    <div class="text-center">
                        <div id="commonGames" class="text-2xl font-bold text-green-400">0</div>
                        <div class="text-sm text-slate-400">共同遊戲</div>
                    </div>
                    <div class="text-center">
                        <div id="selectedUsers" class="text-2xl font-bold text-purple-400">0</div>
                        <div class="text-sm text-slate-400">已選用戶</div>
                    </div>
                    <div class="text-center">
                        <div id="showingGames" class="text-2xl font-bold text-yellow-400">0</div>
                        <div class="text-sm text-slate-400">顯示遊戲</div>
                    </div>
                </div>
                
                <!-- 快速操作面板 -->
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="quickCommonBtn" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full text-sm transition-colors">
                        只看共同遊戲
                    </button>
                    <button id="quickPopularBtn" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded-full text-sm transition-colors">
                        只看熱門遊戲
                    </button>
                    <button id="quickResetBtn" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded-full text-sm transition-colors">
                        重置篩選
                    </button>
                    <button id="clearCacheBtn" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded-full text-sm transition-colors">
                        清除緩存
                    </button>
                    <button id="reloadBtn" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded-full text-sm transition-colors">
                        重新載入
                    </button>
                    <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-full text-sm transition-colors">
                        導出清單
                    </button>
                </div>
            </div>
        </div>

        <!-- 載入狀態 -->
        <div id="loadingState" class="hidden">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
            </div>
        </div>

        <!-- 遊戲網格 -->
        <div id="gamesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            <!-- 遊戲卡片會動態載入 -->
        </div>

        <!-- 空狀態 -->
        <div id="emptyState" class="hidden text-center py-16">
            <div class="w-16 h-16 mx-auto mb-4 bg-slate-700 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-slate-300 mb-2">沒有找到符合條件的遊戲</h3>
            <p class="text-slate-400">嘗試調整篩選條件或選擇更多用戶</p>
        </div>
    </div>

    <script>
        // 應用程式設置類
        class AppConfig {
            constructor() {
                this.SUPABASE_CONFIG = {
                    url: 'https://lwbrqtevzhfkwbwbcdtz.supabase.co',
                    anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3YnJxdGV2emhma3did2JjZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NjcxMjYsImV4cCI6MjA2NzA0MzEyNn0.4s16bos5EEhSuUg-K1Paf8B5UXyo-Ca8reTFZ03VVT8'
                };
                
                this.STEAM_CONFIG = {
                    STORE_BASE: 'https://store.steampowered.com/app',
                    IMAGE_BASE: 'https://media.steampowered.com/steamcommunity/public/images/apps'
                };

                // 共享帳號
                this.SHARED_ACCOUNTS = [
                    { id: '76561199470483407', name: '共享帳號 #1', isShared: true, gameCount: 0 },
                    { id: '76561199509330900', name: '共享帳號 #2', isShared: true, gameCount: 0 },
                    { id: '76561199509470809', name: '共享帳號 #3', isShared: true, gameCount: 0 },
                    { id: '76561199509470810', name: '共享帳號 #4', isShared: true, gameCount: 0 }
                ];

                // CORS代理服務
                this.CORS_PROXIES = [
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest=',
                    'https://cors-anywhere.herokuapp.com/',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
            }
        }

        // 錯誤處理類
        class ErrorHandler {
            constructor() {
                this.setupGlobalErrorHandlers();
            }

            setupGlobalErrorHandlers() {
                window.addEventListener('error', this.handleGlobalError.bind(this));
                window.addEventListener('unhandledrejection', this.handleUnhandledRejection.bind(this));
            }

            handleGlobalError(event) {
                console.error('全局錯誤:', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    error: event.error,
                    stack: event.error?.stack
                });
                
                // 阻止錯誤傳播
                event.preventDefault();
                
                // 記錄錯誤但不影響用戶體驗
                this.logError({
                    type: 'global_error',
                    message: event.message,
                    stack: event.error?.stack
                });
            }

            handleUnhandledRejection(event) {
                console.error('未處理的Promise錯誤:', {
                    reason: event.reason,
                    promise: event.promise
                });
                
                event.preventDefault();
                
                this.logError({
                    type: 'unhandled_rejection',
                    reason: event.reason
                });
            }

            logError(error) {
                // 將錯誤存儲到本地存儲，方便診斷
                try {
                    const errors = JSON.parse(localStorage.getItem('app_errors') || '[]');
                    errors.push({
                        ...error,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    });
                    // 只保留最近100個錯誤
                    if (errors.length > 100) {
                        errors.splice(0, errors.length - 100);
                    }
                    localStorage.setItem('app_errors', JSON.stringify(errors));
                } catch (e) {
                    console.warn('無法記錄錯誤:', e);
                }
            }
        }

        // 狀態管理類
        class StateManager {
            constructor() {
                this.state = {
                    currentUser: null,
                    allUsers: [],
                    selectedUsers: [],
                    allGames: [],
                    filteredGames: [],
                    currentFilter: 'all',
                    currentSort: 'commonality',
                    isLoadingGames: false,
                    isUpdatingInterface: false,
                    authStateInitialized: false
                };
                
                this.gameDataCache = new Map();
                this.loadGameTimeout = null;
                this.apiRequestQueue = [];
                this.isProcessingQueue = false;
            }

            get(key) {
                return this.state[key];
            }

            set(key, value) {
                const oldValue = this.state[key];
                this.state[key] = value;
                
                // 觸發狀態變化事件
                window.dispatchEvent(new CustomEvent('statechange', {
                    detail: { key, oldValue, newValue: value }
                }));
            }

            update(updates) {
                Object.entries(updates).forEach(([key, value]) => {
                    this.set(key, value);
                });
            }
        }

        // DOM工具類
        class DOMUtils {
            static createElement(tag, attributes = {}, children = []) {
                const element = document.createElement(tag);
                
                Object.entries(attributes).forEach(([key, value]) => {
                    if (key === 'className') {
                        element.className = value;
                    } else if (key === 'innerHTML') {
                        element.innerHTML = value;
                    } else if (key === 'textContent') {
                        element.textContent = value;
                    } else if (key.startsWith('on')) {
                        element.addEventListener(key.substring(2).toLowerCase(), value);
                    } else {
                        element.setAttribute(key, value);
                    }
                });
                
                children.forEach(child => {
                    if (typeof child === 'string') {
                        element.appendChild(document.createTextNode(child));
                    } else if (child instanceof Node) {
                        element.appendChild(child);
                    }
                });
                
                return element;
            }

            static escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') return unsafe;
                
                const div = document.createElement('div');
                div.textContent = unsafe;
                return div.innerHTML;
            }

            static sanitizeGameName(name) {
                if (!name || typeof name !== 'string') return 'Unknown Game';
                
                // 移除可能導致問題的字符
                return name
                    .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // 控制字符
                    .replace(/[<>]/g, '') // HTML標籤字符
                    .trim() || 'Unknown Game';
            }
        }

        // 通知系統類
        class NotificationSystem {
            constructor() {
                this.container = null;
                this.queue = [];
                this.currentNotification = null;
            }

            show(message, type = 'info', duration = 3000) {
                // 移除現有通知
                if (this.currentNotification) {
                    this.currentNotification.remove();
                }
                
                const notification = DOMUtils.createElement('div', {
                    className: `notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 max-w-sm ${
                        type === 'error' ? 'bg-red-600' : 
                        type === 'success' ? 'bg-green-600' : 
                        type === 'warning' ? 'bg-yellow-600' :
                        'bg-blue-600'
                    } text-white`
                });
                
                const contentDiv = DOMUtils.createElement('div', {
                    className: 'flex items-start space-x-2'
                });
                
                const messageDiv = DOMUtils.createElement('div', {
                    className: 'flex-1 text-sm',
                    textContent: message
                });
                
                const closeButton = DOMUtils.createElement('button', {
                    className: 'text-white/80 hover:text-white',
                    innerHTML: `
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                        </svg>
                    `,
                    onClick: () => this.dismiss(notification)
                });
                
                contentDiv.appendChild(messageDiv);
                contentDiv.appendChild(closeButton);
                notification.appendChild(contentDiv);
                
                document.body.appendChild(notification);
                this.currentNotification = notification;
                
                // 自動關閉
                if (type !== 'error' && duration > 0) {
                    setTimeout(() => this.dismiss(notification), duration);
                }
                
                return notification;
            }

            dismiss(notification) {
                if (!notification || !notification.parentElement) return;
                
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                        if (this.currentNotification === notification) {
                            this.currentNotification = null;
                        }
                    }
                }, 300);
            }
        }

        // Steam API客戶端類
        class SteamAPIClient {
            constructor(config, proxies) {
                this.config = config;
                this.proxies = proxies;
                this.rateLimiter = new RateLimiter(10, 60000); // 每分鐘10個請求
            }

            async fetchUserGames(steamId) {
                // 先檢查速率限制
                await this.rateLimiter.checkLimit();
                
                // 使用模擬數據以避免API密鑰問題
                console.log(`使用模擬數據為用戶 ${steamId}`);
                return this.getFallbackGames(steamId);
            }

            sanitizeGameData(games) {
                return games.filter(game => {
                    return game && 
                           game.appid && 
                           game.name && 
                           typeof game.name === 'string' &&
                           game.name.trim().length > 0;
                }).map(game => ({
                    ...game,
                    name: DOMUtils.sanitizeGameName(game.name),
                    playtime_forever: parseInt(game.playtime_forever) || 0,
                    img_icon_url: game.img_icon_url || ''
                }));
            }

            getFallbackGames(steamId) {
                const gameLibraries = {
                    '76561199470483407': [
                        { appid: 570, name: 'Dota 2', playtime_forever: 1500, img_icon_url: '0ca33fe2b8888b2b64bcad6e65b72b9ed4c299fd' },
                        { appid: 730, name: 'Counter-Strike Global Offensive', playtime_forever: 2000, img_icon_url: '69f7ebe2735c366c65c0b33dae00e12dc40edbe4' },
                        { appid: 440, name: 'Team Fortress 2', playtime_forever: 500, img_icon_url: 'e3f595a92552da3d664ad00277fad2107345f743' },
                        { appid: 271590, name: 'Grand Theft Auto V', playtime_forever: 1200, img_icon_url: '8074a7fb76ab3a8e4fc5bbba1e8e8c5b.jpg' },
                        { appid: 252490, name: 'Rust', playtime_forever: 800, img_icon_url: '1f4027c4cb96b3ecc17ff62f6c9d11a6.jpg' }
                    ],
                    '76561199509330900': [
                        { appid: 570, name: 'Dota 2', playtime_forever: 1200, img_icon_url: '0ca33fe2b8888b2b64bcad6e65b72b9ed4c299fd' },
                        { appid: 730, name: 'Counter-Strike Global Offensive', playtime_forever: 1800, img_icon_url: '69f7ebe2735c366c65c0b33dae00e12dc40edbe4' },
                        { appid: 271590, name: 'Grand Theft Auto V', playtime_forever: 800, img_icon_url: '8074a7fb76ab3a8e4fc5bbba1e8e8c5b.jpg' },
                        { appid: 431960, name: 'Wallpaper Engine', playtime_forever: 100, img_icon_url: '6bed6e3b2bc1b3bb8e5b6aabb1bb688bad7d8c6f' },
                        { appid: 292030, name: 'The Witcher 3 Wild Hunt', playtime_forever: 400, img_icon_url: '8076a70c1c740b92e45e6e17be8a0855.jpg' }
                    ],
                    '76561199509470809': [
                        { appid: 570, name: 'Dota 2', playtime_forever: 900, img_icon_url: '0ca33fe2b8888b2b64bcad6e65b72b9ed4c299fd' },
                        { appid: 440, name: 'Team Fortress 2', playtime_forever: 300, img_icon_url: 'e3f595a92552da3d664ad00277fad2107345f743' },
                        { appid: 271590, name: 'Grand Theft Auto V', playtime_forever: 600, img_icon_url: '8074a7fb76ab3a8e4fc5bbba1e8e8c5b.jpg' },
                        { appid: 431960, name: 'Wallpaper Engine', playtime_forever: 80, img_icon_url: '6bed6e3b2bc1b3bb8e5b6aabb1bb688bad7d8c6f' },
                        { appid: 252490, name: 'Rust', playtime_forever: 1200, img_icon_url: '1f4027c4cb96b3ecc17ff62f6c9d11a6.jpg' }
                    ],
                    '76561199509470810': [
                        { appid: 730, name: 'Counter-Strike Global Offensive', playtime_forever: 1500, img_icon_url: '69f7ebe2735c366c65c0b33dae00e12dc40edbe4' },
                        { appid: 440, name: 'Team Fortress 2', playtime_forever: 400, img_icon_url: 'e3f595a92552da3d664ad00277fad2107345f743' },
                        { appid: 252490, name: 'Rust', playtime_forever: 1000, img_icon_url: '1f4027c4cb96b3ecc17ff62f6c9d11a6.jpg' },
                        { appid: 578080, name: 'PUBG BATTLEGROUNDS', playtime_forever: 500, img_icon_url: '3fcaedfae024e95f23ce7c3ef0b9959cbb7d1b73' },
                        { appid: 292030, name: 'The Witcher 3 Wild Hunt', playtime_forever: 600, img_icon_url: '8076a70c1c740b92e45e6e17be8a0855.jpg' },
                        { appid: 431960, name: 'Wallpaper Engine', playtime_forever: 50, img_icon_url: '6bed6e3b2bc1b3bb8e5b6aabb1bb688bad7d8c6f' }
                    ]
                };
                
                // 如果沒有找到對應的模擬數據，返回一些隨機遊戲
                if (!gameLibraries[steamId]) {
                    return [
                        { appid: 730, name: 'Counter-Strike Global Offensive', playtime_forever: 100, img_icon_url: '69f7ebe2735c366c65c0b33dae00e12dc40edbe4' },
                        { appid: 570, name: 'Dota 2', playtime_forever: 50, img_icon_url: '0ca33fe2b8888b2b64bcad6e65b72b9ed4c299fd' }
                    ];
                }
                
                return this.sanitizeGameData(gameLibraries[steamId]);
            }
        }

        // 速率限制器
        class RateLimiter {
            constructor(maxRequests, timeWindow) {
                this.maxRequests = maxRequests;
                this.timeWindow = timeWindow;
                this.requests = [];
            }

            async checkLimit() {
                const now = Date.now();
                this.requests = this.requests.filter(time => now - time < this.timeWindow);
                
                if (this.requests.length >= this.maxRequests) {
                    const oldestRequest = this.requests[0];
                    const waitTime = this.timeWindow - (now - oldestRequest);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                
                this.requests.push(now);
            }
        }

        // 數據庫管理類
        class DatabaseManager {
            constructor(supabase) {
                this.supabase = supabase;
                this.batchQueue = [];
                this.batchTimer = null;
            }

            async loadUserGamesFromDB(steamId) {
                try {
                    if (!this.supabase) return null;
                    
                    // 首先找到用戶
                    const { data: user, error: userError } = await this.supabase
                        .from('users')
                        .select('id, game_count')
                        .eq('steam_id', steamId)
                        .single();
                    
                    if (userError || !user) {
                        console.log(`用戶 ${steamId} 在資料庫中不存在`);
                        return null;
                    }
                    
                    // 如果用戶沒有遊戲記錄，直接返回
                    if (!user.game_count || user.game_count === 0) {
                        console.log(`用戶 ${steamId} 沒有遊戲記錄`);
                        return null;
                    }
                    
                    // 查詢用戶遊戲關聯和遊戲詳情
                    const { data: userGames, error } = await this.supabase
                        .from('user_games')
                        .select(`
                            playtime_forever,
                            games!inner (
                                steam_app_id,
                                name,
                                header_image
                            )
                        `)
                        .eq('user_id', user.id)
                        .limit(1000);
                    
                    if (error) {
                        console.error('從資料庫載入遊戲失敗:', error);
                        return null;
                    }
                    
                    if (!userGames || userGames.length === 0) {
                        console.log(`用戶 ${steamId} 在資料庫中沒有遊戲數據`);
                        return null;
                    }
                    
                    // 轉換資料庫格式為Steam API格式
                    const games = userGames
                        .filter(ug => ug.games && ug.games.steam_app_id)
                        .map(ug => ({
                            appid: ug.games.steam_app_id,
                            name: ug.games.name || `Game ${ug.games.steam_app_id}`,
                            playtime_forever: ug.playtime_forever || 0,
                            img_icon_url: ug.games.header_image || ''
                        }));
                    
                    console.log(`從資料庫載入用戶 ${steamId} 的 ${games.length} 個遊戲`);
                    return games;
                    
                } catch (error) {
                    console.error('資料庫查詢錯誤:', error);
                    return null;
                }
            }

            async saveUserGamesToDB(steamId, games) {
                try {
                    if (!this.supabase || !games || games.length === 0) return;
                    
                    console.log(`嘗試保存用戶 ${steamId} 的 ${games.length} 個遊戲到資料庫`);
                    
                    // 首先檢查用戶是否存在
                    const { data: user, error: userError } = await this.supabase
                        .from('users')
                        .select('id')
                        .eq('steam_id', steamId)
                        .single();
                    
                    if (userError || !user) {
                        console.warn(`無法找到用戶 ${steamId}，跳過資料庫保存`);
                        return;
                    }
                    
                    // 批量準備遊戲數據
                    const gamesToInsert = games.map(game => ({
                        steam_app_id: game.appid,
                        name: game.name,
                        header_image: `https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/header.jpg`
                    }));
                    
                    // 批量插入或更新遊戲（忽略衝突）
                    const { data: insertedGames, error: gamesError } = await this.supabase
                        .from('games')
                        .upsert(gamesToInsert, { 
                            onConflict: 'steam_app_id',
                            ignoreDuplicates: false 
                        })
                        .select('id, steam_app_id');
                    
                    if (gamesError) {
                        console.error('插入遊戲失敗:', gamesError);
                        return;
                    }
                    
                    if (!insertedGames || insertedGames.length === 0) {
                        // 如果插入失敗，嘗試查詢現有遊戲
                        const appIds = games.map(g => g.appid);
                        const { data: existingGames, error: queryError } = await this.supabase
                            .from('games')
                            .select('id, steam_app_id')
                            .in('steam_app_id', appIds);
                        
                        if (queryError || !existingGames) {
                            console.error('查詢現有遊戲失敗:', queryError);
                            return;
                        }
                        
                        // 創建 appid 到 game_id 的映射
                        const gameIdMap = new Map();
                        existingGames.forEach(g => {
                            gameIdMap.set(g.steam_app_id, g.id);
                        });
                        
                        // 準備用戶遊戲關聯數據
                        const userGamesToInsert = games
                            .filter(game => gameIdMap.has(game.appid))
                            .map(game => ({
                                user_id: user.id,
                                game_id: gameIdMap.get(game.appid),
                                playtime_forever: game.playtime_forever || 0
                            }));
                        
                        if (userGamesToInsert.length > 0) {
                            // 先刪除舊的關聯
                            await this.supabase
                                .from('user_games')
                                .delete()
                                .eq('user_id', user.id);
                            
                            // 批量插入新的關聯
                            const { error: insertError } = await this.supabase
                                .from('user_games')
                                .insert(userGamesToInsert);
                            
                            if (insertError) {
                                console.error('插入用戶遊戲關聯失敗:', insertError);
                            } else {
                                console.log(`成功保存 ${userGamesToInsert.length} 個遊戲關聯`);
                                
                                // 更新用戶統計
                                await this.supabase
                                    .from('users')
                                    .update({ 
                                        game_count: games.length,
                                        total_playtime: games.reduce((total, game) => total + (game.playtime_forever || 0), 0)
                                    })
                                    .eq('id', user.id);
                            }
                        }
                    } else {
                        // 如果插入成功，使用返回的數據創建關聯
                        const gameIdMap = new Map();
                        insertedGames.forEach(g => {
                            gameIdMap.set(g.steam_app_id, g.id);
                        });
                        
                        // 準備用戶遊戲關聯數據
                        const userGamesToInsert = games
                            .filter(game => gameIdMap.has(game.appid))
                            .map(game => ({
                                user_id: user.id,
                                game_id: gameIdMap.get(game.appid),
                                playtime_forever: game.playtime_forever || 0
                            }));
                        
                        if (userGamesToInsert.length > 0) {
                            // 先刪除舊的關聯
                            await this.supabase
                                .from('user_games')
                                .delete()
                                .eq('user_id', user.id);
                            
                            // 批量插入新的關聯
                            const { error: insertError } = await this.supabase
                                .from('user_games')
                                .insert(userGamesToInsert);
                            
                            if (insertError) {
                                console.error('插入用戶遊戲關聯失敗:', insertError);
                            } else {
                                console.log(`成功保存 ${userGamesToInsert.length} 個遊戲關聯`);
                                
                                // 更新用戶統計
                                await this.supabase
                                    .from('users')
                                    .update({ 
                                        game_count: games.length,
                                        total_playtime: games.reduce((total, game) => total + (game.playtime_forever || 0), 0)
                                    })
                                    .eq('id', user.id);
                            }
                        }
                    }
                    
                } catch (error) {
                    console.warn('保存遊戲數據時發生錯誤，將僅使用緩存:', error.message);
                }
            }
        }

        // 主應用程式類
        class SteamGameDiscoveryApp {
            constructor() {
                this.config = new AppConfig();
                this.errorHandler = new ErrorHandler();
                this.state = new StateManager();
                this.notifications = new NotificationSystem();
                this.elements = {};
                this.supabase = null;
                this.steamClient = null;
                this.dbManager = null;
                this.eventListeners = new Map();
            }

            async init() {
                console.log('開始初始化應用程式...');
                
                try {
                    this.initializeElements();
                    await this.initializeSupabase();
                    this.setupEventListeners();
                    this.cleanupOAuthErrors();
                    await this.startInitialLoad();
                    console.log('應用程式初始化完成');
                } catch (error) {
                    console.error('初始化失敗:', error);
                    this.notifications.show('應用程式初始化失敗', 'error');
                }
            }

            initializeElements() {
                const elementIds = [
                    'loginBtn', 'logoutBtn', 'userInfo', 'userAvatar', 'userName',
                    'userList', 'gamesGrid', 'loadingState', 'emptyState',
                    'searchInput', 'sortSelect', 'selectAllBtn', 'deselectAllBtn',
                    'totalGames', 'commonGames', 'selectedUsers', 'showingGames'
                ];

                this.elements = {};
                elementIds.forEach(id => {
                    this.elements[id] = document.getElementById(id);
                    if (!this.elements[id]) {
                        console.warn(`找不到元素: ${id}`);
                    }
                });
            }

            async initializeSupabase() {
                try {
                    if (window.supabase && window.supabase.createClient) {
                        this.supabase = window.supabase.createClient(
                            this.config.SUPABASE_CONFIG.url, 
                            this.config.SUPABASE_CONFIG.anonKey
                        );
                        this.dbManager = new DatabaseManager(this.supabase);
                        this.steamClient = new SteamAPIClient(
                            this.config.STEAM_CONFIG,
                            this.config.CORS_PROXIES
                        );
                        console.log('Supabase 初始化成功');
                    } else {
                        console.error('Supabase 庫未載入');
                    }
                } catch (error) {
                    console.error('Supabase 初始化失敗:', error);
                }
            }

            cleanupOAuthErrors() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('error') === 'invalid_request') {
                    console.log('清理OAuth錯誤參數');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            async startInitialLoad() {
                try {
                    await this.checkAuth();
                    await this.loadUsers();
                    this.state.set('selectedUsers', [...this.config.SHARED_ACCOUNTS]);
                    this.updateUserInterface();
                    await this.loadGames();
                } catch (error) {
                    console.error('初始載入失敗:', error);
                    this.notifications.show('載入失敗，請重新整理頁面', 'error');
                }
            }

            setupEventListeners() {
                try {
                    // 基本按鈕事件
                    this.addEventListenerSafe(this.elements.loginBtn, 'click', () => this.handleLogin());
                    this.addEventListenerSafe(this.elements.logoutBtn, 'click', () => this.handleLogout());
                    this.addEventListenerSafe(this.elements.selectAllBtn, 'click', () => this.selectAllUsers());
                    this.addEventListenerSafe(this.elements.deselectAllBtn, 'click', () => this.deselectAllUsers());

                    // 幫助按鈕
                    this.addEventListenerSafe(document.getElementById('helpBtn'), 'click', () => this.showHelpModal());

                    // 搜尋和排序
                    this.addEventListenerSafe(this.elements.searchInput, 'input', this.debounce(() => this.handleSearchInput(), 300));
                    this.addEventListenerSafe(this.elements.sortSelect, 'change', (e) => {
                        this.state.set('currentSort', e.target.value);
                        this.sortGames();
                    });

                    // 清除搜尋
                    this.addEventListenerSafe(document.getElementById('clearSearch'), 'click', () => this.clearSearch());

                    // 快速操作按鈕
                    this.addEventListenerSafe(document.getElementById('quickCommonBtn'), 'click', () => this.setQuickFilter('common'));
                    this.addEventListenerSafe(document.getElementById('quickPopularBtn'), 'click', () => this.setQuickFilter('popular'));
                    this.addEventListenerSafe(document.getElementById('quickResetBtn'), 'click', () => this.resetAllFilters());
                    this.addEventListenerSafe(document.getElementById('clearCacheBtn'), 'click', () => this.clearGameDataCache());
                    this.addEventListenerSafe(document.getElementById('reloadBtn'), 'click', () => this.reloadGameData(true));
                    this.addEventListenerSafe(document.getElementById('exportBtn'), 'click', () => this.exportGameList());

                    // 篩選按鈕
                    document.querySelectorAll('.filter-tag').forEach(btn => {
                        this.addEventListenerSafe(btn, 'click', (e) => {
                            document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            this.state.set('currentFilter', e.target.dataset.filter);
                            this.filterGames();
                        });
                    });

                    // 鍵盤快捷鍵
                    this.addEventListenerSafe(document, 'keydown', (e) => this.handleKeyboardShortcuts(e));

                    // Supabase 認證狀態監聽
                    if (this.supabase) {
                        let authChangeHandler = null;
                        const { data: { subscription } } = this.supabase.auth.onAuthStateChange((event, session) => {
                            console.log('認證狀態變化:', event);
                            
                            if (event === 'INITIAL_SESSION' && this.state.get('authStateInitialized')) {
                                return;
                            }
                            
                            if (event === 'SIGNED_IN') {
                                if (!this.state.get('authStateInitialized') || !this.state.get('currentUser')) {
                                    this.state.set('currentUser', session.user);
                                    this.updateAuthInterface(true);
                                    this.loadUsers();
                                    this.notifications.show('登入成功！', 'success');
                                    this.state.set('authStateInitialized', true);
                                }
                            } else if (event === 'SIGNED_OUT') {
                                this.state.set('currentUser', null);
                                this.state.set('authStateInitialized', false);
                                this.updateAuthInterface(false);
                                this.state.set('selectedUsers', [...this.config.SHARED_ACCOUNTS]);
                                this.state.gameDataCache.clear();
                                this.loadUsers();
                            } else if (event === 'INITIAL_SESSION') {
                                this.state.set('authStateInitialized', true);
                            }
                        });
                        
                        // 保存訂閱以便清理
                        authChangeHandler = subscription;
                        
                        // 清理函數
                        window.addEventListener('beforeunload', () => {
                            if (authChangeHandler) {
                                authChangeHandler.unsubscribe();
                            }
                        });
                    }

                    console.log('事件監聽器設置完成');
                } catch (error) {
                    console.error('設置事件監聽器失敗:', error);
                }
            }

            addEventListenerSafe(element, event, handler) {
                if (!element) return;
                
                // 移除舊的監聽器
                if (this.eventListeners.has(element)) {
                    const handlers = this.eventListeners.get(element);
                    if (handlers[event]) {
                        element.removeEventListener(event, handlers[event]);
                    }
                } else {
                    this.eventListeners.set(element, {});
                }
                
                // 添加新的監聽器
                element.addEventListener(event, handler);
                this.eventListeners.get(element)[event] = handler;
            }

            async checkAuth() {
                try {
                    if (!this.supabase) return;
                    
                    const { data: { session } } = await this.supabase.auth.getSession();
                    if (session) {
                        this.state.set('currentUser', session.user);
                        this.updateAuthInterface(true);
                        console.log('用戶已登入:', session.user.user_metadata?.full_name);
                    }
                } catch (error) {
                    console.error('檢查認證狀態失敗:', error);
                }
            }

            async handleLogin() {
                try {
                    if (!this.supabase) {
                        this.notifications.show('認證服務未準備就緒', 'error');
                        return;
                    }

                    const { error } = await this.supabase.auth.signInWithOAuth({
                        provider: 'discord',
                        options: {
                            redirectTo: window.location.href
                        }
                    });

                    if (error) {
                        console.error('登入錯誤:', error);
                        this.notifications.show('登入失敗，請稍後再試', 'error');
                    }
                } catch (error) {
                    console.error('登入處理失敗:', error);
                    this.notifications.show('登入失敗', 'error');
                }
            }

            async handleLogout() {
                try {
                    if (!this.supabase) return;

                    const { error } = await this.supabase.auth.signOut();
                    if (error) {
                        console.error('登出錯誤:', error);
                    } else {
                        this.notifications.show('已成功登出', 'success');
                    }
                } catch (error) {
                    console.error('登出處理失敗:', error);
                }
            }

            updateAuthInterface(isLoggedIn) {
                try {
                    const currentUser = this.state.get('currentUser');
                    
                    if (isLoggedIn && currentUser) {
                        if (this.elements.loginBtn) this.elements.loginBtn.classList.add('hidden');
                        if (this.elements.logoutBtn) this.elements.logoutBtn.classList.remove('hidden');
                        if (this.elements.userInfo) {
                            this.elements.userInfo.classList.remove('hidden');
                            this.elements.userInfo.classList.add('flex');
                        }
                        if (this.elements.userAvatar) {
                            this.elements.userAvatar.src = currentUser.user_metadata?.avatar_url || 'https://ui-avatars.com/api/?name=User';
                        }
                        if (this.elements.userName) {
                            this.elements.userName.textContent = currentUser.user_metadata?.full_name || currentUser.email || 'User';
                        }
                    } else {
                        if (this.elements.loginBtn) this.elements.loginBtn.classList.remove('hidden');
                        if (this.elements.logoutBtn) this.elements.logoutBtn.classList.add('hidden');
                        if (this.elements.userInfo) {
                            this.elements.userInfo.classList.add('hidden');
                            this.elements.userInfo.classList.remove('flex');
                        }
                    }
                } catch (error) {
                    console.error('更新認證界面失敗:', error);
                }
            }

            async loadUsers() {
                try {
                    const allUsers = [...this.config.SHARED_ACCOUNTS];
                    const currentUser = this.state.get('currentUser');
                    
                    if (currentUser && this.supabase) {
                        const { data: users, error } = await this.supabase
                            .from('users')
                            .select('*')
                            .neq('is_shared', true);
                        
                        if (error) {
                            console.error('載入用戶資料錯誤:', error);
                        } else if (users) {
                            const mappedUsers = users.map(user => ({
                                id: user.steam_id,
                                name: user.username,
                                avatar: user.avatar_url,
                                gameCount: user.game_count || 0,
                                isShared: false
                            }));
                            allUsers.push(...mappedUsers);
                        }
                    }
                    
                    this.state.set('allUsers', allUsers);
                    this.updateUserInterface();
                    console.log('用戶載入完成，總用戶數:', allUsers.length);
                } catch (error) {
                    console.error('載入用戶失敗:', error);
                    this.notifications.show('載入用戶資料失敗', 'error');
                }
            }

            updateUserInterface() {
                try {
                    if (!this.elements.userList) return;
                    
                    // 清空現有內容
                    this.elements.userList.innerHTML = '';
                    
                    const allUsers = this.state.get('allUsers');
                    const selectedUsers = this.state.get('selectedUsers');
                    
                    allUsers.forEach(user => {
                        const userCard = this.createUserCard(user, selectedUsers);
                        this.elements.userList.appendChild(userCard);
                    });
                    
                    this.updateStats();
                } catch (error) {
                    console.error('更新用戶界面失敗:', error);
                }
            }

            createUserCard(user, selectedUsers) {
                const isSelected = selectedUsers.some(u => u.id === user.id);
                
                const card = DOMUtils.createElement('div', {
                    className: `user-card p-4 rounded-lg border-2 cursor-pointer transition-all ${
                        isSelected 
                            ? 'bg-blue-600/20 border-blue-400' 
                            : 'bg-slate-700/50 border-slate-600 hover:border-slate-500'
                    }`,
                    onClick: () => this.toggleUser(user)
                });
                
                const avatarUrl = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=475569&color=ffffff`;
                
                const contentDiv = DOMUtils.createElement('div', {
                    className: 'flex flex-col items-center space-y-2'
                });
                
                // 頭像區域
                const avatarDiv = DOMUtils.createElement('div', {
                    className: 'relative'
                });
                
                const avatarImg = DOMUtils.createElement('img', {
                    src: avatarUrl,
                    alt: user.name,
                    className: `user-avatar w-12 h-12 rounded-full border-2 ${isSelected ? 'border-blue-400' : 'border-slate-500'}`,
                    onerror: function() {
                        this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=475569&color=ffffff`;
                    }
                });
                avatarDiv.appendChild(avatarImg);
                
                // 選中指示器
                if (isSelected) {
                    const checkIcon = DOMUtils.createElement('div', {
                        className: 'absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center',
                        innerHTML: `
                            <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                            </svg>
                        `
                    });
                    avatarDiv.appendChild(checkIcon);
                }
                
                contentDiv.appendChild(avatarDiv);
                
                // 用戶資訊區域
                const infoDiv = DOMUtils.createElement('div', {
                    className: 'text-center'
                });
                
                const nameDiv = DOMUtils.createElement('div', {
                    className: 'text-sm font-medium truncate max-w-20',
                    title: user.name,
                    textContent: user.name
                });
                infoDiv.appendChild(nameDiv);
                
                if (user.gameCount > 0) {
                    const gameCountDiv = DOMUtils.createElement('div', {
                        className: 'text-xs text-slate-400',
                        textContent: `${user.gameCount} 遊戲`
                    });
                    infoDiv.appendChild(gameCountDiv);
                }
                
                if (user.isShared) {
                    const sharedDiv = DOMUtils.createElement('div', {
                        className: 'text-xs text-blue-400',
                        textContent: '共享'
                    });
                    infoDiv.appendChild(sharedDiv);
                }
                
                contentDiv.appendChild(infoDiv);
                card.appendChild(contentDiv);
                
                return card;
            }

            toggleUser(user) {
                const selectedUsers = [...this.state.get('selectedUsers')];
                const index = selectedUsers.findIndex(u => u.id === user.id);
                
                if (index === -1) {
                    selectedUsers.push(user);
                } else {
                    selectedUsers.splice(index, 1);
                }
                
                this.state.set('selectedUsers', selectedUsers);
                this.updateUserInterface();
                
                // 清除現有的載入狀態
                this.state.set('isLoadingGames', false);
                
                // 使用防抖避免頻繁載入
                clearTimeout(this.state.loadGameTimeout);
                this.state.loadGameTimeout = setTimeout(() => {
                    if (!this.state.get('isLoadingGames')) {
                        this.loadGames();
                    }
                }, 500);
            }

            selectAllUsers() {
                const allUsers = this.state.get('allUsers');
                const selectedUsers = this.state.get('selectedUsers');
                
                if (selectedUsers.length === allUsers.length) {
                    console.log('所有用戶已選中，跳過重複操作');
                    return;
                }
                
                this.state.set('selectedUsers', [...allUsers]);
                this.updateUserInterface();
                
                this.state.set('isLoadingGames', false);
                clearTimeout(this.state.loadGameTimeout);
                this.state.loadGameTimeout = setTimeout(() => {
                    if (!this.state.get('isLoadingGames')) {
                        this.loadGames();
                    }
                }, 500);
            }

            deselectAllUsers() {
                const selectedUsers = this.state.get('selectedUsers');
                
                if (selectedUsers.length === 0) {
                    console.log('沒有已選用戶，跳過重複操作');
                    return;
                }
                
                this.state.set('selectedUsers', []);
                this.updateUserInterface();
                
                this.state.set('isLoadingGames', false);
                clearTimeout(this.state.loadGameTimeout);
                this.state.loadGameTimeout = setTimeout(() => {
                    if (!this.state.get('isLoadingGames')) {
                        this.loadGames();
                    }
                }, 500);
            }

            clearGameDataCache() {
                this.state.gameDataCache.clear();
                this.state.set('isLoadingGames', false);
                this.state.set('isUpdatingInterface', false);
                this.notifications.show('已清除遊戲數據緩存', 'success');
            }

            async reloadGameData(forceRefresh = false) {
                if (forceRefresh) {
                    this.state.gameDataCache.clear();
                }
                
                this.state.set('isLoadingGames', false);
                this.state.set('isUpdatingInterface', false);
                
                clearTimeout(this.state.loadGameTimeout);
                await this.loadGames();
            }

            async loadGames() {
                const selectedUsers = this.state.get('selectedUsers');
                
                if (selectedUsers.length === 0) {
                    this.state.update({
                        allGames: [],
                        filteredGames: []
                    });
                    this.updateGamesInterface();
                    return;
                }
                
                // 防止重複載入
                if (this.state.get('isLoadingGames')) {
                    console.log('遊戲載入中，跳過重複請求');
                    return;
                }
                
                this.state.set('isLoadingGames', true);
                this.showLoading(true);
                
                try {
                    this.notifications.show('正在載入遊戲資料...', 'info');
                    
                    const allUserGames = [];
                    
                    for (let i = 0; i < selectedUsers.length; i++) {
                        const user = selectedUsers[i];
                        try {
                            console.log(`載入用戶 ${user.name} 的遊戲...`);
                            let games;
                            
                            // 檢查緩存
                            if (this.state.gameDataCache.has(user.id)) {
                                console.log(`使用用戶 ${user.name} 的緩存數據`);
                                games = this.state.gameDataCache.get(user.id);
                            } else {
                                // 從資料庫載入
                                if (this.dbManager) {
                                    games = await this.dbManager.loadUserGamesFromDB(user.id);
                                }
                                
                                // 如果資料庫沒有數據，從API載入
                                if (!games || games.length === 0) {
                                    games = await this.steamClient.fetchUserGames(user.id);
                                    
                                    // 異步保存到資料庫
                                    if (this.dbManager && games.length > 0) {
                                        this.dbManager.saveUserGamesToDB(user.id, games).catch(error => {
                                            console.warn('保存遊戲數據失敗:', error);
                                        });
                                    }
                                }
                                
                                // 緩存數據
                                this.state.gameDataCache.set(user.id, games);
                            }
                            
                            allUserGames.push(games);
                        } catch (error) {
                            console.error(`載入用戶 ${user.name} 失敗:`, error);
                            allUserGames.push([]);
                        }
                    }
                    
                    const allGames = this.calculateCommonGames(allUserGames);
                    this.state.set('allGames', allGames);
                    this.filterGames();
                    
                    if (allGames.length === 0) {
                        this.notifications.show('沒有找到任何遊戲', 'warning');
                    } else {
                        this.notifications.show(`成功載入 ${allGames.length} 個遊戲`, 'success');
                    }
                    
                } catch (error) {
                    console.error('載入遊戲失敗:', error);
                    this.notifications.show('載入遊戲資料失敗', 'error');
                    this.state.update({
                        allGames: [],
                        filteredGames: []
                    });
                } finally {
                    this.state.set('isLoadingGames', false);
                    this.showLoading(false);
                    this.updateGamesInterface();
                }
            }

            calculateCommonGames(allUserGames) {
                const gameOccurrences = {};
                const selectedUsers = this.state.get('selectedUsers');
                
                try {
                    allUserGames.forEach((userGames, userIndex) => {
                        if (!Array.isArray(userGames)) {
                            console.warn(`用戶 ${userIndex} 的遊戲數據不是陣列:`, userGames);
                            return;
                        }
                        
                        userGames.forEach(game => {
                            try {
                                // 確保遊戲數據有效
                                if (!game || !game.appid || !game.name) {
                                    console.warn('跳過無效的遊戲數據:', game);
                                    return;
                                }
                                
                                if (!gameOccurrences[game.appid]) {
                                    gameOccurrences[game.appid] = {
                                        ...game,
                                        owners: [],
                                        totalPlaytime: 0
                                    };
                                }
                                
                                const playtime = parseInt(game.playtime_forever) || 0;
                                gameOccurrences[game.appid].owners.push({
                                    userIndex,
                                    playtime: playtime
                                });
                                gameOccurrences[game.appid].totalPlaytime += playtime;
                            } catch (error) {
                                console.error('處理遊戲時發生錯誤:', error, game);
                            }
                        });
                    });
                    
                    const result = Object.values(gameOccurrences).map(game => {
                        try {
                            return {
                                ...game,
                                commonality: game.owners.length,
                                commonalityPercentage: Math.round((game.owners.length / selectedUsers.length) * 100),
                                isCommon: game.owners.length >= Math.max(1, Math.ceil(selectedUsers.length * 0.5)),
                                averagePlaytime: game.owners.length > 0 ? Math.round(game.totalPlaytime / game.owners.length) : 0
                            };
                        } catch (error) {
                            console.error('計算遊戲統計時發生錯誤:', error, game);
                            return null;
                        }
                    }).filter(game => game !== null);
                    
                    console.log(`成功計算 ${result.length} 個遊戲的共通度`);
                    return result;
                    
                } catch (error) {
                    console.error('計算共同遊戲時發生錯誤:', error);
                    return [];
                }
            }

            handleSearchInput() {
                const searchTerm = this.elements.searchInput.value.trim();
                const clearBtn = document.getElementById('clearSearch');
                
                if (clearBtn) {
                    if (searchTerm) {
                        clearBtn.classList.remove('hidden');
                    } else {
                        clearBtn.classList.add('hidden');
                    }
                }
                
                this.filterGames();
            }

            clearSearch() {
                this.elements.searchInput.value = '';
                const clearBtn = document.getElementById('clearSearch');
                if (clearBtn) {
                    clearBtn.classList.add('hidden');
                }
                this.filterGames();
            }

            filterGames() {
                const allGames = this.state.get('allGames');
                const currentFilter = this.state.get('currentFilter');
                let filtered = [...allGames];
                
                switch (currentFilter) {
                    case 'common':
                        filtered = filtered.filter(game => game.isCommon);
                        break;
                    case 'majority':
                        filtered = filtered.filter(game => game.commonalityPercentage >= 50);
                        break;
                    case 'popular':
                        filtered = filtered.filter(game => game.commonalityPercentage >= 75);
                        break;
                    case 'highPlaytime':
                        filtered = filtered.filter(game => game.averagePlaytime >= 300);
                        break;
                }
                
                const searchTerm = this.elements.searchInput ? this.elements.searchInput.value.toLowerCase().trim() : '';
                if (searchTerm) {
                    filtered = filtered.filter(game => 
                        game.name.toLowerCase().includes(searchTerm)
                    );
                }
                
                this.state.set('filteredGames', filtered);
                this.sortGames();
            }

            sortGames() {
                const filteredGames = [...this.state.get('filteredGames')];
                const currentSort = this.state.get('currentSort');
                const selectedUsers = this.state.get('selectedUsers');
                
                switch (currentSort) {
                    case 'name':
                        filteredGames.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                        break;
                    case 'playtime':
                        filteredGames.sort((a, b) => b.averagePlaytime - a.averagePlaytime);
                        break;
                    case 'appid':
                        filteredGames.sort((a, b) => a.appid - b.appid);
                        break;
                    case 'commonality':
                    default:
                        filteredGames.sort((a, b) => {
                            if (b.commonality !== a.commonality) {
                                return b.commonality - a.commonality;
                            }
                            return b.averagePlaytime - a.averagePlaytime;
                        });
                        break;
                }
                
                this.state.set('filteredGames', filteredGames);
                this.updateGamesInterface();
            }

            updateGamesInterface() {
                try {
                    if (!this.elements.gamesGrid || !this.elements.emptyState) {
                        console.warn('遊戲界面元素不存在');
                        return;
                    }
                    
                    // 防止重複更新
                    if (this.state.get('isUpdatingInterface')) {
                        console.log('界面更新中，跳過重複請求');
                        return;
                    }
                    
                    this.state.set('isUpdatingInterface', true);
                    
                    // 清空現有內容
                    this.elements.gamesGrid.innerHTML = '';
                    
                    const filteredGames = this.state.get('filteredGames');
                    
                    if (filteredGames.length === 0) {
                        this.elements.emptyState.classList.remove('hidden');
                        this.elements.gamesGrid.classList.add('hidden');
                    } else {
                        this.elements.emptyState.classList.add('hidden');
                        this.elements.gamesGrid.classList.remove('hidden');
                        
                        // 使用DocumentFragment提高性能
                        const fragment = document.createDocumentFragment();
                        let createdCount = 0;
                        
                        for (let i = 0; i < filteredGames.length; i++) {
                            try {
                                const game = filteredGames[i];
                                if (game && game.name && game.appid) {
                                    const gameCard = this.createGameCard(game);
                                    if (gameCard) {
                                        fragment.appendChild(gameCard);
                                        createdCount++;
                                    }
                                }
                            } catch (error) {
                                console.error(`創建遊戲卡片 ${i} 時發生錯誤:`, error, filteredGames[i]);
                            }
                        }
                        
                        // 一次性添加所有卡片
                        this.elements.gamesGrid.appendChild(fragment);
                        console.log(`成功創建 ${createdCount} 個遊戲卡片，顯示 ${filteredGames.length} 個遊戲`);
                    }
                    
                    this.updateStats();
                    
                } catch (error) {
                    console.error('更新遊戲界面失敗:', error);
                    this.notifications.show('顯示遊戲時發生錯誤', 'error');
                } finally {
                    this.state.set('isUpdatingInterface', false);
                }
            }

            createGameCard(game) {
                const selectedUsers = this.state.get('selectedUsers');
                const card = DOMUtils.createElement('div', {
                    className: 'game-card glass-effect rounded-xl overflow-hidden fade-in'
                });
                
                // 安全處理遊戲名稱
                const safeName = DOMUtils.sanitizeGameName(game.name);
                const encodedName = encodeURIComponent(safeName);
                
                const headerImageUrl = `https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/header.jpg`;
                const capsuleImageUrl = `https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/capsule_231x87.jpg`;
                const fallbackImageUrl = `https://ui-avatars.com/api/?name=${encodedName}&size=300&background=334155&color=94a3b8`;
                
                const gameGenres = this.getGameGenres(game.appid);
                const commonalityColor = game.commonalityPercentage >= 75 ? 'text-green-400' : 
                                       game.commonalityPercentage >= 50 ? 'text-yellow-400' : 'text-blue-400';
                
                // 創建圖片元素
                const imgElement = DOMUtils.createElement('img', {
                    src: headerImageUrl,
                    alt: safeName,
                    className: 'w-full h-32 object-cover transition-transform duration-300 group-hover:scale-105',
                    onerror: function() {
                        this.onerror = null;
                        this.src = capsuleImageUrl;
                        this.onload = function() {
                            this.onerror = function() {
                                this.src = fallbackImageUrl;
                            }
                        }
                    },
                    onload: function() {
                        this.onerror = function() {
                            this.src = fallbackImageUrl;
                        }
                    }
                });

                // 創建主要內容容器
                const contentDiv = DOMUtils.createElement('div', {
                    className: 'relative group'
                });
                
                contentDiv.appendChild(imgElement);
                
                // 創建懸停覆蓋層
                const hoverOverlay = DOMUtils.createElement('div', {
                    className: 'absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center',
                    innerHTML: `
                        <div class="text-center text-white p-2">
                            <p class="text-sm font-medium mb-1">點擊查看Steam商店</p>
                            <p class="text-xs text-slate-300">App ID: ${game.appid}</p>
                        </div>
                    `
                });
                contentDiv.appendChild(hoverOverlay);
                
                // 創建共通度指示器
                const indicator = DOMUtils.createElement('div', {
                    className: 'absolute top-2 right-2',
                    innerHTML: `
                        <div class="bg-black/80 backdrop-blur-sm rounded-full px-2 py-1 text-xs font-medium border border-white/20">
                            <span class="${commonalityColor}">${game.commonality}</span>
                            <span class="text-slate-300">/${selectedUsers.length}</span>
                        </div>
                    `
                });
                contentDiv.appendChild(indicator);
                
                // 添加標籤
                if (game.isCommon) {
                    const commonTag = DOMUtils.createElement('div', {
                        className: 'absolute top-2 left-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-2 py-1 rounded-full text-xs font-medium shadow-lg',
                        textContent: '共同遊戲'
                    });
                    contentDiv.appendChild(commonTag);
                }
                
                if (game.commonalityPercentage >= 75) {
                    const popularTag = DOMUtils.createElement('div', {
                        className: 'absolute bottom-2 left-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-2 py-1 rounded-full text-xs font-medium',
                        textContent: '熱門'
                    });
                    contentDiv.appendChild(popularTag);
                }
                
                card.appendChild(contentDiv);
                
                // 創建詳細資訊區域
                const detailsDiv = DOMUtils.createElement('div', {
                    className: 'p-4'
                });
                
                // 遊戲標題
                const titleElement = DOMUtils.createElement('h3', {
                    className: 'font-medium text-sm mb-3 line-clamp-2 leading-tight',
                    title: safeName,
                    textContent: safeName
                });
                detailsDiv.appendChild(titleElement);
                
                // 遊戲類型標籤
                if (gameGenres.length > 0) {
                    const genresDiv = DOMUtils.createElement('div', {
                        className: 'flex flex-wrap gap-1 mb-3'
                    });
                    gameGenres.slice(0, 2).forEach(genre => {
                        const genreSpan = DOMUtils.createElement('span', {
                            className: 'px-2 py-1 bg-slate-600/50 text-slate-300 text-xs rounded-full',
                            textContent: genre
                        });
                        genresDiv.appendChild(genreSpan);
                    });
                    detailsDiv.appendChild(genresDiv);
                }
                
                // 進度條區域
                const progressDiv = DOMUtils.createElement('div', {
                    className: 'mb-3',
                    innerHTML: `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-slate-400">擁有率</span>
                            <span class="text-xs font-medium ${commonalityColor}">${game.commonalityPercentage}%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-gradient-to-r ${this.getProgressBarColor(game.commonalityPercentage)} h-2 rounded-full transition-all duration-500" 
                                 style="width: ${game.commonalityPercentage}%"></div>
                        </div>
                    `
                });
                detailsDiv.appendChild(progressDiv);
                
                // 統計資訊
                const statsDiv = DOMUtils.createElement('div', {
                    className: 'grid grid-cols-2 gap-2 text-xs text-slate-400',
                    innerHTML: `
                        <div class="text-center">
                            <div class="font-medium text-white">${Math.round(game.averagePlaytime / 60)}h</div>
                            <div>平均時間</div>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-white">${game.owners.length}</div>
                            <div>擁有者</div>
                        </div>
                    `
                });
                detailsDiv.appendChild(statsDiv);
                
                card.appendChild(detailsDiv);
                
                // 添加點擊效果
                const ripple = DOMUtils.createElement('div', {
                    className: 'absolute inset-0 rounded-xl opacity-0 bg-blue-400/20 pointer-events-none transition-opacity duration-200 card-ripple'
                });
                card.appendChild(ripple);
                
                // 事件監聽器
                card.addEventListener('click', (e) => {
                    const rippleElement = card.querySelector('.card-ripple');
                    if (rippleElement) {
                        rippleElement.style.opacity = '1';
                        setTimeout(() => {
                            rippleElement.style.opacity = '0';
                        }, 200);
                    }
                    
                    window.open(`${this.config.STEAM_CONFIG.STORE_BASE}/${game.appid}`, '_blank');
                });

                card.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showGameDetails(game);
                });
                
                return card;
            }

            getGameGenres(appId) {
                const gameGenresMap = {
                    570: ['MOBA', 'Free to Play'],
                    730: ['FPS', '競技'],
                    440: ['FPS', 'Free to Play'],
                    271590: ['開放世界', '動作'],
                    431960: ['工具', '個人化'],
                    252490: ['生存', '多人'],
                    578080: ['大逃殺', 'FPS'],
                    292030: ['RPG', '開放世界']
                };
                
                return gameGenresMap[appId] || ['遊戲'];
            }

            getProgressBarColor(percentage) {
                if (percentage >= 75) return 'from-green-500 to-green-600';
                if (percentage >= 50) return 'from-yellow-500 to-yellow-600';
                if (percentage >= 25) return 'from-blue-500 to-blue-600';
                return 'from-gray-500 to-gray-600';
            }

            updateStats() {
                try {
                    const allGames = this.state.get('allGames');
                    const filteredGames = this.state.get('filteredGames');
                    const selectedUsers = this.state.get('selectedUsers');
                    
                    if (this.elements.totalGames) this.elements.totalGames.textContent = allGames.length;
                    if (this.elements.commonGames) this.elements.commonGames.textContent = allGames.filter(g => g.isCommon).length;
                    if (this.elements.selectedUsers) this.elements.selectedUsers.textContent = selectedUsers.length;
                    if (this.elements.showingGames) this.elements.showingGames.textContent = filteredGames.length;
                } catch (error) {
                    console.error('更新統計失敗:', error);
                }
            }

            showLoading(show) {
                try {
                    if (show) {
                        if (this.elements.loadingState) this.elements.loadingState.classList.remove('hidden');
                        if (this.elements.gamesGrid) this.elements.gamesGrid.classList.add('hidden');
                        if (this.elements.emptyState) this.elements.emptyState.classList.add('hidden');
                    } else {
                        if (this.elements.loadingState) this.elements.loadingState.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('顯示載入狀態失敗:', error);
                }
            }

            setQuickFilter(filterType) {
                document.querySelectorAll('.filter-tag').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === filterType) {
                        btn.classList.add('active');
                    }
                });
                
                this.state.set('currentFilter', filterType);
                this.filterGames();
                
                const filterNames = {
                    'common': '共同遊戲',
                    'popular': '熱門遊戲'
                };
                this.notifications.show(`已篩選：${filterNames[filterType]}`, 'success');
            }

            resetAllFilters() {
                document.querySelectorAll('.filter-tag').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === 'all') {
                        btn.classList.add('active');
                    }
                });
                this.state.set('currentFilter', 'all');
                
                if (this.elements.sortSelect) {
                    this.elements.sortSelect.value = 'commonality';
                }
                this.state.set('currentSort', 'commonality');
                
                if (this.elements.searchInput) {
                    this.elements.searchInput.value = '';
                }
                const clearBtn = document.getElementById('clearSearch');
                if (clearBtn) {
                    clearBtn.classList.add('hidden');
                }
                
                this.filterGames();
                this.notifications.show('已重置所有篩選條件', 'success');
            }

            exportGameList() {
                const filteredGames = this.state.get('filteredGames');
                const selectedUsers = this.state.get('selectedUsers');
                const currentFilter = this.state.get('currentFilter');
                const currentSort = this.state.get('currentSort');
                
                if (filteredGames.length === 0) {
                    this.notifications.show('沒有遊戲可導出', 'warning');
                    return;
                }

                const exportData = {
                    exportTime: new Date().toISOString(),
                    selectedUsers: selectedUsers.map(u => ({ id: u.id, name: u.name })),
                    filter: currentFilter,
                    sort: currentSort,
                    totalGames: filteredGames.length,
                    games: filteredGames.map(game => ({
                        appId: game.appid,
                        name: game.name,
                        commonality: game.commonality,
                        commonalityPercentage: game.commonalityPercentage,
                        averagePlaytime: game.averagePlaytime,
                        isCommon: game.isCommon,
                        steamUrl: `${this.config.STEAM_CONFIG.STORE_BASE}/${game.appid}`
                    }))
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `steam-common-games-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);

                this.notifications.show(`已導出 ${filteredGames.length} 個遊戲的清單`, 'success');
            }

            showGameDetails(game) {
                const selectedUsers = this.state.get('selectedUsers');
                const modal = DOMUtils.createElement('div', {
                    className: 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4'
                });
                
                const ownersList = game.owners.map((owner, index) => {
                    const user = selectedUsers[owner.userIndex];
                    return `
                        <div class="flex items-center justify-between p-2 bg-slate-700/50 rounded">
                            <div class="flex items-center space-x-2">
                                <img src="${user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}`}" 
                                     class="w-6 h-6 rounded-full" alt="${DOMUtils.escapeHtml(user.name)}">
                                <span class="text-sm">${DOMUtils.escapeHtml(user.name)}</span>
                            </div>
                            <span class="text-xs text-slate-400">${Math.round(owner.playtime / 60)}h</span>
                        </div>
                    `;
                }).join('');

                modal.innerHTML = `
                    <div class="glass-effect rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h2 class="text-lg font-bold text-white">${DOMUtils.escapeHtml(game.name)}</h2>
                                <button class="text-slate-400 hover:text-white close-modal">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <img src="https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/header.jpg" 
                                 alt="${DOMUtils.escapeHtml(game.name)}" 
                                 class="w-full h-32 object-cover rounded-lg mb-4"
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(game.name)}&size=400&background=334155&color=94a3b8'">
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="text-center p-3 bg-slate-700/30 rounded-lg">
                                    <div class="text-xl font-bold text-blue-400">${game.commonality}</div>
                                    <div class="text-xs text-slate-400">擁有者數量</div>
                                </div>
                                <div class="text-center p-3 bg-slate-700/30 rounded-lg">
                                    <div class="text-xl font-bold text-green-400">${game.commonalityPercentage}%</div>
                                    <div class="text-xs text-slate-400">擁有率</div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-slate-300 mb-2">遊戲擁有者</h3>
                                <div class="space-y-2">
                                    ${ownersList}
                                </div>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors open-steam">
                                    在Steam中打開
                                </button>
                                <button class="flex-1 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors close-modal">
                                    關閉
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                modal.querySelector('.open-steam').addEventListener('click', () => {
                    window.open(`${this.config.STEAM_CONFIG.STORE_BASE}/${game.appid}`, '_blank');
                });

                modal.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

                document.body.appendChild(modal);
            }

            showHelpModal() {
                const modal = DOMUtils.createElement('div', {
                    className: 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4'
                });
                
                modal.innerHTML = `
                    <div class="glass-effect rounded-xl max-w-lg w-full">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <h2 class="text-lg font-bold text-white">快捷鍵說明</h2>
                                <button class="text-slate-400 hover:text-white close-modal">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 gap-3">
                                    <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                        <span class="text-slate-300">搜尋遊戲</span>
                                        <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + F</kbd>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                        <span class="text-slate-300">只看共同遊戲</span>
                                        <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + C</kbd>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                        <span class="text-slate-300">重置篩選</span>
                                        <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + R</kbd>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                        <span class="text-slate-300">導出清單</span>
                                        <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + E</kbd>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                        <span class="text-slate-300">快速篩選 1-4</span>
                                        <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + 1~4</kbd>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                        <span class="text-slate-300">關閉彈窗/清除搜尋</span>
                                        <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Esc</kbd>
                                    </div>
                                </div>
                                
                                <div class="border-t border-slate-600/30 pt-4">
                                    <h3 class="text-sm font-medium text-slate-300 mb-2">滑鼠操作</h3>
                                    <div class="space-y-2 text-sm text-slate-400">
                                        <div>• 左鍵點擊遊戲卡片：打開Steam商店頁面</div>
                                        <div>• 右鍵點擊遊戲卡片：顯示遊戲詳細資訊</div>
                                        <div>• 懸停在遊戲卡片上：顯示額外資訊</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <button class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors close-modal">
                                    我知道了
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                modal.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

                document.body.appendChild(modal);
            }

            handleKeyboardShortcuts(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    return;
                }

                switch (e.key.toLowerCase()) {
                    case 'f':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            this.elements.searchInput?.focus();
                        }
                        break;
                    case 'c':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            this.setQuickFilter('common');
                        }
                        break;
                    case 'r':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            this.resetAllFilters();
                        }
                        break;
                    case 'e':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            this.exportGameList();
                        }
                        break;
                    case 'escape':
                        const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
                        if (modal) {
                            modal.remove();
                        } else if (this.elements.searchInput?.value) {
                            this.clearSearch();
                        }
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            const filterTypes = ['all', 'common', 'majority', 'popular'];
                            const filterIndex = parseInt(e.key) - 1;
                            if (filterTypes[filterIndex]) {
                                this.setQuickFilter(filterTypes[filterIndex]);
                            }
                        }
                        break;
                }
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // 清理資源
            destroy() {
                // 清理事件監聽器
                this.eventListeners.forEach((handlers, element) => {
                    Object.entries(handlers).forEach(([event, handler]) => {
                        element.removeEventListener(event, handler);
                    });
                });
                this.eventListeners.clear();
                
                // 清理定時器
                clearTimeout(this.state.loadGameTimeout);
                
                // 清理緩存
                this.state.gameDataCache.clear();
                
                console.log('應用程式已清理');
            }
        }

        // 初始化應用程式
        const app = new SteamGameDiscoveryApp();
        
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
        
        // 清理資源
        window.addEventListener('beforeunload', () => {
            app.destroy();
        });
    </script>
</body>
</html>
