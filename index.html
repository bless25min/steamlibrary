<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam å…±é€šéŠæˆ²ç™¼ç¾å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .glass-effect {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .game-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        .game-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-avatar {
            transition: all 0.2s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
        }
        
        .filter-tag {
            transition: all 0.2s ease;
        }
        
        .filter-tag.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .notification {
            z-index: 9999;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .error-indicator {
            position: relative;
        }

        .error-indicator::after {
            content: 'âš ï¸';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 min-h-screen text-white">
    <!-- å°èˆªæ¬„ -->
    <nav class="glass-effect border-b border-slate-600/30 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        Steam å…±é€šéŠæˆ²ç™¼ç¾
                    </h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- ç³»çµ±ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                    <div id="systemStatus" class="flex items-center space-x-2">
                        <div id="dbStatus" class="w-3 h-3 rounded-full bg-gray-500" title="è³‡æ–™åº«ç‹€æ…‹"></div>
                        <div id="apiStatus" class="w-3 h-3 rounded-full bg-gray-500" title="APIç‹€æ…‹"></div>
                    </div>
                    
                    <div id="userInfo" class="hidden items-center space-x-3">
                        <img id="userAvatar" class="w-8 h-8 rounded-full border-2 border-blue-400" alt="ç”¨æˆ¶é ­åƒ">
                        <span id="userName" class="text-sm font-medium"></span>
                    </div>
                    <button id="helpBtn" class="text-slate-400 hover:text-white transition-colors" title="å¿«æ·éµèªªæ˜">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                    <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Discord ç™»å…¥
                    </button>
                    <button id="logoutBtn" class="hidden bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        ç™»å‡º
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- ç”¨æˆ¶é¸æ“‡é¢æ¿ -->
        <div id="userPanel" class="glass-effect rounded-xl p-6 mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h2 class="text-lg font-semibold mb-2">Discordç¾¤çµ„æˆå“¡ & å…±äº«å¸³è™Ÿ</h2>
                    <p class="text-sm text-slate-400">é¸æ“‡ç”¨æˆ¶ä¾†æ¯”è¼ƒéŠæˆ²åº«ä¸¦æ‰¾å‡ºå…±åŒéŠæˆ²</p>
                </div>
                <div class="flex flex-wrap gap-2 mt-4 sm:mt-0">
                    <button id="manageSteamBtn" class="hidden bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                        </svg>
                        ç®¡ç†Steamé€£çµ
                    </button>
                    <button id="testSteamBtn" class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded text-sm transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        æ¸¬è©¦Steam URL
                    </button>
                    <button id="cleanDuplicatesBtn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        æ¸…ç†é‡è¤‡
                    </button>
                    <button id="forceLogoutBtn" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-sm transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                        </svg>
                        å¼·åˆ¶ç™»å‡º
                    </button>
                    <button id="selectAllBtn" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-sm transition-colors">
                        å…¨é¸
                    </button>
                    <button id="deselectAllBtn" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm transition-colors">
                        å–æ¶ˆå…¨é¸
                    </button>
                    <button id="retryFailedBtn" class="hidden bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-sm transition-colors">
                        é‡è©¦å¤±æ•—ç”¨æˆ¶
                    </button>
                </div>
            </div>
            
            <div id="userList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <!-- ç”¨æˆ¶å¡ç‰‡æœƒå‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>

        <!-- ç¯©é¸å’Œçµ±è¨ˆé¢æ¿ -->
        <div class="glass-effect rounded-xl p-6 mb-8">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- ç¯©é¸é¸é … -->
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-slate-300 mb-3">ç¯©é¸éŠæˆ²</h3>
                    <div class="flex flex-wrap gap-2">
                        <button class="filter-tag active px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="all">
                            å…¨éƒ¨éŠæˆ²
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="common">
                            å…±åŒéŠæˆ²
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="majority">
                            å¤šæ•¸äººæ“æœ‰ (â‰¥50%)
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="popular">
                            ç†±é–€ (â‰¥75%)
                        </button>
                        <button class="filter-tag px-3 py-1 rounded-full text-sm bg-slate-700 hover:bg-slate-600 transition-colors" data-filter="highPlaytime">
                            é«˜éŠæˆ²æ™‚é–“
                        </button>
                    </div>
                </div>
                
                <!-- æ’åºé¸é … -->
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-slate-300 mb-3">æ’åºæ–¹å¼</h3>
                    <select id="sortSelect" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm w-full lg:w-auto focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="commonality">æŒ‰å…±é€šåº¦æ’åº</option>
                        <option value="name">æŒ‰åç¨±æ’åº (A-Z)</option>
                        <option value="playtime">æŒ‰éŠæˆ²æ™‚é–“æ’åº</option>
                        <option value="appid">æŒ‰éŠæˆ²IDæ’åº</option>
                    </select>
                </div>
                
                <!-- æœå°‹æ¡† -->
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-slate-300 mb-3">æœå°‹éŠæˆ²</h3>
                    <div class="relative">
                        <input id="searchInput" type="text" placeholder="è¼¸å…¥éŠæˆ²åç¨±..." 
                               class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 pr-10 text-sm w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <button id="clearSearch" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white transition-colors hidden">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div id="statsPanel" class="mt-6 pt-6 border-t border-slate-600/30">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                    <div class="text-center">
                        <div id="totalGames" class="text-2xl font-bold text-blue-400">0</div>
                        <div class="text-sm text-slate-400">ç¸½éŠæˆ²æ•¸</div>
                    </div>
                    <div class="text-center">
                        <div id="commonGames" class="text-2xl font-bold text-green-400">0</div>
                        <div class="text-sm text-slate-400">å…±åŒéŠæˆ²</div>
                    </div>
                    <div class="text-center">
                        <div id="selectedUsers" class="text-2xl font-bold text-purple-400">0</div>
                        <div class="text-sm text-slate-400">å·²é¸ç”¨æˆ¶</div>
                    </div>
                    <div class="text-center">
                        <div id="showingGames" class="text-2xl font-bold text-yellow-400">0</div>
                        <div class="text-sm text-slate-400">é¡¯ç¤ºéŠæˆ²</div>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œé¢æ¿ -->
                <div class="flex flex-wrap gap-2 justify-center">
                    <button id="quickCommonBtn" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-full text-sm transition-colors">
                        åªçœ‹å…±åŒéŠæˆ²
                    </button>
                    <button id="quickPopularBtn" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded-full text-sm transition-colors">
                        åªçœ‹ç†±é–€éŠæˆ²
                    </button>
                    <button id="quickResetBtn" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded-full text-sm transition-colors">
                        é‡ç½®ç¯©é¸
                    </button>
                    <button id="clearCacheBtn" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded-full text-sm transition-colors">
                        æ¸…é™¤ç·©å­˜
                    </button>
                    <button id="reloadBtn" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded-full text-sm transition-colors">
                        é‡æ–°è¼‰å…¥
                    </button>
                    <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-full text-sm transition-colors">
                        å°å‡ºæ¸…å–®
                    </button>
                </div>
            </div>
        </div>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loadingState" class="hidden">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
                <div class="skeleton rounded-xl aspect-[3/4] w-full"></div>
            </div>
        </div>

        <!-- éŠæˆ²ç¶²æ ¼ -->
        <div id="gamesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            <!-- éŠæˆ²å¡ç‰‡æœƒå‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- ç©ºç‹€æ…‹ -->
        <div id="emptyState" class="hidden text-center py-16">
            <div class="w-16 h-16 mx-auto mb-4 bg-slate-700 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-slate-300 mb-2">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„éŠæˆ²</h3>
            <p class="text-slate-400 mb-4">è«‹é¸æ“‡è‡³å°‘ä¸€å€‹ç”¨æˆ¶ä¾†æŸ¥çœ‹éŠæˆ²</p>
            <div class="text-sm text-slate-500 max-w-md mx-auto">
                <p class="mb-2">æç¤ºï¼šå¦‚æœæŸå€‹ç”¨æˆ¶é¡¯ç¤º 0 å€‹éŠæˆ²ï¼Œå¯èƒ½åŸå› ï¼š</p>
                <ul class="text-left list-disc list-inside space-y-1">
                    <li>Steam å€‹äººè³‡æ–™è¨­ç‚ºç§å¯†</li>
                    <li>éŠæˆ²è©³æƒ…æœªè¨­ç‚ºå…¬é–‹</li>
                    <li>è©²å¸³è™Ÿç¢ºå¯¦æ²’æœ‰ä»»ä½•éŠæˆ²</li>
                </ul>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-slate-600/30 mt-16 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-slate-400">
            <p class="mb-2">
                éŠæˆ²ç¾¤çµ„ï¼š<a href="https://discord.gg/C9vkSAZmPT" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 transition-colors">Discord</a>
            </p>
            <p>
                ä½œè€…ï¼šå»–å¤©ä½‘ Bless Liao (blessyo)
            </p>
        </div>
    </footer>
    <script>
        // é…ç½®
        const SUPABASE_CONFIG = {
            url: 'https://lwbrqtevzhfkwbwbcdtz.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3YnJxdGV2emhma3did2JjZHR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NjcxMjYsImV4cCI6MjA2NzA0MzEyNn0.4s16bos5EEhSuUg-K1Paf8B5UXyo-Ca8reTFZ03VVT8'
        };
        
        const STEAM_CONFIG = {
            API_KEY: '274411C2579E7E7CB7482A4BDEAB1077',
            PROXY_URL: 'https://corsproxy.io/?',
            STORE_BASE: 'https://store.steampowered.com/app',
            API_BASE: 'http://api.steampowered.com'
        };

        // å…±äº«å¸³è™Ÿ
        const SHARED_ACCOUNTS = [
            { id: '76561199470483407', name: 'å…±äº«å¸³è™Ÿ #1', isShared: true, gameCount: 0 },
            { id: '76561199509330900', name: 'å…±äº«å¸³è™Ÿ #2', isShared: true, gameCount: 0 },
            { id: '76561199509470809', name: 'å…±äº«å¸³è™Ÿ #3', isShared: true, gameCount: 0 },
            { id: '76561199509517864', name: 'å…±äº«å¸³è™Ÿ #4', isShared: true, gameCount: 0 }
        ];

        // Steam URL è§£ææ­£å‰‡è¡¨é”å¼
        const STEAM_URL_PATTERNS = [
            /steamcommunity\.com\/profiles\/([0-9]{17})/,  // ç›´æ¥ Steam ID
            /steamcommunity\.com\/id\/([^\/]+)/,           // è‡ªå®šç¾© URL
        ];
        
        // é©—è­‰ Steam ID
        function validateSteamId(steamId) {
            const steamIdPattern = /^[0-9]{17}$/;
            return steamIdPattern.test(steamId);
        }

        // è§£æSteam URLä¸¦æå–Steam ID
        async function parseSteamUrl(url) {
            try {
                // æ¸…ç†URL
                let cleanUrl = url.trim();
                if (!cleanUrl.startsWith('http')) {
                    cleanUrl = 'https://' + cleanUrl;
                }

                // å˜—è©¦åŒ¹é…ç›´æ¥çš„Steam ID
                const directMatch = cleanUrl.match(STEAM_URL_PATTERNS[0]);
                if (directMatch) {
                    return directMatch[1];
                }

                // å˜—è©¦åŒ¹é…è‡ªå®šç¾©URL
                const customMatch = cleanUrl.match(STEAM_URL_PATTERNS[1]);
                if (customMatch) {
                    const customId = customMatch[1];
                    return await resolveCustomSteamId(customId);
                }

                throw new Error('ç„¡æ•ˆçš„Steam URLæ ¼å¼');
            } catch (error) {
                throw new AppError(`ç„¡æ³•è§£æSteam URL: ${error.message}`, 'steam-url');
            }
        }

        // è§£æè‡ªå®šç¾©Steam ID
        async function resolveCustomSteamId(customId) {
            const errors = [];
            
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxy = CORS_PROXIES[i];
                try {
                    const steamUrl = `${STEAM_CONFIG.API_BASE}/ISteamUser/ResolveVanityURL/v0001/?key=${STEAM_CONFIG.API_KEY}&vanityurl=${encodeURIComponent(customId)}&url_type=1`;
                    const finalUrl = `${proxy.url}${encodeURIComponent(steamUrl)}`;
                    
                    console.log(`å˜—è©¦è§£æè‡ªå®šç¾©Steam ID: ${customId} ä½¿ç”¨ä»£ç†: ${proxy.name}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), proxy.timeout);
                    
                    const response = await fetch(finalUrl, {
                        method: 'GET',
                        signal: controller.signal,
                        headers: { 
                            'Accept': 'application/json',
                            'User-Agent': 'Steam Game Finder/1.0'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    let data;
                    
                    try {
                        const jsonData = JSON.parse(responseText);
                        data = jsonData.contents ? JSON.parse(jsonData.contents) : jsonData;
                    } catch (parseError) {
                        console.error('è§£æéŸ¿æ‡‰å¤±æ•—:', responseText.substring(0, 200));
                        throw new Error('è§£æéŸ¿æ‡‰å¤±æ•—');
                    }
                    
                    console.log('Steam API ResolveVanityURL éŸ¿æ‡‰:', data);
                    
                    if (data.response) {
                        if (data.response.success === 1 && data.response.steamid) {
                            console.log(`æˆåŠŸè§£æè‡ªå®šç¾©ID ${customId} -> Steam ID: ${data.response.steamid}`);
                            return data.response.steamid;
                        } else if (data.response.success === 42) {
                            throw new Error(`æ‰¾ä¸åˆ°è‡ªå®šç¾©URL: ${customId}`);
                        } else {
                            throw new Error(`Steam APIéŒ¯èª¤ (code: ${data.response.success}): ${data.response.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                        }
                    } else {
                        throw new Error('Steam APIéŸ¿æ‡‰æ ¼å¼éŒ¯èª¤');
                    }
                    
                } catch (error) {
                    const errorMsg = `ä»£ç† ${proxy.name}: ${error.message}`;
                    console.error(errorMsg);
                    errors.push(errorMsg);
                    
                    if (i < CORS_PROXIES.length - 1) {
                        console.log('å˜—è©¦ä¸‹ä¸€å€‹ä»£ç†...');
                    }
                }
            }
            
            throw new Error(`ç„¡æ³•è§£æè‡ªå®šç¾©Steam ID "${customId}": ${errors.join(', ')}`);
        }

        // æ”¹é€²çš„CORSä»£ç†æœå‹™
        const CORS_PROXIES = [
            {
                url: 'https://corsproxy.io/?',
                name: 'CorsProxy.io',
                timeout: 15000,
                priority: 1
            },
            {
                url: 'https://api.codetabs.com/v1/proxy?quest=',
                name: 'CodeTabs',
                timeout: 20000,
                priority: 2
            },
            {
                url: 'https://thingproxy.freeboard.io/fetch/',
                name: 'ThingProxy',
                timeout: 25000,
                priority: 3
            }
        ];

        // å…¨å±€ç‹€æ…‹
        let currentUser = null;
        let allUsers = [];
        let selectedUsers = [];
        let failedUsers = []; // æ–°å¢ï¼šè¨˜éŒ„è¼‰å…¥å¤±æ•—çš„ç”¨æˆ¶
        let allGames = [];
        let filteredGames = [];
        let currentFilter = 'all';
        let currentSort = 'commonality';
        let supabase = null;
        let isLoadingGames = false;
        let gameDataCache = new Map();
        let elements = {};
        let authInitialized = false;
        let systemStatus = {
            database: 'unknown',
            steamApi: 'unknown'
        };

        // éŒ¯èª¤è™•ç†æ”¹é€²
        class AppError extends Error {
            constructor(message, type = 'general', details = null) {
                super(message);
                this.type = type;
                this.details = details;
                this.timestamp = new Date();
            }
        }

        // éŒ¯èª¤è¨˜éŒ„å™¨
        const ErrorLogger = {
            errors: [],
            log(error) {
                console.error(`[${error.type.toUpperCase()}] ${error.message}`, error.details);
                this.errors.push(error);
                this.updateUI();
            },
            updateUI() {
                // æ ¹æ“šéŒ¯èª¤é¡å‹æ›´æ–°UIç‹€æ…‹æŒ‡ç¤ºå™¨
                if (this.errors.some(e => e.type === 'database')) {
                    updateSystemStatus('database', 'error');
                }
                if (this.errors.some(e => e.type === 'steam-api')) {
                    updateSystemStatus('steamApi', 'error');
                }
            },
            clear() {
                this.errors = [];
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é–‹å§‹åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
            
            try {
                initializeElements();
                initializeSupabase();
                setupEventListeners();
                cleanupOAuthErrors();
                startInitialLoad();
                console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                ErrorLogger.log(new AppError('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—', 'initialization', error));
                showNotification('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—', 'error');
            }
        });

        // åˆå§‹åŒ–DOMå…ƒç´ 
        function initializeElements() {
            const elementIds = [
                'loginBtn', 'logoutBtn', 'userInfo', 'userAvatar', 'userName',
                'userList', 'gamesGrid', 'loadingState', 'emptyState',
                'searchInput', 'sortSelect', 'selectAllBtn', 'deselectAllBtn',
                'totalGames', 'commonGames', 'selectedUsers', 'showingGames',
                'dbStatus', 'apiStatus', 'retryFailedBtn', 'manageSteamBtn', 'testSteamBtn', 'cleanDuplicatesBtn', 'forceLogoutBtn'
            ];

            elements = {};
            elementIds.forEach(id => {
                elements[id] = document.getElementById(id);
                if (!elements[id]) {
                    console.warn(`æ‰¾ä¸åˆ°å…ƒç´ : ${id}`);
                }
            });
        }

        // æ”¹é€²çš„ Supabase åˆå§‹åŒ–
        async function initializeSupabase() {
            try {
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                    
                    // æ¸¬è©¦è³‡æ–™åº«é€£ç·š
                    await testDatabaseConnection();
                    
                    console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
                    updateSystemStatus('database', 'connected');
                } else {
                    throw new AppError('Supabase åº«æœªè¼‰å…¥', 'initialization');
                }
            } catch (error) {
                ErrorLogger.log(new AppError('Supabase åˆå§‹åŒ–å¤±æ•—', 'database', error));
                updateSystemStatus('database', 'error');
            }
        }

        // æ¸¬è©¦è³‡æ–™åº«é€£ç·š
        async function testDatabaseConnection() {
            try {
                // å˜—è©¦ä¸€å€‹ç°¡å–®çš„æŸ¥è©¢ä¾†æ¸¬è©¦é€£ç·š
                const { data, error } = await supabase
                    .from('users')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    // å¦‚æœæ˜¯RLSéŒ¯èª¤ï¼Œä»ç„¶èªç‚ºé€£ç·šæ­£å¸¸
                    if (error.code === '42501' || error.message.includes('RLS')) {
                        console.warn('è³‡æ–™åº«é€£ç·šæ­£å¸¸ï¼Œä½†RLSæ”¿ç­–é™åˆ¶è¨ªå•');
                        updateSystemStatus('database', 'warning');
                        return;
                    }
                    throw error;
                }
                
                updateSystemStatus('database', 'connected');
            } catch (error) {
                throw new AppError('è³‡æ–™åº«é€£ç·šæ¸¬è©¦å¤±æ•—', 'database', error);
            }
        }

        // ç³»çµ±ç‹€æ…‹æ›´æ–°
        function updateSystemStatus(component, status) {
            systemStatus[component] = status;
            
            const statusElement = elements[component === 'database' ? 'dbStatus' : 'apiStatus'];
            if (!statusElement) return;
            
            statusElement.classList.remove('bg-gray-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500');
            
            switch (status) {
                case 'connected':
                    statusElement.classList.add('bg-green-500');
                    statusElement.title = `${component === 'database' ? 'è³‡æ–™åº«' : 'API'}é€£ç·šæ­£å¸¸`;
                    break;
                case 'warning':
                    statusElement.classList.add('bg-yellow-500');
                    statusElement.title = `${component === 'database' ? 'è³‡æ–™åº«' : 'API'}æœ‰è­¦å‘Š`;
                    break;
                case 'error':
                    statusElement.classList.add('bg-red-500');
                    statusElement.title = `${component === 'database' ? 'è³‡æ–™åº«' : 'API'}é€£ç·šéŒ¯èª¤`;
                    break;
                default:
                    statusElement.classList.add('bg-gray-500');
                    statusElement.title = `${component === 'database' ? 'è³‡æ–™åº«' : 'API'}ç‹€æ…‹æœªçŸ¥`;
            }
        }

        // æ¸…ç†OAuthéŒ¯èª¤
        function cleanupOAuthErrors() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'invalid_request') {
                console.log('æ¸…ç†OAuthéŒ¯èª¤åƒæ•¸');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // é–‹å§‹åˆå§‹è¼‰å…¥
        async function startInitialLoad() {
            try {
                await checkAuth();
                await loadUsers();
                selectedUsers = [];
                failedUsers = [];
                updateUserInterface();
            } catch (error) {
                ErrorLogger.log(new AppError('åˆå§‹è¼‰å…¥å¤±æ•—', 'initialization', error));
                showNotification('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            }
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            try {
                console.log('é–‹å§‹è¨­ç½®äº‹ä»¶ç›£è½å™¨...');
                
                // åŸºæœ¬æŒ‰éˆ•äº‹ä»¶
                if (elements.loginBtn) {
                    elements.loginBtn.addEventListener('click', handleLogin);
                    console.log('âœ… ç™»å…¥æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
                } else {
                    console.warn('âŒ æ‰¾ä¸åˆ°ç™»å…¥æŒ‰éˆ•å…ƒç´ ');
                }
                
                if (elements.logoutBtn) {
                    elements.logoutBtn.addEventListener('click', handleLogout);
                    console.log('âœ… ç™»å‡ºæŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
                } else {
                    console.warn('âŒ æ‰¾ä¸åˆ°ç™»å‡ºæŒ‰éˆ•å…ƒç´ ');
                }
                
                if (elements.selectAllBtn) {
                    elements.selectAllBtn.addEventListener('click', selectAllUsers);
                }
                if (elements.deselectAllBtn) {
                    elements.deselectAllBtn.addEventListener('click', deselectAllUsers);
                }
                if (elements.retryFailedBtn) {
                    elements.retryFailedBtn.addEventListener('click', retryFailedUsers);
                }

                // ç®¡ç†Steamé€£çµæŒ‰éˆ•
                const manageSteamBtn = document.getElementById('manageSteamBtn');
                if (manageSteamBtn) {
                    manageSteamBtn.addEventListener('click', showSteamLinkModal);
                }
                
                // æ¸¬è©¦Steam URLæŒ‰éˆ•ï¼ˆé–‹ç™¼ç”¨ï¼‰
                const testSteamBtn = document.getElementById('testSteamBtn');
                if (testSteamBtn) {
                    testSteamBtn.addEventListener('click', showSteamTestModal);
                }
                
                // æ¸…ç†é‡è¤‡ç”¨æˆ¶æŒ‰éˆ•
                const cleanDuplicatesBtn = document.getElementById('cleanDuplicatesBtn');
                if (cleanDuplicatesBtn) {
                    cleanDuplicatesBtn.addEventListener('click', cleanDuplicateUsers);
                }
                
                // å¼·åˆ¶ç™»å‡ºæŒ‰éˆ•ï¼ˆå‚™ç”¨ï¼‰
                const forceLogoutBtn = document.getElementById('forceLogoutBtn');
                if (forceLogoutBtn) {
                    forceLogoutBtn.addEventListener('click', forceLogout);
                }

                // å¹«åŠ©æŒ‰éˆ•
                const helpBtn = document.getElementById('helpBtn');
                if (helpBtn) {
                    helpBtn.addEventListener('click', showHelpModal);
                }

                // æœå°‹å’Œæ’åº
                if (elements.searchInput) {
                    elements.searchInput.addEventListener('input', debounce(handleSearchInput, 300));
                }
                if (elements.sortSelect) {
                    elements.sortSelect.addEventListener('change', function(e) {
                        currentSort = e.target.value;
                        sortGames();
                    });
                }

                // æ¸…é™¤æœå°‹
                const clearSearchBtn = document.getElementById('clearSearch');
                if (clearSearchBtn) {
                    clearSearchBtn.addEventListener('click', clearSearch);
                }

                // å¿«é€Ÿæ“ä½œæŒ‰éˆ•
                const quickCommonBtn = document.getElementById('quickCommonBtn');
                const quickPopularBtn = document.getElementById('quickPopularBtn');
                const quickResetBtn = document.getElementById('quickResetBtn');
                const clearCacheBtn = document.getElementById('clearCacheBtn');
                const reloadBtn = document.getElementById('reloadBtn');
                const exportBtn = document.getElementById('exportBtn');

                if (quickCommonBtn) {
                    quickCommonBtn.addEventListener('click', () => setQuickFilter('common'));
                }
                if (quickPopularBtn) {
                    quickPopularBtn.addEventListener('click', () => setQuickFilter('popular'));
                }
                if (quickResetBtn) {
                    quickResetBtn.addEventListener('click', resetAllFilters);
                }
                if (clearCacheBtn) {
                    clearCacheBtn.addEventListener('click', clearGameDataCache);
                }
                if (reloadBtn) {
                    reloadBtn.addEventListener('click', () => reloadGameData(true));
                }
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportGameList);
                }

                // ç¯©é¸æŒ‰éˆ•
                document.querySelectorAll('.filter-tag').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        currentFilter = e.target.dataset.filter;
                        filterGames();
                    });
                });

                // éµç›¤å¿«æ·éµ
                document.addEventListener('keydown', handleKeyboardShortcuts);

                // Supabase èªè­‰ç‹€æ…‹ç›£è½ - ä¿®å¾©é‡è¤‡è§¸ç™¼
                if (supabase && !authInitialized) {
                    authInitialized = true;
                    let lastEvent = null;
                    let lastEventTime = 0;
                    let isProcessingAuth = false;
                    
                    console.log('ğŸ”— è¨­ç½®Supabaseèªè­‰ç›£è½å™¨...');
                    
                    supabase.auth.onAuthStateChange(async (event, session) => {
                        const currentTime = Date.now();
                        
                        // é˜²æ­¢é‡è¤‡äº‹ä»¶ï¼ˆ1ç§’å…§çš„é‡è¤‡äº‹ä»¶ï¼‰
                        if (event === lastEvent && (currentTime - lastEventTime) < 1000) {
                            console.log(`â­ï¸ è·³éé‡è¤‡èªè­‰äº‹ä»¶: ${event}`);
                            return;
                        }
                        
                        // é˜²æ­¢è™•ç†ä¸­çš„é‡è¤‡èª¿ç”¨
                        if (isProcessingAuth) {
                            console.log(`ğŸ”„ èªè­‰è™•ç†ä¸­ï¼Œè·³é: ${event}`);
                            return;
                        }
                        
                        lastEvent = event;
                        lastEventTime = currentTime;
                        isProcessingAuth = true;
                        
                        console.log(`ğŸ” èªè­‰ç‹€æ…‹è®ŠåŒ–: ${event}`);
                        
                        try {
                            if (event === 'SIGNED_IN' && session) {
                                currentUser = session.user;
                                console.log(`ğŸ‘¤ ç”¨æˆ¶ç™»å…¥: ${currentUser.user_metadata?.full_name || currentUser.email}`);
                                updateAuthInterface(true);
                                
                                // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è¨­ç½®Steam ID
                                const hasExistingSteamId = await checkUserSteamId(currentUser.id);
                                if (!hasExistingSteamId) {
                                    console.log('ğŸ® ç”¨æˆ¶æœªè¨­ç½®Steam IDï¼Œé¡¯ç¤ºé€£çµå½ˆçª—');
                                    showSteamLinkModal();
                                } else {
                                    console.log('âœ… ç”¨æˆ¶å·²æœ‰Steam IDï¼Œè¼‰å…¥ç”¨æˆ¶åˆ—è¡¨');
                                    await loadUsers();
                                    showNotification('æ­¡è¿å›ä¾†ï¼', 'success');
                                }
                            } else if (event === 'SIGNED_OUT') {
                                console.log('ğŸ‘‹ ç”¨æˆ¶ç™»å‡º');
                                currentUser = null;
                                updateAuthInterface(false);
                                selectedUsers = [];
                                failedUsers = [];
                                gameDataCache.clear();
                                await loadUsers(); // é‡ç½®ç‚ºå…±äº«å¸³è™Ÿæ¨¡å¼
                            } else if (event === 'TOKEN_REFRESHED') {
                                console.log('ğŸ”„ Tokenå·²åˆ·æ–°');
                                // Tokenåˆ·æ–°ä¸éœ€è¦ç‰¹æ®Šè™•ç†
                            } else {
                                console.log(`â„¹ï¸ å…¶ä»–èªè­‰äº‹ä»¶: ${event}`);
                            }
                        } catch (error) {
                            console.error('âŒ è™•ç†èªè­‰ç‹€æ…‹è®ŠåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                            ErrorLogger.log(new AppError('èªè­‰ç‹€æ…‹è™•ç†å¤±æ•—', 'auth', error));
                        } finally {
                            isProcessingAuth = false;
                        }
                    });
                }

                console.log('âœ… äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
            } catch (error) {
                console.error('âŒ è¨­ç½®äº‹ä»¶ç›£è½å™¨å¤±æ•—:', error);
                ErrorLogger.log(new AppError('è¨­ç½®äº‹ä»¶ç›£è½å™¨å¤±æ•—', 'initialization', error));
            }
        }

        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è¨­ç½®Steam ID
        async function checkUserSteamId(discordUserId) {
            try {
                if (!supabase) return false;
                
                const { data: user, error } = await supabase
                    .from('users')
                    .select('steam_id')
                    .eq('discord_id', discordUserId)
                    .maybeSingle();
                
                if (error && error.code !== '42501') {
                    console.error('æª¢æŸ¥ç”¨æˆ¶Steam IDå¤±æ•—:', error);
                    return false;
                }
                
                return user && user.steam_id && user.steam_id.trim() !== '';
            } catch (error) {
                console.error('æª¢æŸ¥ç”¨æˆ¶Steam IDç•°å¸¸:', error);
                return false;
            }
        }

        // é¡¯ç¤ºSteamé€£çµè¼¸å…¥å½ˆçª—
        function showSteamLinkModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            modal.id = 'steamLinkModal';
            
            modal.innerHTML = `
                <div class="glass-effect rounded-xl max-w-md w-full">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 0C8.74 0 5.73 1.22 3.46 3.25L7.5 7.29c.41-.41.97-.67 1.58-.67 1.24 0 2.25 1.01 2.25 2.25 0 .61-.26 1.17-.67 1.58l4.04 4.04C16.78 12.27 18 9.26 18 6c0-3.31-2.69-6-6-6z"/>
                                    <path d="M6 12c0 3.31 2.69 6 6 6s6-2.69 6-6c0-.34-.03-.68-.08-1.01L14.71 7.78C14.42 7.92 14.1 8 13.75 8c-1.24 0-2.25-1.01-2.25-2.25 0-.35.08-.67.22-.96L7.5 0.57C6.61 0.2 5.64 0 4.64 0 2.08 0 0 2.08 0 4.64c0 1 .2 1.97.57 2.86L4.79 11.72c.29-.14.61-.22.96-.22 1.24 0 2.25 1.01 2.25 2.25z"/>
                                </svg>
                            </div>
                            <h2 class="text-xl font-bold text-white mb-2">é€£çµä½ çš„Steamå¸³è™Ÿ</h2>
                            <p class="text-slate-400 text-sm">è«‹æä¾›ä½ çš„Steamå€‹äººè³‡æ–™é é¢é€£çµï¼Œé€™æ¨£æˆ‘å€‘å°±èƒ½å¹«ä½ æ‰¾åˆ°èˆ‡Discordç¾¤çµ„æˆå“¡çš„å…±åŒéŠæˆ²ï¼</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Steamå€‹äººè³‡æ–™é€£çµ</label>
                                <input type="url" id="steamUrlInput" 
                                       placeholder="https://steamcommunity.com/profiles/... æˆ– https://steamcommunity.com/id/..." 
                                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <div class="mt-2 text-xs text-slate-400">
                                    æ”¯æ´æ ¼å¼ï¼š
                                    <br>â€¢ https://steamcommunity.com/profiles/76561198123456789
                                    <br>â€¢ https://steamcommunity.com/id/your-custom-name
                                </div>
                            </div>
                            
                            <div id="steamUrlError" class="hidden bg-red-600/20 border border-red-500/30 rounded-lg p-3">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="text-red-400 text-sm" id="steamUrlErrorText"></span>
                                </div>
                            </div>
                            
                            <div id="steamUrlSuccess" class="hidden bg-green-600/20 border border-green-500/30 rounded-lg p-3">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="text-green-400 text-sm" id="steamUrlSuccessText"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mt-6">
                            <button id="confirmSteamLink" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="btn-text">ç¢ºèªé€£çµ</span>
                                <span class="btn-loading hidden">
                                    <svg class="animate-spin w-4 h-4 mx-auto" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                            <button id="skipSteamLink" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white transition-colors">
                                ç¨å¾Œè¨­ç½®
                            </button>
                        </div>
                        
                        <div class="mt-4 p-3 bg-slate-700/30 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <svg class="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                                <div class="text-xs text-slate-400">
                                    <div class="font-medium mb-1">ç‚ºä»€éº¼éœ€è¦Steamé€£çµï¼Ÿ</div>
                                    <div>æˆ‘å€‘éœ€è¦è¨ªå•ä½ çš„SteaméŠæˆ²åº«ä¾†æ‰¾å‡ºç¾¤çµ„ä¸­æ‰€æœ‰äººéƒ½æ“æœ‰çš„éŠæˆ²ã€‚è«‹ç¢ºä¿ä½ çš„Steamå€‹äººè³‡æ–™å’ŒéŠæˆ²è©³æƒ…è¨­ç‚ºã€Œå…¬é–‹ã€ã€‚</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const urlInput = modal.querySelector('#steamUrlInput');
            const confirmBtn = modal.querySelector('#confirmSteamLink');
            const skipBtn = modal.querySelector('#skipSteamLink');
            const errorDiv = modal.querySelector('#steamUrlError');
            const errorText = modal.querySelector('#steamUrlErrorText');
            const successDiv = modal.querySelector('#steamUrlSuccess');
            const successText = modal.querySelector('#steamUrlSuccessText');
            
            let validatedSteamId = null;
            
            // å³æ™‚é©—è­‰è¼¸å…¥
            urlInput.addEventListener('input', debounce(async () => {
                const url = urlInput.value.trim();
                if (!url) {
                    hideValidationMessages();
                    return;
                }
                
                try {
                    validatedSteamId = await parseSteamUrl(url);
                    showSuccess(`æˆåŠŸè§£æSteam ID: ${validatedSteamId}`);
                } catch (error) {
                    showError(error.message);
                    validatedSteamId = null;
                }
            }, 1000));
            
            // ç¢ºèªæŒ‰éˆ•
            confirmBtn.addEventListener('click', async () => {
                const url = urlInput.value.trim();
                if (!url) {
                    showError('è«‹è¼¸å…¥Steamå€‹äººè³‡æ–™é€£çµ');
                    return;
                }
                
                setLoading(true);
                
                try {
                    let steamId = validatedSteamId;
                    if (!steamId) {
                        steamId = await parseSteamUrl(url);
                    }
                    
                    await saveSteamIdToDatabase(steamId, url);
                    
                    document.body.removeChild(modal);
                    showNotification('Steamå¸³è™Ÿé€£çµæˆåŠŸï¼æ­£åœ¨è¼‰å…¥éŠæˆ²è³‡æ–™...', 'success');
                    
                    // é‡æ–°è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨ï¼ˆç¢ºä¿ä¸é‡è¤‡ï¼‰
                    await loadUsers();
                    
                } catch (error) {
                    showError(error.message);
                    ErrorLogger.log(error);
                } finally {
                    setLoading(false);
                }
            });
            
            // è·³éæŒ‰éˆ•
            skipBtn.addEventListener('click', async () => {
                document.body.removeChild(modal);
                showNotification('ä½ å¯ä»¥ç¨å¾Œåœ¨è¨­å®šä¸­é€£çµSteamå¸³è™Ÿ', 'info');
                
                // å³ä½¿è·³éä¹Ÿè¦è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
                await loadUsers();
            });
            
            // Enteréµç¢ºèª
            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !confirmBtn.disabled) {
                    confirmBtn.click();
                }
            });
            
            // è¼”åŠ©å‡½æ•¸
            function showError(message) {
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
                confirmBtn.disabled = true;
            }
            
            function showSuccess(message) {
                successText.textContent = message;
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                confirmBtn.disabled = false;
            }
            
            function hideValidationMessages() {
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
                confirmBtn.disabled = false;
            }
            
            function setLoading(loading) {
                const btnText = confirmBtn.querySelector('.btn-text');
                const btnLoading = confirmBtn.querySelector('.btn-loading');
                
                if (loading) {
                    btnText.classList.add('hidden');
                    btnLoading.classList.remove('hidden');
                    confirmBtn.disabled = true;
                    skipBtn.disabled = true;
                } else {
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                    confirmBtn.disabled = false;
                    skipBtn.disabled = false;
                }
            }
            
            // è‡ªå‹•èšç„¦è¼¸å…¥æ¡†
            setTimeout(() => urlInput.focus(), 100);
        }

        // ä¿å­˜Steam IDåˆ°è³‡æ–™åº«
        async function saveSteamIdToDatabase(steamId, steamUrl) {
            try {
                if (!supabase || !currentUser) {
                    throw new AppError('ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«', 'database');
                }
                
                console.log(`ä¿å­˜Steam IDåˆ°è³‡æ–™åº«: ${steamId}, URL: ${steamUrl}`);
                
                const userData = {
                    discord_id: currentUser.id,
                    username: currentUser.user_metadata?.full_name || currentUser.email || 'Discord User',
                    avatar_url: currentUser.user_metadata?.avatar_url || null,
                    steam_id: steamId,
                    steam_profile_url: steamUrl,
                    is_shared: false,
                    game_count: 0,
                    total_playtime: 0
                };
                
                console.log('æº–å‚™ä¿å­˜çš„ç”¨æˆ¶è³‡æ–™:', userData);
                
                // å˜—è©¦æ’å…¥æˆ–æ›´æ–°ç”¨æˆ¶è¨˜éŒ„
                const { data, error } = await supabase
                    .from('users')
                    .upsert(userData, { 
                        onConflict: 'discord_id',
                        ignoreDuplicates: false 
                    })
                    .select()
                    .single();
                
                if (error) {
                    if (error.code === '42501' || error.message.includes('RLS')) {
                        console.warn('RLSæ”¿ç­–é™åˆ¶ï¼Œä½†Steam IDå·²è¨˜éŒ„åœ¨æœ¬åœ°');
                        // å³ä½¿è³‡æ–™åº«ä¿å­˜å¤±æ•—ï¼Œä¹Ÿå°‡ç”¨æˆ¶ä¿¡æ¯æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨
                        addUserToLocalList(userData);
                        showNotification('Steamé€£çµå·²ä¿å­˜ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰', 'warning');
                        return;
                    }
                    throw new AppError(`è³‡æ–™åº«ä¿å­˜å¤±æ•—: ${error.message}`, 'database', error);
                }
                
                console.log('Steam IDä¿å­˜æˆåŠŸåˆ°è³‡æ–™åº«:', data);
                showNotification('Steamé€£çµå·²æˆåŠŸä¿å­˜åˆ°è³‡æ–™åº«', 'success');
                
                // é©—è­‰ä¿å­˜çµæœ
                await verifySteamIdSaved(steamId);
                
            } catch (error) {
                console.error('ä¿å­˜Steam IDæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                
                if (error.type === 'database' && (error.message.includes('RLS') || error.message.includes('42501'))) {
                    // RLSéŒ¯èª¤æ™‚ï¼Œæ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨
                    addUserToLocalList({
                        id: steamId,
                        name: currentUser.user_metadata?.full_name || currentUser.email || 'Discord User',
                        avatar: currentUser.user_metadata?.avatar_url,
                        gameCount: 0,
                        isShared: false,
                        discordId: currentUser.id,
                        steamProfileUrl: steamUrl
                    });
                    showNotification('Steamé€£çµå·²ä¿å­˜ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰', 'warning');
                    return;
                }
                throw error;
            }
        }
        
        // é©—è­‰Steam IDæ˜¯å¦æ­£ç¢ºä¿å­˜
        async function verifySteamIdSaved(steamId) {
            try {
                if (!supabase || !currentUser) return;
                
                const { data: user, error } = await supabase
                    .from('users')
                    .select('steam_id, steam_profile_url, username')
                    .eq('discord_id', currentUser.id)
                    .single();
                
                if (error && error.code !== '42501') {
                    console.warn('é©—è­‰Steam IDä¿å­˜å¤±æ•—:', error);
                    return;
                }
                
                if (user && user.steam_id === steamId) {
                    console.log('âœ… Steam IDé©—è­‰æˆåŠŸ:', {
                        username: user.username,
                        steam_id: user.steam_id,
                        steam_profile_url: user.steam_profile_url
                    });
                } else {
                    console.warn('âš ï¸ Steam IDé©—è­‰å¤±æ•—ï¼Œå¯èƒ½ä¿å­˜ä¸å®Œæ•´');
                }
                
            } catch (error) {
                console.warn('é©—è­‰Steam IDæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // æ·»åŠ ç”¨æˆ¶åˆ°æœ¬åœ°åˆ—è¡¨ï¼ˆæ”¹é€²å»é‡é‚è¼¯ï¼‰
        function addUserToLocalList(userData) {
            console.log('â• æ·»åŠ ç”¨æˆ¶åˆ°æœ¬åœ°åˆ—è¡¨:', userData.name);
            
            const userForList = {
                id: userData.steam_id || userData.id,
                name: userData.username || userData.name,
                avatar: userData.avatar_url || userData.avatar,
                gameCount: userData.game_count || userData.gameCount || 0,
                totalPlaytime: userData.total_playtime || userData.totalPlaytime || 0,
                isShared: userData.is_shared || userData.isShared || false,
                discordId: userData.discord_id || userData.discordId,
                steamProfileUrl: userData.steam_profile_url || userData.steamProfileUrl,
                isCurrentUser: userData.discord_id === currentUser?.id || userData.discordId === currentUser?.id
            };
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ”¹é€²æª¢æŸ¥é‚è¼¯ï¼‰
            const existingIndex = allUsers.findIndex(u => 
                u.id === userForList.id || 
                (u.discordId && u.discordId === userForList.discordId)
            );
            
            if (existingIndex !== -1) {
                // æ›´æ–°ç¾æœ‰ç”¨æˆ¶ï¼Œåˆä½µæ›´å®Œæ•´çš„ä¿¡æ¯
                const existing = allUsers[existingIndex];
                allUsers[existingIndex] = {
                    ...existing,
                    ...userForList,
                    // ä¿ç•™æ›´å¤§çš„å€¼
                    gameCount: Math.max(existing.gameCount || 0, userForList.gameCount || 0),
                    totalPlaytime: Math.max(existing.totalPlaytime || 0, userForList.totalPlaytime || 0),
                    // ä¿ç•™æ›´å®Œæ•´çš„ä¿¡æ¯
                    steamProfileUrl: userForList.steamProfileUrl || existing.steamProfileUrl,
                    avatar: userForList.avatar || existing.avatar
                };
                console.log('âœï¸ å·²æ›´æ–°æœ¬åœ°ç”¨æˆ¶:', allUsers[existingIndex].name);
            } else {
                // ä¸å­˜åœ¨æ‰æ·»åŠ 
                allUsers.push(userForList);
                console.log('âœ… å·²æ·»åŠ æ–°ç”¨æˆ¶åˆ°æœ¬åœ°åˆ—è¡¨:', userForList.name);
            }
            
            // ä¸å†åœ¨é€™è£¡èª¿ç”¨removeDuplicateUsersï¼Œç”±loadUsersçµ±ä¸€è™•ç†
        }
        function showSteamTestModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="glass-effect rounded-xl max-w-lg w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-bold text-white">Steam URL æ¸¬è©¦å·¥å…·</h2>
                            <button class="text-slate-400 hover:text-white close-modal">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">æ¸¬è©¦Steam URL</label>
                                <input type="url" id="testSteamUrlInput" 
                                       placeholder="è¼¸å…¥Steamå€‹äººè³‡æ–™é€£çµ..." 
                                       class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button id="testDirectUrl" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                    æ¸¬è©¦ç›´æ¥ID
                                </button>
                                <button id="testCustomUrl" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                                    æ¸¬è©¦è‡ªå®šç¾©URL
                                </button>
                            </div>
                            
                            <div id="testResults" class="hidden bg-slate-700/50 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-slate-300 mb-2">æ¸¬è©¦çµæœ</h3>
                                <div id="testOutput" class="text-xs text-slate-400 font-mono whitespace-pre-wrap"></div>
                            </div>
                            
                            <div class="bg-slate-700/30 rounded-lg p-3">
                                <h3 class="text-sm font-medium text-slate-300 mb-2">æ¸¬è©¦ç¯„ä¾‹</h3>
                                <div class="space-y-1 text-xs text-slate-400">
                                    <div>ç›´æ¥ID: https://steamcommunity.com/profiles/76561198123456789</div>
                                    <div>è‡ªå®šç¾©URL: https://steamcommunity.com/id/your-custom-name</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button class="w-full bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors close-modal">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const urlInput = modal.querySelector('#testSteamUrlInput');
            const testDirectBtn = modal.querySelector('#testDirectUrl');
            const testCustomBtn = modal.querySelector('#testCustomUrl');
            const testResults = modal.querySelector('#testResults');
            const testOutput = modal.querySelector('#testOutput');
            
            // é å¡«ä¸€äº›æ¸¬è©¦URL
            const testUrls = [
                'https://steamcommunity.com/profiles/76561198123456789',
                'https://steamcommunity.com/id/gabelogannewell'
            ];
            
            testDirectBtn.addEventListener('click', () => {
                urlInput.value = testUrls[0];
                runTest();
            });
            
            testCustomBtn.addEventListener('click', () => {
                urlInput.value = testUrls[1];
                runTest();
            });
            
            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    runTest();
                }
            });
            
            async function runTest() {
                const url = urlInput.value.trim();
                if (!url) return;
                
                testResults.classList.remove('hidden');
                testOutput.textContent = 'æ­£åœ¨æ¸¬è©¦...\n';
                
                try {
                    testOutput.textContent += `è¼¸å…¥URL: ${url}\n`;
                    testOutput.textContent += `é–‹å§‹è§£æ...\n`;
                    
                    const steamId = await parseSteamUrl(url);
                    
                    testOutput.textContent += `âœ… è§£ææˆåŠŸï¼\n`;
                    testOutput.textContent += `Steam ID: ${steamId}\n`;
                    testOutput.textContent += `é©—è­‰Steam IDæ ¼å¼: ${validateSteamId(steamId) ? 'âœ… æœ‰æ•ˆ' : 'âŒ ç„¡æ•ˆ'}\n`;
                    
                    // å¦‚æœç•¶å‰ç”¨æˆ¶å·²ç™»å…¥ï¼Œå¯ä»¥é¸æ“‡ä¿å­˜
                    if (currentUser) {
                        testOutput.textContent += `\nå¯ä»¥ä¿å­˜åˆ°è³‡æ–™åº« (å·²ç™»å…¥)\n`;
                    } else {
                        testOutput.textContent += `\néœ€è¦ç™»å…¥æ‰èƒ½ä¿å­˜åˆ°è³‡æ–™åº«\n`;
                    }
                    
                } catch (error) {
                    testOutput.textContent += `âŒ è§£æå¤±æ•—: ${error.message}\n`;
                    testOutput.textContent += `éŒ¯èª¤é¡å‹: ${error.type || 'unknown'}\n`;
                    
                    if (error.details) {
                        testOutput.textContent += `è©³ç´°ä¿¡æ¯: ${JSON.stringify(error.details, null, 2)}\n`;
                    }
                }
            }
            
            // é—œé–‰å½ˆçª—
            modal.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            setTimeout(() => urlInput.focus(), 100);
        }
        function addUserToLocalList(userData) {
            const userForList = {
                id: userData.steam_id || userData.id,
                name: userData.username || userData.name,
                avatar: userData.avatar_url || userData.avatar,
                gameCount: userData.game_count || userData.gameCount || 0,
                isShared: userData.is_shared || userData.isShared || false,
                discordId: userData.discord_id || userData.discordId
            };
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingIndex = allUsers.findIndex(u => u.id === userForList.id);
            if (existingIndex !== -1) {
                allUsers[existingIndex] = userForList;
            } else {
                allUsers.push(userForList);
            }
            
            console.log('å·²æ·»åŠ ç”¨æˆ¶åˆ°æœ¬åœ°åˆ—è¡¨:', userForList);
        }
        async function checkAuth() {
            try {
                if (!supabase) return;
                
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    updateAuthInterface(true);
                    console.log('ç”¨æˆ¶å·²ç™»å…¥:', currentUser.user_metadata?.full_name);
                }
            } catch (error) {
                ErrorLogger.log(new AppError('æª¢æŸ¥èªè­‰ç‹€æ…‹å¤±æ•—', 'auth', error));
            }
        }

        // ç™»å…¥è™•ç†
        async function handleLogin() {
            try {
                if (!supabase) {
                    throw new AppError('èªè­‰æœå‹™æœªæº–å‚™å°±ç·’', 'auth');
                }

                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'discord',
                    options: {
                        redirectTo: window.location.href
                    }
                });

                if (error) {
                    throw new AppError('ç™»å…¥å¤±æ•—', 'auth', error);
                }
            } catch (error) {
                ErrorLogger.log(error);
                showNotification(error.message, 'error');
            }
        }

        // ç™»å‡ºè™•ç†
        async function handleLogout() {
            try {
                console.log('é–‹å§‹ç™»å‡ºè™•ç†...');
                
                if (!supabase) {
                    console.error('Supabase æœªåˆå§‹åŒ–');
                    showNotification('ç™»å‡ºå¤±æ•—ï¼šæœå‹™æœªæº–å‚™å°±ç·’', 'error');
                    return;
                }

                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                const logoutBtn = elements.logoutBtn;
                if (logoutBtn) {
                    logoutBtn.disabled = true;
                    logoutBtn.textContent = 'ç™»å‡ºä¸­...';
                }

                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    console.error('Supabase ç™»å‡ºéŒ¯èª¤:', error);
                    throw new AppError('ç™»å‡ºå¤±æ•—', 'auth', error);
                } else {
                    console.log('ç™»å‡ºæˆåŠŸ');
                    showNotification('å·²æˆåŠŸç™»å‡º', 'success');
                }
            } catch (error) {
                console.error('ç™»å‡ºè™•ç†å¤±æ•—:', error);
                ErrorLogger.log(error);
                showNotification(`ç™»å‡ºå¤±æ•—: ${error.message}`, 'error');
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const logoutBtn = elements.logoutBtn;
                if (logoutBtn) {
                    logoutBtn.disabled = false;
                    logoutBtn.textContent = 'ç™»å‡º';
                }
            }
        }

        // æ›´æ–°èªè­‰ç•Œé¢
        function updateAuthInterface(isLoggedIn) {
            try {
                console.log(`ğŸ”„ æ›´æ–°èªè­‰ç•Œé¢: ${isLoggedIn ? 'å·²ç™»å…¥' : 'æœªç™»å…¥'}`);
                
                if (isLoggedIn && currentUser) {
                    // å·²ç™»å…¥ç‹€æ…‹
                    if (elements.loginBtn) {
                        elements.loginBtn.classList.add('hidden');
                        console.log('âœ… éš±è—ç™»å…¥æŒ‰éˆ•');
                    }
                    
                    if (elements.logoutBtn) {
                        elements.logoutBtn.classList.remove('hidden');
                        elements.logoutBtn.disabled = false;
                        elements.logoutBtn.textContent = 'ç™»å‡º';
                        console.log('âœ… é¡¯ç¤ºç™»å‡ºæŒ‰éˆ•');
                    } else {
                        console.warn('âŒ æ‰¾ä¸åˆ°ç™»å‡ºæŒ‰éˆ•å…ƒç´ ');
                    }
                    
                    if (elements.userInfo) {
                        elements.userInfo.classList.remove('hidden');
                        elements.userInfo.classList.add('flex');
                    }
                    
                    if (elements.userAvatar) {
                        elements.userAvatar.src = currentUser.user_metadata?.avatar_url || 'https://ui-avatars.com/api/?name=User';
                    }
                    
                    if (elements.userName) {
                        elements.userName.textContent = currentUser.user_metadata?.full_name || currentUser.email || 'User';
                    }
                    
                    console.log(`ğŸ‘¤ ç”¨æˆ¶ç•Œé¢å·²æ›´æ–°: ${currentUser.user_metadata?.full_name || currentUser.email}`);
                } else {
                    // æœªç™»å…¥ç‹€æ…‹
                    if (elements.loginBtn) {
                        elements.loginBtn.classList.remove('hidden');
                        console.log('âœ… é¡¯ç¤ºç™»å…¥æŒ‰éˆ•');
                    }
                    
                    if (elements.logoutBtn) {
                        elements.logoutBtn.classList.add('hidden');
                        elements.logoutBtn.disabled = false;
                        elements.logoutBtn.textContent = 'ç™»å‡º';
                        console.log('âœ… éš±è—ç™»å‡ºæŒ‰éˆ•');
                    }
                    
                    if (elements.userInfo) {
                        elements.userInfo.classList.add('hidden');
                        elements.userInfo.classList.remove('flex');
                    }
                    
                    console.log('ğŸ‘‹ ç”¨æˆ¶ç•Œé¢å·²é‡ç½®ç‚ºæœªç™»å…¥ç‹€æ…‹');
                }
                
                // åŒæ™‚æ›´æ–°ç®¡ç†æŒ‰éˆ•çš„é¡¯ç¤º
                const manageSteamBtn = document.getElementById('manageSteamBtn');
                if (manageSteamBtn) {
                    if (isLoggedIn) {
                        manageSteamBtn.classList.remove('hidden');
                    } else {
                        manageSteamBtn.classList.add('hidden');
                    }
                }
                
            } catch (error) {
                console.error('âŒ æ›´æ–°èªè­‰ç•Œé¢å¤±æ•—:', error);
                ErrorLogger.log(new AppError('æ›´æ–°èªè­‰ç•Œé¢å¤±æ•—', 'ui', error));
            }
        }

        // è¼‰å…¥ç”¨æˆ¶
        async function loadUsers() {
            try {
                console.log('ğŸ“‹ é–‹å§‹è¼‰å…¥ç”¨æˆ¶...');
                
                // é‡ç½®å…±äº«å¸³è™Ÿçš„éŠæˆ²æ•¸é‡
                SHARED_ACCOUNTS.forEach(account => {
                    account.gameCount = 0;
                });
                
                // é‡æ–°åˆå§‹åŒ–ç”¨æˆ¶åˆ—è¡¨ï¼ŒåªåŒ…å«å…±äº«å¸³è™Ÿ
                allUsers = [...SHARED_ACCOUNTS];
                console.log(`ğŸ”§ åˆå§‹åŒ–ç”¨æˆ¶åˆ—è¡¨ï¼Œå…±äº«å¸³è™Ÿæ•¸: ${SHARED_ACCOUNTS.length}`);
                
                if (currentUser && supabase) {
                    try {
                        // è¼‰å…¥æ‰€æœ‰Discordç¾¤çµ„ç”¨æˆ¶ï¼ˆåŒ…æ‹¬ç•¶å‰ç”¨æˆ¶ï¼‰
                        const { data: users, error } = await supabase
                            .from('users')
                            .select('*')
                            .eq('is_shared', false)
                            .order('username');
                        
                        if (error) {
                            if (error.code === '42501' || error.message.includes('RLS')) {
                                console.warn('âš ï¸ RLSæ”¿ç­–é™åˆ¶ï¼Œåƒ…é¡¯ç¤ºå…±äº«å¸³è™Ÿ');
                                updateSystemStatus('database', 'warning');
                                
                                // å¦‚æœç•¶å‰ç”¨æˆ¶æœ‰Steam IDä½†ä¸åœ¨è³‡æ–™åº«ä¸­ï¼Œæ·»åŠ åˆ°æœ¬åœ°
                                if (currentUser.user_metadata?.steam_id) {
                                    const currentUserData = {
                                        id: currentUser.user_metadata.steam_id,
                                        name: currentUser.user_metadata.full_name || 'You',
                                        avatar: currentUser.user_metadata.avatar_url,
                                        gameCount: 0,
                                        isShared: false,
                                        discordId: currentUser.id,
                                        isCurrentUser: true
                                    };
                                    console.log('â• æ·»åŠ ç•¶å‰ç”¨æˆ¶åˆ°æœ¬åœ°åˆ—è¡¨');
                                    addUserToLocalList(currentUserData);
                                }
                            } else {
                                throw error;
                            }
                        } else if (users && users.length > 0) {
                            console.log(`ğŸ“Š å¾è³‡æ–™åº«è¼‰å…¥ ${users.length} å€‹Discordç”¨æˆ¶`);
                            
                            // éæ¿¾æœ‰æ•ˆç”¨æˆ¶ä¸¦å»é‡
                            const validUsers = users.filter(user => 
                                user.steam_id && user.steam_id.trim() !== ''
                            );
                            
                            console.log(`âœ… æœ‰æ•ˆç”¨æˆ¶æ•¸: ${validUsers.length}`);
                            
                            // ä½¿ç”¨ Map ä¾†ç¢ºä¿æ¯å€‹ steam_id åªå‡ºç¾ä¸€æ¬¡
                            const userMap = new Map();
                            
                            validUsers.forEach(user => {
                                const mappedUser = {
                                    id: user.steam_id,
                                    name: user.username,
                                    avatar: user.avatar_url,
                                    gameCount: user.game_count || 0,
                                    totalPlaytime: user.total_playtime || 0,
                                    isShared: false,
                                    discordId: user.discord_id,
                                    steamProfileUrl: user.steam_profile_url,
                                    isCurrentUser: user.discord_id === currentUser.id
                                };
                                
                                // ä½¿ç”¨ steam_id ä½œç‚º key ä¾†å»é‡
                                if (!userMap.has(user.steam_id)) {
                                    userMap.set(user.steam_id, mappedUser);
                                } else {
                                    console.warn(`âš ï¸ è³‡æ–™åº«ä¸­ç™¼ç¾é‡è¤‡Steam ID: ${user.steam_id}`);
                                }
                            });
                            
                            // å°‡å»é‡å¾Œçš„ç”¨æˆ¶æ·»åŠ åˆ°åˆ—è¡¨
                            const deduplicatedUsers = Array.from(userMap.values());
                            allUsers = [...allUsers, ...deduplicatedUsers];
                            
                            console.log(`âœ… è³‡æ–™åº«å»é‡å¾Œçš„Discordç”¨æˆ¶æ•¸é‡: ${deduplicatedUsers.length}`);
                            updateSystemStatus('database', 'connected');
                        }
                    } catch (dbError) {
                        ErrorLogger.log(new AppError('è¼‰å…¥Discordç¾¤çµ„ç”¨æˆ¶å¤±æ•—', 'database', dbError));
                        console.warn('âŒ ç„¡æ³•è¼‰å…¥Discordç¾¤çµ„ç”¨æˆ¶ï¼Œåƒ…ä½¿ç”¨å…±äº«å¸³è™Ÿ');
                        updateSystemStatus('database', 'error');
                    }
                }
                
                // æœ€çµ‚å»é‡æª¢æŸ¥ï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰
                const beforeFinalCount = allUsers.length;
                allUsers = removeDuplicateUsers(allUsers);
                const afterFinalCount = allUsers.length;
                
                if (beforeFinalCount !== afterFinalCount) {
                    console.log(`ğŸ”„ æœ€çµ‚å»é‡: ${beforeFinalCount} -> ${afterFinalCount}`);
                }
                
                updateUserInterface();
                console.log(`âœ… ç”¨æˆ¶è¼‰å…¥å®Œæˆï¼Œç¸½ç”¨æˆ¶æ•¸: ${allUsers.length}`);
                
                // é¡¯ç¤ºç¾¤çµ„çµ±è¨ˆ
                const discordUsers = allUsers.filter(u => !u.isShared);
                if (discordUsers.length > 0) {
                    showNotification(`å·²è¼‰å…¥ ${discordUsers.length} å€‹Discordç¾¤çµ„æˆå“¡`, 'success');
                }
                
            } catch (error) {
                ErrorLogger.log(new AppError('è¼‰å…¥ç”¨æˆ¶å¤±æ•—', 'general', error));
                showNotification('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—', 'error');
                console.error('âŒ è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', error);
            }
        }
        
        // å¼·åˆ¶ç™»å‡ºï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
        async function forceLogout() {
            try {
                console.log('ğŸš¨ åŸ·è¡Œå¼·åˆ¶ç™»å‡º...');
                
                // æ¸…é™¤æœ¬åœ°ç‹€æ…‹
                currentUser = null;
                selectedUsers = [];
                failedUsers = [];
                gameDataCache.clear();
                ErrorLogger.clear();
                
                // å¼·åˆ¶æ›´æ–°ç•Œé¢
                updateAuthInterface(false);
                
                // é‡ç½®ç‚ºå…±äº«å¸³è™Ÿæ¨¡å¼
                await loadUsers();
                
                // å¦‚æœSupabaseå¯ç”¨ï¼Œå˜—è©¦åŸ·è¡Œç™»å‡º
                if (supabase) {
                    try {
                        await supabase.auth.signOut();
                        console.log('âœ… Supabase ç™»å‡ºæˆåŠŸ');
                    } catch (error) {
                        console.warn('âš ï¸ Supabase ç™»å‡ºå¤±æ•—ï¼Œä½†æœ¬åœ°ç‹€æ…‹å·²æ¸…é™¤:', error);
                    }
                }
                
                // æ¸…é™¤å¯èƒ½çš„session storage
                try {
                    if (typeof Storage !== 'undefined') {
                        sessionStorage.clear();
                        localStorage.removeItem('supabase.auth.token');
                    }
                } catch (error) {
                    console.warn('æ¸…é™¤æœ¬åœ°å­˜å„²å¤±æ•—:', error);
                }
                
                showNotification('å·²å¼·åˆ¶ç™»å‡ºä¸¦é‡ç½®ç‹€æ…‹', 'success');
                console.log('âœ… å¼·åˆ¶ç™»å‡ºå®Œæˆ');
                
            } catch (error) {
                console.error('âŒ å¼·åˆ¶ç™»å‡ºå¤±æ•—:', error);
                showNotification('å¼·åˆ¶ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }
        function cleanDuplicateUsers() {
            const originalCount = allUsers.length;
            allUsers = removeDuplicateUsers(allUsers);
            const newCount = allUsers.length;
            const removedCount = originalCount - newCount;
            
            updateUserInterface();
            
            if (removedCount > 0) {
                showNotification(`æˆåŠŸæ¸…ç† ${removedCount} å€‹é‡è¤‡ç”¨æˆ¶`, 'success');
            } else {
                showNotification('æ²’æœ‰ç™¼ç¾é‡è¤‡ç”¨æˆ¶', 'info');
            }
            
            console.log(`æ¸…ç†é‡è¤‡ç”¨æˆ¶: ${originalCount} -> ${newCount} (ç§»é™¤ ${removedCount} å€‹)`);
        }
        function removeDuplicateUsers(users) {
            const userMap = new Map();
            const duplicates = [];
            
            users.forEach(user => {
                if (userMap.has(user.id)) {
                    duplicates.push(user.id);
                    console.warn(`ç™¼ç¾é‡è¤‡ç”¨æˆ¶: ${user.name} (${user.id})`);
                    
                    // ä¿ç•™æ›´å®Œæ•´çš„ç”¨æˆ¶è³‡æ–™ï¼ˆæœ‰æ›´å¤šä¿¡æ¯çš„é‚£å€‹ï¼‰
                    const existing = userMap.get(user.id);
                    const current = user;
                    
                    // æ¯”è¼ƒä¸¦é¸æ“‡æ›´å®Œæ•´çš„ç”¨æˆ¶è³‡æ–™
                    if (current.gameCount > existing.gameCount || 
                        (current.steamProfileUrl && !existing.steamProfileUrl) ||
                        (current.totalPlaytime > existing.totalPlaytime)) {
                        userMap.set(user.id, current);
                        console.log(`ç”¨æ›´å®Œæ•´çš„è³‡æ–™æ›¿æ›ç”¨æˆ¶: ${user.name}`);
                    }
                } else {
                    userMap.set(user.id, user);
                }
            });
            
            if (duplicates.length > 0) {
                console.log(`ç§»é™¤äº† ${duplicates.length} å€‹é‡è¤‡ç”¨æˆ¶`);
                showNotification(`å·²ç§»é™¤ ${duplicates.length} å€‹é‡è¤‡ç”¨æˆ¶`, 'info');
            }
            
            return Array.from(userMap.values());
        }

        // æ›´æ–°ç”¨æˆ¶ç•Œé¢
        function updateUserInterface() {
            try {
                if (!elements.userList) return;
                
                elements.userList.innerHTML = '';
                
                allUsers.forEach(user => {
                    const userCard = createUserCard(user);
                    elements.userList.appendChild(userCard);
                });
                
                // æ›´æ–°é‡è©¦æŒ‰éˆ•é¡¯ç¤º
                if (elements.retryFailedBtn) {
                    if (failedUsers.length > 0) {
                        elements.retryFailedBtn.classList.remove('hidden');
                        elements.retryFailedBtn.textContent = `é‡è©¦å¤±æ•—ç”¨æˆ¶ (${failedUsers.length})`;
                    } else {
                        elements.retryFailedBtn.classList.add('hidden');
                    }
                }
                
                // æ›´æ–°ç®¡ç†Steamé€£çµæŒ‰éˆ•
                const manageSteamBtn = document.getElementById('manageSteamBtn');
                if (manageSteamBtn && currentUser) {
                    manageSteamBtn.classList.remove('hidden');
                }
                
                updateStats();
            } catch (error) {
                ErrorLogger.log(new AppError('æ›´æ–°ç”¨æˆ¶ç•Œé¢å¤±æ•—', 'ui', error));
            }
        }

        // å‰µå»ºç”¨æˆ¶å¡ç‰‡
        function createUserCard(user) {
            const isSelected = selectedUsers.some(u => u.id === user.id);
            const hasFailed = failedUsers.some(u => u.id === user.id);
            
            const card = document.createElement('div');
            card.className = `user-card p-4 rounded-lg border-2 cursor-pointer transition-all ${
                isSelected 
                    ? 'bg-blue-600/20 border-blue-400' 
                    : 'bg-slate-700/50 border-slate-600 hover:border-slate-500'
            } ${hasFailed ? 'error-indicator' : ''}`;
            
            const avatarUrl = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=475569&color=ffffff`;
            
            card.innerHTML = `
                <div class="flex flex-col items-center space-y-2">
                    <div class="relative">
                        <img src="${avatarUrl}" 
                             class="user-avatar w-12 h-12 rounded-full border-2 ${isSelected ? 'border-blue-400' : 'border-slate-500'}" 
                             alt="${escapeHtml(user.name)}"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=475569&color=ffffff'">
                        
                        ${isSelected ? `
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                                </svg>
                            </div>
                        ` : ''}
                        
                        ${hasFailed ? `
                            <div class="absolute -top-1 -left-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                                <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        ` : ''}
                        
                        ${user.isCurrentUser ? `
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-purple-500 rounded-full flex items-center justify-center">
                                <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="text-center">
                        <div class="text-sm font-medium truncate max-w-20" title="${escapeHtml(user.name)}">
                            ${escapeHtml(user.name)}
                            ${user.isCurrentUser ? ' (ä½ )' : ''}
                        </div>
                        
                        ${user.gameCount > 0 ? `<div class="text-xs text-slate-400">${user.gameCount} éŠæˆ²</div>` : ''}
                        
                        <div class="flex flex-wrap justify-center gap-1 mt-1">
                            ${user.isShared ? '<span class="inline-block px-1 py-0.5 bg-blue-500/20 text-blue-400 text-xs rounded">å…±äº«</span>' : ''}
                            ${!user.isShared ? '<span class="inline-block px-1 py-0.5 bg-purple-500/20 text-purple-400 text-xs rounded">Discord</span>' : ''}
                            ${hasFailed ? '<span class="inline-block px-1 py-0.5 bg-red-500/20 text-red-400 text-xs rounded">éŒ¯èª¤</span>' : ''}
                        </div>
                        
                        ${user.totalPlaytime > 0 ? `
                            <div class="text-xs text-slate-500 mt-1">${Math.round(user.totalPlaytime / 60)}h ç¸½éŠæˆ²æ™‚é–“</div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => toggleUser(user));
            
            // å¦‚æœæ˜¯Discordç”¨æˆ¶ä¸”æœ‰Steam Profile URLï¼Œæ·»åŠ å³éµèœå–®
            if (!user.isShared && user.steamProfileUrl) {
                card.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showUserContextMenu(e, user);
                });
            }
            
            return card;
        }

        // é¡¯ç¤ºç”¨æˆ¶å³éµé¸å–®
        function showUserContextMenu(e, user) {
            // ç§»é™¤ç¾æœ‰çš„é¸å–®
            const existingMenu = document.querySelector('.user-context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.className = 'user-context-menu fixed glass-effect rounded-lg border border-slate-600 py-2 z-50';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            
            menu.innerHTML = `
                <div class="px-3 py-2 text-sm text-slate-300 border-b border-slate-600 font-medium">
                    ${escapeHtml(user.name)}
                </div>
                <button class="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-600/50 transition-colors" data-action="steam-profile">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5z" clip-rule="evenodd"/>
                        <path fill-rule="evenodd" d="M7.414 15.414a2 2 0 01-2.828-2.828l3-3a2 2 0 012.828 0 1 1 0 001.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 00-1.414-1.414l-1.5 1.5z" clip-rule="evenodd"/>
                    </svg>
                    æŸ¥çœ‹Steamå€‹äººè³‡æ–™
                </button>
                ${user.discordId === currentUser?.id ? `
                    <button class="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-600/50 transition-colors" data-action="update-steam">
                        <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                        æ›´æ–°Steamé€£çµ
                    </button>
                ` : ''}
            `;
            
            // è™•ç†é¸å–®é»æ“Š
            menu.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                
                switch (action) {
                    case 'steam-profile':
                        if (user.steamProfileUrl) {
                            window.open(user.steamProfileUrl, '_blank');
                        }
                        break;
                    case 'update-steam':
                        showSteamLinkModal();
                        break;
                }
                
                menu.remove();
            });
            
            // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            document.addEventListener('click', closeMenu);
            document.body.appendChild(menu);
            
            // ç¢ºä¿é¸å–®ä¸æœƒè¶…å‡ºè¦–çª—é‚Šç•Œ
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = `${e.pageX - rect.width}px`;
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = `${e.pageY - rect.height}px`;
            }
        }

        // åˆ‡æ›ç”¨æˆ¶é¸æ“‡
        function toggleUser(user) {
            const index = selectedUsers.findIndex(u => u.id === user.id);
            if (index === -1) {
                selectedUsers.push(user);
            } else {
                selectedUsers.splice(index, 1);
            }
            
            updateUserInterface();
            
            clearTimeout(window.loadGamesTimeout);
            window.loadGamesTimeout = setTimeout(() => {
                loadGames();
            }, 500);
        }

        // å…¨é¸ç”¨æˆ¶
        function selectAllUsers() {
            selectedUsers = [...allUsers];
            updateUserInterface();
            
            clearTimeout(window.loadGamesTimeout);
            window.loadGamesTimeout = setTimeout(() => {
                loadGames();
            }, 500);
        }

        // å–æ¶ˆå…¨é¸
        function deselectAllUsers() {
            selectedUsers = [];
            updateUserInterface();
            
            clearTimeout(window.loadGamesTimeout);
            window.loadGamesTimeout = setTimeout(() => {
                loadGames();
            }, 500);
        }

        // é‡è©¦å¤±æ•—çš„ç”¨æˆ¶
        async function retryFailedUsers() {
            if (failedUsers.length === 0) return;
            
            showNotification(`æ­£åœ¨é‡è©¦ ${failedUsers.length} å€‹å¤±æ•—çš„ç”¨æˆ¶...`, 'info');
            
            // æ¸…é™¤å¤±æ•—ç”¨æˆ¶çš„ç·©å­˜
            failedUsers.forEach(user => {
                gameDataCache.delete(user.id);
            });
            
            // é‡æ–°è¼‰å…¥éŠæˆ²
            await loadGames();
        }

        // æ¸…é™¤ç·©å­˜åŠŸèƒ½
        function clearGameDataCache() {
            gameDataCache.clear();
            failedUsers = [];
            ErrorLogger.clear();
            updateSystemStatus('steamApi', 'unknown');
            showNotification('å·²æ¸…é™¤éŠæˆ²æ•¸æ“šç·©å­˜', 'success');
        }

        // æ‰‹å‹•é‡æ–°è¼‰å…¥éŠæˆ²æ•¸æ“š
        async function reloadGameData(forceRefresh = false) {
            if (forceRefresh) {
                gameDataCache.clear();
                failedUsers = [];
                ErrorLogger.clear();
            }
            
            await loadGames();
        }

        // æ”¹é€²çš„è¼‰å…¥éŠæˆ²å‡½æ•¸
        async function loadGames() {
            if (selectedUsers.length === 0) {
                allGames = [];
                filteredGames = [];
                updateGamesInterface();
                return;
            }
            
            if (isLoadingGames) {
                console.log('éŠæˆ²è¼‰å…¥ä¸­ï¼Œè·³éé‡è¤‡è«‹æ±‚');
                return;
            }
            
            isLoadingGames = true;
            showLoading(true);
            
            try {
                showNotification('æ­£åœ¨è¼‰å…¥éŠæˆ²è³‡æ–™...', 'info');
                
                const allUserGames = [];
                let totalGamesLoaded = 0;
                let successCount = 0;
                let errorCount = 0;
                
                // é‡ç½®å¤±æ•—ç”¨æˆ¶åˆ—è¡¨ï¼ˆåªä¿ç•™é€™æ¬¡è¼‰å…¥çœŸæ­£å¤±æ•—çš„ï¼‰
                const currentFailedUsers = [];
                
                for (let i = 0; i < selectedUsers.length; i++) {
                    const user = selectedUsers[i];
                    try {
                        console.log(`è¼‰å…¥ç”¨æˆ¶ ${user.name} çš„éŠæˆ²...`);
                        let games;
                        
                        // æª¢æŸ¥ç·©å­˜
                        if (gameDataCache.has(user.id)) {
                            console.log(`ä½¿ç”¨ç”¨æˆ¶ ${user.name} çš„ç·©å­˜æ•¸æ“š`);
                            games = gameDataCache.get(user.id);
                        } else {
                            // å¾è³‡æ–™åº«è¼‰å…¥
                            games = await loadUserGamesFromDB(user.id);
                            
                            // å¦‚æœè³‡æ–™åº«æ²’æœ‰æ•¸æ“šï¼Œå¾APIè¼‰å…¥
                            if (!games || games.length === 0) {
                                games = await fetchUserGamesWithRetry(user.id);
                                
                                // å¦‚æœæ˜¯å·²ç™»å…¥ç”¨æˆ¶ï¼Œå˜—è©¦ä¿å­˜åˆ°è³‡æ–™åº«ï¼ˆéé˜»å¡ï¼‰
                                if (currentUser && games.length > 0) {
                                    saveUserGamesToDB(user.id, games).catch(error => {
                                        console.warn('ä¿å­˜éŠæˆ²æ•¸æ“šå¤±æ•—:', error.message);
                                    });
                                }
                            }
                            
                            // ç·©å­˜æ•¸æ“š
                            gameDataCache.set(user.id, games);
                        }
                        
                        // æ›´æ–°ç”¨æˆ¶çš„éŠæˆ²æ•¸é‡
                        user.gameCount = games.length;
                        user.hasError = false;
                        allUserGames.push(games);
                        totalGamesLoaded += games.length;
                        successCount++;
                        
                        // ç§»é™¤ä¹‹å‰å¤±æ•—è¨˜éŒ„
                        const failedIndex = failedUsers.findIndex(u => u.id === user.id);
                        if (failedIndex !== -1) {
                            failedUsers.splice(failedIndex, 1);
                        }
                        
                    } catch (error) {
                        console.error(`è¼‰å…¥ç”¨æˆ¶ ${user.name} å¤±æ•—:`, error);
                        user.hasError = true;
                        currentFailedUsers.push(user);
                        allUserGames.push([]);
                        errorCount++;
                        
                        ErrorLogger.log(new AppError(
                            `è¼‰å…¥ç”¨æˆ¶ ${user.name} å¤±æ•—`, 
                            'steam-api', 
                            error
                        ));
                    }
                }
                
                // æ›´æ–°å¤±æ•—ç”¨æˆ¶åˆ—è¡¨
                failedUsers = currentFailedUsers;
                
                // æ›´æ–°ç”¨æˆ¶ç•Œé¢ä»¥é¡¯ç¤ºéŠæˆ²æ•¸é‡å’ŒéŒ¯èª¤ç‹€æ…‹
                updateUserInterface();
                
                allGames = calculateCommonGames(allUserGames);
                filterGames();
                
                // æ›´æ–°APIç‹€æ…‹
                if (errorCount === 0) {
                    updateSystemStatus('steamApi', 'connected');
                } else if (successCount > 0) {
                    updateSystemStatus('steamApi', 'warning');
                } else {
                    updateSystemStatus('steamApi', 'error');
                }
                
                // é¡¯ç¤ºçµæœé€šçŸ¥
                if (totalGamesLoaded === 0 && errorCount > 0) {
                    showNotification(`è¼‰å…¥å¤±æ•—ï¼š${errorCount} å€‹ç”¨æˆ¶ç„¡æ³•è¼‰å…¥éŠæˆ²æ•¸æ“š`, 'error');
                } else if (errorCount > 0) {
                    showNotification(`éƒ¨åˆ†æˆåŠŸï¼šè¼‰å…¥äº† ${allGames.length} å€‹éŠæˆ²ï¼Œ${errorCount} å€‹ç”¨æˆ¶å¤±æ•—`, 'warning');
                } else {
                    showNotification(`æˆåŠŸè¼‰å…¥ ${allGames.length} å€‹ä¸åŒçš„éŠæˆ²`, 'success');
                }
                
            } catch (error) {
                ErrorLogger.log(new AppError('è¼‰å…¥éŠæˆ²å¤±æ•—', 'general', error));
                showNotification('è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—', 'error');
                allGames = [];
                filteredGames = [];
                updateSystemStatus('steamApi', 'error');
            } finally {
                isLoadingGames = false;
                showLoading(false);
                updateGamesInterface();
            }
        }

        // å¾è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶éŠæˆ²ï¼ˆæ”¹é€²éŒ¯èª¤è™•ç†ï¼‰
        async function loadUserGamesFromDB(steamId) {
            try {
                if (!supabase) return null;
                
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('id, game_count')
                    .eq('steam_id', steamId)
                    .maybeSingle(); // ä½¿ç”¨ maybeSingle é¿å…å¤šè¡ŒéŒ¯èª¤
                
                if (userError) {
                    if (userError.code === '42501' || userError.message.includes('RLS')) {
                        console.log(`RLSæ”¿ç­–é™åˆ¶è¨ªå•ç”¨æˆ¶ ${steamId}`);
                        return null;
                    }
                    throw userError;
                }
                
                if (!user) {
                    console.log(`ç”¨æˆ¶ ${steamId} åœ¨è³‡æ–™åº«ä¸­ä¸å­˜åœ¨`);
                    return null;
                }
                
                if (!user.game_count || user.game_count === 0) {
                    console.log(`ç”¨æˆ¶ ${steamId} æ²’æœ‰éŠæˆ²è¨˜éŒ„`);
                    return null;
                }
                
                const { data: userGames, error } = await supabase
                    .from('user_games')
                    .select(`
                        playtime_forever,
                        games!inner (
                            steam_app_id,
                            name,
                            header_image
                        )
                    `)
                    .eq('user_id', user.id)
                    .limit(1000);
                
                if (error) {
                    if (error.code === '42501' || error.message.includes('RLS')) {
                        console.log(`RLSæ”¿ç­–é™åˆ¶è¨ªå•ç”¨æˆ¶ ${steamId} çš„éŠæˆ²`);
                        return null;
                    }
                    throw error;
                }
                
                if (!userGames || userGames.length === 0) {
                    console.log(`ç”¨æˆ¶ ${steamId} åœ¨è³‡æ–™åº«ä¸­æ²’æœ‰éŠæˆ²æ•¸æ“š`);
                    return null;
                }
                
                const games = userGames
                    .filter(ug => ug.games && ug.games.steam_app_id)
                    .map(ug => ({
                        appid: ug.games.steam_app_id,
                        name: ug.games.name || `Game ${ug.games.steam_app_id}`,
                        playtime_forever: ug.playtime_forever || 0,
                        img_icon_url: ug.games.header_image || ''
                    }));
                
                console.log(`å¾è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶ ${steamId} çš„ ${games.length} å€‹éŠæˆ²`);
                return games;
                
            } catch (error) {
                console.warn(`è³‡æ–™åº«æŸ¥è©¢ç”¨æˆ¶ ${steamId} å¤±æ•—:`, error.message);
                return null;
            }
        }

        // æ”¹é€²çš„Steam APIèª¿ç”¨ï¼ˆå¢åŠ é‡è©¦æ©Ÿåˆ¶ï¼‰
        async function fetchUserGamesWithRetry(steamId, maxRetries = 3) {
            let lastError = null;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ç¬¬ ${attempt}/${maxRetries} æ¬¡å˜—è©¦è¼‰å…¥ç”¨æˆ¶ ${steamId}`);
                    const games = await fetchUserGames(steamId);
                    
                    if (games && games.length >= 0) { // åŒ…æ‹¬0å€‹éŠæˆ²çš„æƒ…æ³
                        return games;
                    }
                } catch (error) {
                    lastError = error;
                    console.warn(`ç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—:`, error.message);
                    
                    if (attempt < maxRetries) {
                        // æŒ‡æ•¸é€€é¿
                        const delay = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                        console.log(`ç­‰å¾… ${delay}ms å¾Œé‡è©¦...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw new AppError(
                `è¼‰å…¥ç”¨æˆ¶ ${steamId} å¤±æ•—ï¼Œå·²é‡è©¦ ${maxRetries} æ¬¡`, 
                'steam-api', 
                lastError
            );
        }

        // ç²å–ç”¨æˆ¶éŠæˆ²ï¼ˆæ”¹é€²çš„ç‰ˆæœ¬ï¼‰
        async function fetchUserGames(steamId) {
            if (!validateSteamId(steamId)) {
                throw new AppError(`ç„¡æ•ˆçš„ Steam ID: ${steamId}`, 'validation');
            }
            
            const errors = [];
            
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxy = CORS_PROXIES[i];
                try {
                    const steamUrl = `${STEAM_CONFIG.API_BASE}/IPlayerService/GetOwnedGames/v0001/?key=${STEAM_CONFIG.API_KEY}&steamid=${steamId}&format=json&include_appinfo=true`;
                    const finalUrl = `${proxy.url}${encodeURIComponent(steamUrl)}`;
                    
                    console.log(`ä½¿ç”¨ä»£ç† ${proxy.name} (${i + 1}/${CORS_PROXIES.length})`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), proxy.timeout);
                    
                    const response = await fetch(finalUrl, {
                        method: 'GET',
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Steam Game Finder/1.0'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const responseText = await response.text();
                    let gameData;
                    
                    try {
                        const jsonData = JSON.parse(responseText);
                        
                        if (jsonData.contents) {
                            gameData = JSON.parse(jsonData.contents);
                        } else if (jsonData.response) {
                            gameData = jsonData;
                        } else {
                            throw new Error('æœªçŸ¥çš„éŸ¿æ‡‰æ ¼å¼');
                        }
                        
                    } catch (parseError) {
                        throw new Error(`è§£æéŸ¿æ‡‰å¤±æ•—: ${parseError.message}`);
                    }
                    
                    if (gameData.response?.error) {
                        throw new Error(`Steam APIéŒ¯èª¤: ${gameData.response.error}`);
                    }
                    
                    const rawGames = gameData.response?.games || [];
                    
                    if (rawGames.length === 0) {
                        console.log(`Steam API è¿”å› 0 å€‹éŠæˆ²çµ¦ç”¨æˆ¶ ${steamId}`);
                        
                        if (!gameData.response?.games) {
                            console.log('å¯èƒ½æ˜¯éš±ç§è¨­ç½®å•é¡Œ');
                        }
                    }
                    
                    const cleanGames = sanitizeGameData(rawGames);
                    console.log(`æˆåŠŸè¼‰å…¥ç”¨æˆ¶ ${steamId} çš„ ${cleanGames.length} å€‹éŠæˆ²`);
                    return cleanGames;
                    
                } catch (error) {
                    const errorMsg = `ä»£ç† ${proxy.name} å¤±æ•—: ${error.message}`;
                    console.error(errorMsg);
                    errors.push(errorMsg);
                    
                    if (i < CORS_PROXIES.length - 1) {
                        console.log('å˜—è©¦ä¸‹ä¸€å€‹ä»£ç†...');
                    }
                }
            }
            
            throw new AppError(
                `æ‰€æœ‰ä»£ç†å¤±æ•—ï¼Œç„¡æ³•è¼‰å…¥ç”¨æˆ¶ ${steamId} çš„éŠæˆ²`, 
                'steam-api', 
                { errors }
            );
        }

        // æ”¹é€²çš„ä¿å­˜ç”¨æˆ¶éŠæˆ²åˆ°è³‡æ–™åº«
        async function saveUserGamesToDB(steamId, games) {
            try {
                if (!supabase || !games || games.length === 0 || !currentUser) return;
                
                console.log(`å˜—è©¦ä¿å­˜ç”¨æˆ¶ ${steamId} çš„ ${games.length} å€‹éŠæˆ²åˆ°è³‡æ–™åº«`);
                
                // å˜—è©¦æŸ¥æ‰¾æˆ–å‰µå»ºç”¨æˆ¶
                let userId = await findOrCreateUser(steamId);
                if (!userId) {
                    console.warn('ç„¡æ³•å‰µå»ºæˆ–æ‰¾åˆ°ç”¨æˆ¶ï¼Œè·³éè³‡æ–™åº«ä¿å­˜');
                    return;
                }
                
                // æ‰¹é‡è™•ç†éŠæˆ²æ•¸æ“š
                await batchSaveGames(userId, games);
                
            } catch (error) {
                console.warn('ä¿å­˜éŠæˆ²æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error.message);
                ErrorLogger.log(new AppError('ä¿å­˜éŠæˆ²æ•¸æ“šå¤±æ•—', 'database', error));
            }
        }

        // æŸ¥æ‰¾æˆ–å‰µå»ºç”¨æˆ¶
        async function findOrCreateUser(steamId) {
            try {
                // é¦–å…ˆå˜—è©¦æŸ¥æ‰¾ç”¨æˆ¶
                const { data: user, error: findError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('steam_id', steamId)
                    .maybeSingle();
                
                if (findError && findError.code !== '42501') {
                    throw findError;
                }
                
                if (user) {
                    return user.id;
                }
                
                // ç”¨æˆ¶ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»º
                const selectedUser = selectedUsers.find(u => u.id === steamId);
                if (!selectedUser) {
                    throw new Error('æ‰¾ä¸åˆ°å°æ‡‰çš„ç”¨æˆ¶ä¿¡æ¯');
                }
                
                const { data: newUser, error: createError } = await supabase
                    .from('users')
                    .insert({
                        discord_id: currentUser.id,
                        username: selectedUser.name || `User ${steamId}`,
                        avatar_url: selectedUser.avatar || null,
                        steam_id: steamId,
                        is_shared: selectedUser.isShared || false,
                        game_count: 0,
                        total_playtime: 0
                    })
                    .select('id')
                    .single();
                
                if (createError) {
                    if (createError.code === '42501') {
                        console.warn('RLSæ”¿ç­–é˜»æ­¢å‰µå»ºç”¨æˆ¶');
                        return null;
                    }
                    throw createError;
                }
                
                return newUser.id;
                
            } catch (error) {
                console.warn('æŸ¥æ‰¾æˆ–å‰µå»ºç”¨æˆ¶å¤±æ•—:', error.message);
                return null;
            }
        }

        // æ‰¹é‡ä¿å­˜éŠæˆ²
        async function batchSaveGames(userId, games) {
            try {
                const batchSize = 100; // åˆ†æ‰¹è™•ç†é¿å…è¶…æ™‚
                
                for (let i = 0; i < games.length; i += batchSize) {
                    const batch = games.slice(i, i + batchSize);
                    await saveBatchGames(userId, batch);
                }
                
                // æ›´æ–°ç”¨æˆ¶çµ±è¨ˆ
                const totalPlaytime = games.reduce((total, game) => total + (game.playtime_forever || 0), 0);
                await supabase
                    .from('users')
                    .update({ 
                        game_count: games.length,
                        total_playtime: totalPlaytime
                    })
                    .eq('id', userId);
                
                console.log(`æˆåŠŸä¿å­˜ ${games.length} å€‹éŠæˆ²`);
                
            } catch (error) {
                console.warn('æ‰¹é‡ä¿å­˜éŠæˆ²å¤±æ•—:', error.message);
            }
        }

        // ä¿å­˜å–®æ‰¹éŠæˆ²
        async function saveBatchGames(userId, games) {
            try {
                // æº–å‚™éŠæˆ²æ•¸æ“š
                const gamesToInsert = games.map(game => ({
                    steam_app_id: game.appid,
                    name: sanitizeText(game.name),
                    header_image: `https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/header.jpg`
                }));
                
                // å˜—è©¦æ’å…¥éŠæˆ²ï¼ˆå¿½ç•¥RLSéŒ¯èª¤ï¼‰
                await supabase
                    .from('games')
                    .upsert(gamesToInsert, { 
                        onConflict: 'steam_app_id',
                        ignoreDuplicates: false 
                    });
                
                // ç²å–éŠæˆ²IDæ˜ å°„
                const appIds = games.map(g => g.appid);
                const { data: existingGames } = await supabase
                    .from('games')
                    .select('id, steam_app_id')
                    .in('steam_app_id', appIds);
                
                if (!existingGames) return;
                
                // å‰µå»ºç”¨æˆ¶éŠæˆ²é—œè¯
                const gameIdMap = new Map();
                existingGames.forEach(g => gameIdMap.set(g.steam_app_id, g.id));
                
                const userGamesToInsert = games
                    .filter(game => gameIdMap.has(game.appid))
                    .map(game => ({
                        user_id: userId,
                        game_id: gameIdMap.get(game.appid),
                        playtime_forever: game.playtime_forever || 0
                    }));
                
                if (userGamesToInsert.length > 0) {
                    // å…ˆåˆªé™¤èˆŠé—œè¯
                    await supabase
                        .from('user_games')
                        .delete()
                        .eq('user_id', userId);
                    
                    // æ’å…¥æ–°é—œè¯
                    await supabase
                        .from('user_games')
                        .insert(userGamesToInsert);
                }
                
            } catch (error) {
                if (error.code !== '42501') {
                    throw error;
                }
                console.warn('RLSæ”¿ç­–é˜»æ­¢ä¿å­˜ï¼Œè·³éè³‡æ–™åº«æ“ä½œ');
            }
        }

        // æ–‡æœ¬æ¸…ç†å‡½æ•¸
        function sanitizeText(text) {
            if (typeof text !== 'string') return String(text || '');
            return text
                .trim()
                .replace(/[\r\n\t]/g, ' ')
                .replace(/\s+/g, ' ')
                .substring(0, 255); // é™åˆ¶é•·åº¦
        }

        // æ¸…ç†å’Œé©—è­‰éŠæˆ²æ•¸æ“šï¼ˆæ”¹é€²ç‰ˆï¼‰
        function sanitizeGameData(games) {
            if (!Array.isArray(games)) {
                console.warn('éŠæˆ²æ•¸æ“šä¸æ˜¯é™£åˆ—:', games);
                return [];
            }
            
            return games
                .filter(game => {
                    if (!game || typeof game !== 'object') return false;
                    if (!game.appid || typeof game.appid !== 'number') return false;
                    if (!game.name || typeof game.name !== 'string' || game.name.trim().length === 0) return false;
                    return true;
                })
                .map(game => {
                    try {
                        let cleanName = sanitizeText(game.name);
                        
                        // è™•ç†ç‰¹æ®Šå­—ç¬¦
                        cleanName = cleanName
                            .replace(/[â„¢Â®Â©]/g, '') // ç§»é™¤å•†æ¨™ç¬¦è™Ÿ
                            .replace(/['']/g, "'") // çµ±ä¸€æ’‡è™Ÿ
                            .replace(/[""]/g, '"') // çµ±ä¸€å¼•è™Ÿ
                            .replace(/â€¦/g, '...') // çµ±ä¸€çœç•¥è™Ÿ
                            .trim();
                        
                        return {
                            appid: parseInt(game.appid),
                            name: cleanName,
                            playtime_forever: parseInt(game.playtime_forever) || 0,
                            img_icon_url: game.img_icon_url || ''
                        };
                    } catch (error) {
                        console.warn('æ¸…ç†éŠæˆ²æ•¸æ“šå¤±æ•—:', error, game);
                        return null;
                    }
                })
                .filter(game => game !== null);
        }

        // è¨ˆç®—å…±åŒéŠæˆ²ï¼ˆæ”¹é€²éŒ¯èª¤è™•ç†ï¼‰
        function calculateCommonGames(allUserGames) {
            const gameOccurrences = {};
            
            try {
                allUserGames.forEach((userGames, userIndex) => {
                    if (!Array.isArray(userGames)) {
                        console.warn(`ç”¨æˆ¶ ${userIndex} çš„éŠæˆ²æ•¸æ“šä¸æ˜¯é™£åˆ—:`, userGames);
                        return;
                    }
                    
                    userGames.forEach(game => {
                        try {
                            if (!game || !game.appid || !game.name) {
                                return;
                            }
                            
                            const appid = parseInt(game.appid);
                            if (isNaN(appid)) return;
                            
                            if (!gameOccurrences[appid]) {
                                gameOccurrences[appid] = {
                                    ...game,
                                    appid: appid,
                                    owners: [],
                                    totalPlaytime: 0
                                };
                            }
                            
                            const playtime = parseInt(game.playtime_forever) || 0;
                            gameOccurrences[appid].owners.push({
                                userIndex,
                                playtime: playtime
                            });
                            gameOccurrences[appid].totalPlaytime += playtime;
                        } catch (error) {
                            console.warn('è™•ç†éŠæˆ²æ™‚ç™¼ç”ŸéŒ¯èª¤:', error, game);
                        }
                    });
                });
                
                const result = Object.values(gameOccurrences)
                    .map(game => {
                        try {
                            const commonality = game.owners.length;
                            const commonalityPercentage = Math.round((commonality / selectedUsers.length) * 100);
                            
                            return {
                                ...game,
                                commonality,
                                commonalityPercentage,
                                isCommon: commonality >= Math.max(1, Math.ceil(selectedUsers.length * 0.5)),
                                averagePlaytime: commonality > 0 ? Math.round(game.totalPlaytime / commonality) : 0
                            };
                        } catch (error) {
                            console.warn('è¨ˆç®—éŠæˆ²çµ±è¨ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error, game);
                            return null;
                        }
                    })
                    .filter(game => game !== null);
                
                console.log(`æˆåŠŸè¨ˆç®— ${result.length} å€‹éŠæˆ²çš„å…±é€šåº¦`);
                return result;
                
            } catch (error) {
                ErrorLogger.log(new AppError('è¨ˆç®—å…±åŒéŠæˆ²æ™‚ç™¼ç”ŸéŒ¯èª¤', 'calculation', error));
                return [];
            }
        }

        // å…¶é¤˜å‡½æ•¸ä¿æŒä¸è®Š...
        // è™•ç†æœå°‹è¼¸å…¥
        function handleSearchInput() {
            const searchTerm = elements.searchInput.value.trim();
            const clearBtn = document.getElementById('clearSearch');
            
            if (clearBtn) {
                if (searchTerm) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
            }
            
            filterGames();
        }

        // æ¸…é™¤æœå°‹
        function clearSearch() {
            elements.searchInput.value = '';
            const clearBtn = document.getElementById('clearSearch');
            if (clearBtn) {
                clearBtn.classList.add('hidden');
            }
            filterGames();
        }

        // ç¯©é¸éŠæˆ²
        function filterGames() {
            let filtered = [...allGames];
            
            switch (currentFilter) {
                case 'common':
                    filtered = filtered.filter(game => game.isCommon);
                    break;
                case 'majority':
                    filtered = filtered.filter(game => game.commonalityPercentage >= 50);
                    break;
                case 'popular':
                    filtered = filtered.filter(game => game.commonalityPercentage >= 75);
                    break;
                case 'highPlaytime':
                    filtered = filtered.filter(game => game.averagePlaytime >= 300);
                    break;
            }
            
            const searchTerm = elements.searchInput ? elements.searchInput.value.toLowerCase().trim() : '';
            if (searchTerm) {
                filtered = filtered.filter(game => 
                    game.name.toLowerCase().includes(searchTerm)
                );
            }
            
            filteredGames = filtered;
            sortGames();
        }

        // æ’åºéŠæˆ²
        function sortGames() {
            switch (currentSort) {
                case 'name':
                    filteredGames.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                    break;
                case 'playtime':
                    filteredGames.sort((a, b) => b.averagePlaytime - a.averagePlaytime);
                    break;
                case 'appid':
                    filteredGames.sort((a, b) => a.appid - b.appid);
                    break;
                case 'commonality':
                default:
                    filteredGames.sort((a, b) => {
                        if (b.commonality !== a.commonality) {
                            return b.commonality - a.commonality;
                        }
                        return b.averagePlaytime - a.averagePlaytime;
                    });
                    break;
            }
            
            updateGamesInterface();
        }

        // æ›´æ–°éŠæˆ²ç•Œé¢
        function updateGamesInterface() {
            try {
                if (!elements.gamesGrid || !elements.emptyState) {
                    console.warn('éŠæˆ²ç•Œé¢å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                elements.gamesGrid.innerHTML = '';
                
                if (filteredGames.length === 0) {
                    elements.emptyState.classList.remove('hidden');
                    elements.gamesGrid.classList.add('hidden');
                } else {
                    elements.emptyState.classList.add('hidden');
                    elements.gamesGrid.classList.remove('hidden');
                    
                    const fragment = document.createDocumentFragment();
                    let createdCount = 0;
                    
                    for (let i = 0; i < filteredGames.length; i++) {
                        try {
                            const game = filteredGames[i];
                            if (game && game.name && game.appid) {
                                const gameCard = createGameCard(game);
                                if (gameCard) {
                                    fragment.appendChild(gameCard);
                                    createdCount++;
                                }
                            }
                        } catch (error) {
                            console.error(`å‰µå»ºéŠæˆ²å¡ç‰‡ ${i} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error, filteredGames[i]);
                        }
                    }
                    
                    elements.gamesGrid.appendChild(fragment);
                    console.log(`æˆåŠŸå‰µå»º ${createdCount} å€‹éŠæˆ²å¡ç‰‡ï¼Œé¡¯ç¤º ${filteredGames.length} å€‹éŠæˆ²`);
                }
                
                updateStats();
                
            } catch (error) {
                ErrorLogger.log(new AppError('æ›´æ–°éŠæˆ²ç•Œé¢å¤±æ•—', 'ui', error));
                showNotification('é¡¯ç¤ºéŠæˆ²æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // å‰µå»ºéŠæˆ²å¡ç‰‡
        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card glass-effect rounded-xl overflow-hidden fade-in';
            
            const headerImageUrl = `https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/header.jpg`;
            const capsuleImageUrl = `https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/capsule_231x87.jpg`;
            const fallbackImageUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(game.name)}&size=300&background=334155&color=94a3b8`;
            
            const gameGenres = getGameGenres(game.appid);
            const commonalityColor = game.commonalityPercentage >= 75 ? 'text-green-400' : 
                                   game.commonalityPercentage >= 50 ? 'text-yellow-400' : 'text-blue-400';
            
            const img = document.createElement('img');
            img.src = headerImageUrl;
            img.alt = game.name;
            img.className = 'w-full h-32 object-cover transition-transform duration-300 group-hover:scale-105';
            
            let errorCount = 0;
            img.onerror = function() {
                errorCount++;
                if (errorCount === 1) {
                    this.src = capsuleImageUrl;
                } else if (errorCount === 2) {
                    this.src = fallbackImageUrl;
                }
            };
            
            const cardContent = document.createElement('div');
            cardContent.innerHTML = `
                <div class="relative group">
                    <div class="img-container"></div>
                    
                    <div class="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                        <div class="text-center text-white p-2">
                            <p class="text-sm font-medium mb-1">é»æ“ŠæŸ¥çœ‹Steamå•†åº—</p>
                            <p class="text-xs text-slate-300">App ID: ${game.appid}</p>
                        </div>
                    </div>
                    
                    <div class="absolute top-2 right-2">
                        <div class="bg-black/80 backdrop-blur-sm rounded-full px-2 py-1 text-xs font-medium border border-white/20">
                            <span class="${commonalityColor}">${game.commonality}</span>
                            <span class="text-slate-300">/${selectedUsers.length}</span>
                        </div>
                    </div>
                    
                    ${game.isCommon ? `
                        <div class="absolute top-2 left-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-2 py-1 rounded-full text-xs font-medium shadow-lg">
                            å…±åŒéŠæˆ²
                        </div>
                    ` : ''}
                    
                    ${game.commonalityPercentage >= 75 ? `
                        <div class="absolute bottom-2 left-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-2 py-1 rounded-full text-xs font-medium">
                            ç†±é–€
                        </div>
                    ` : ''}
                </div>
                
                <div class="p-4">
                    <h3 class="font-medium text-sm mb-3 line-clamp-2 leading-tight game-title"></h3>
                    
                    ${gameGenres.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${gameGenres.slice(0, 2).map(genre => 
                                `<span class="px-2 py-1 bg-slate-600/50 text-slate-300 text-xs rounded-full">${escapeHtml(genre)}</span>`
                            ).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-slate-400">æ“æœ‰ç‡</span>
                            <span class="text-xs font-medium ${commonalityColor}">${game.commonalityPercentage}%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-gradient-to-r ${getProgressBarColor(game.commonalityPercentage)} h-2 rounded-full transition-all duration-500" 
                                 style="width: ${game.commonalityPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-400">
                        <div class="text-center">
                            <div class="font-medium text-white">${Math.round(game.averagePlaytime / 60)}h</div>
                            <div>å¹³å‡æ™‚é–“</div>
                        </div>
                        <div class="text-center">
                            <div class="font-medium text-white">${game.owners.length}</div>
                            <div>æ“æœ‰è€…</div>
                        </div>
                    </div>
                </div>
                
                <div class="absolute inset-0 rounded-xl opacity-0 bg-blue-400/20 pointer-events-none transition-opacity duration-200 card-ripple"></div>
            `;
            
            card.appendChild(cardContent);
            
            const imgContainer = card.querySelector('.img-container');
            imgContainer.appendChild(img);
            
            const titleElement = card.querySelector('.game-title');
            titleElement.textContent = game.name;
            titleElement.title = game.name;
            
            card.addEventListener('click', (e) => {
                const rippleElement = card.querySelector('.card-ripple');
                if (rippleElement) {
                    rippleElement.style.opacity = '1';
                    setTimeout(() => {
                        rippleElement.style.opacity = '0';
                    }, 200);
                }
                
                window.open(`${STEAM_CONFIG.STORE_BASE}/${game.appid}`, '_blank');
            });

            card.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showGameDetails(game);
            });
            
            return card;
        }

        // å®‰å…¨çš„HTMLè½‰ç¾©å‡½æ•¸
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return String(unsafe || '');
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\\/g, "&#92;")
                .replace(/\n/g, " ")
                .replace(/\r/g, " ")
                .replace(/\t/g, " ");
        }

        // ç²å–éŠæˆ²é¡å‹æ¨™ç±¤
        function getGameGenres(appId) {
            const gameGenresMap = {
                570: ['MOBA', 'Free to Play'],
                730: ['FPS', 'ç«¶æŠ€'],
                440: ['FPS', 'Free to Play'],
                271590: ['é–‹æ”¾ä¸–ç•Œ', 'å‹•ä½œ'],
                431960: ['å·¥å…·', 'å€‹äººåŒ–'],
                252490: ['ç”Ÿå­˜', 'å¤šäºº'],
                578080: ['å¤§é€ƒæ®º', 'FPS'],
                292030: ['RPG', 'é–‹æ”¾ä¸–ç•Œ']
            };
            
            const genres = gameGenresMap[appId] || ['éŠæˆ²'];
            return genres.map(genre => escapeHtml(genre));
        }

        // ç²å–é€²åº¦æ¢é¡è‰²
        function getProgressBarColor(percentage) {
            if (percentage >= 75) return 'from-green-500 to-green-600';
            if (percentage >= 50) return 'from-yellow-500 to-yellow-600';
            if (percentage >= 25) return 'from-blue-500 to-blue-600';
            return 'from-gray-500 to-gray-600';
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            try {
                if (elements.totalGames) elements.totalGames.textContent = allGames.length;
                if (elements.commonGames) elements.commonGames.textContent = allGames.filter(g => g.isCommon).length;
                if (elements.selectedUsers) elements.selectedUsers.textContent = selectedUsers.length;
                if (elements.showingGames) elements.showingGames.textContent = filteredGames.length;
            } catch (error) {
                console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        function showLoading(show) {
            try {
                if (show) {
                    if (elements.loadingState) elements.loadingState.classList.remove('hidden');
                    if (elements.gamesGrid) elements.gamesGrid.classList.add('hidden');
                    if (elements.emptyState) elements.emptyState.classList.add('hidden');
                } else {
                    if (elements.loadingState) elements.loadingState.classList.add('hidden');
                }
            } catch (error) {
                console.error('é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // å¿«é€Ÿç¯©é¸è¨­ç½®
        function setQuickFilter(filterType) {
            document.querySelectorAll('.filter-tag').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filterType) {
                    btn.classList.add('active');
                }
            });
            
            currentFilter = filterType;
            filterGames();
            
            const filterNames = {
                'common': 'å…±åŒéŠæˆ²',
                'popular': 'ç†±é–€éŠæˆ²'
            };
            showNotification(`å·²ç¯©é¸ï¼š${filterNames[filterType]}`, 'success');
        }

        // é‡ç½®æ‰€æœ‰ç¯©é¸
        function resetAllFilters() {
            document.querySelectorAll('.filter-tag').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === 'all') {
                    btn.classList.add('active');
                }
            });
            currentFilter = 'all';
            
            if (elements.sortSelect) {
                elements.sortSelect.value = 'commonality';
            }
            currentSort = 'commonality';
            
            if (elements.searchInput) {
                elements.searchInput.value = '';
            }
            const clearBtn = document.getElementById('clearSearch');
            if (clearBtn) {
                clearBtn.classList.add('hidden');
            }
            
            filterGames();
            showNotification('å·²é‡ç½®æ‰€æœ‰ç¯©é¸æ¢ä»¶', 'success');
        }

        // å°å‡ºéŠæˆ²æ¸…å–®
        function exportGameList() {
            if (filteredGames.length === 0) {
                showNotification('æ²’æœ‰éŠæˆ²å¯å°å‡º', 'warning');
                return;
            }

            const exportData = {
                exportTime: new Date().toISOString(),
                selectedUsers: selectedUsers.map(u => ({ id: u.id, name: u.name })),
                filter: currentFilter,
                sort: currentSort,
                totalGames: filteredGames.length,
                systemStatus: systemStatus,
                errors: ErrorLogger.errors.slice(-10), // æœ€è¿‘10å€‹éŒ¯èª¤
                games: filteredGames.map(game => ({
                    appId: game.appid,
                    name: game.name,
                    commonality: game.commonality,
                    commonalityPercentage: game.commonalityPercentage,
                    averagePlaytime: game.averagePlaytime,
                    isCommon: game.isCommon,
                    steamUrl: `${STEAM_CONFIG.STORE_BASE}/${game.appid}`
                }))
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `steam-common-games-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);

            showNotification(`å·²å°å‡º ${filteredGames.length} å€‹éŠæˆ²çš„æ¸…å–®`, 'success');
        }

        // é¡¯ç¤ºéŠæˆ²è©³ç´°è³‡è¨Š
        function showGameDetails(game) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            
            const ownersList = game.owners && game.owners.length > 0 
                ? game.owners.map((owner, index) => {
                    const user = selectedUsers[owner.userIndex];
                    if (!user) return '';
                    return `
                        <div class="flex items-center justify-between p-2 bg-slate-700/50 rounded">
                            <div class="flex items-center space-x-2">
                                <img src="${user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}`}" 
                                     class="w-6 h-6 rounded-full" alt="${escapeHtml(user.name)}">
                                <span class="text-sm">${escapeHtml(user.name)}</span>
                            </div>
                            <span class="text-xs text-slate-400">${Math.round(owner.playtime / 60)}h</span>
                        </div>
                    `;
                }).join('')
                : '<div class="text-center text-slate-400 py-4">æ²’æœ‰ç”¨æˆ¶æ“æœ‰æ­¤éŠæˆ²</div>';

            modal.innerHTML = `
                <div class="glass-effect rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-bold text-white">${escapeHtml(game.name)}</h2>
                            <button class="text-slate-400 hover:text-white close-modal">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <img src="https://steamcdn-a.akamaihd.net/steam/apps/${game.appid}/header.jpg" 
                             alt="${escapeHtml(game.name)}" 
                             class="w-full h-32 object-cover rounded-lg mb-4"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(game.name)}&size=400&background=334155&color=94a3b8'">
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-3 bg-slate-700/30 rounded-lg">
                                <div class="text-xl font-bold text-blue-400">${game.commonality || 0}</div>
                                <div class="text-xs text-slate-400">æ“æœ‰è€…æ•¸é‡</div>
                            </div>
                            <div class="text-center p-3 bg-slate-700/30 rounded-lg">
                                <div class="text-xl font-bold text-green-400">${game.commonalityPercentage || 0}%</div>
                                <div class="text-xs text-slate-400">æ“æœ‰ç‡</div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h3 class="text-sm font-medium text-slate-300 mb-2">éŠæˆ²æ“æœ‰è€…</h3>
                            <div class="space-y-2">
                                ${ownersList}
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors open-steam">
                                åœ¨Steamä¸­æ‰“é–‹
                            </button>
                            <button class="flex-1 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors close-modal">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.querySelector('.open-steam').addEventListener('click', () => {
                window.open(`${STEAM_CONFIG.STORE_BASE}/${game.appid}`, '_blank');
            });

            modal.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            document.body.appendChild(modal);
        }

        // é¡¯ç¤ºå¹«åŠ©å½ˆçª—
        function showHelpModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="glass-effect rounded-xl max-w-lg w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-bold text-white">å¿«æ·éµèªªæ˜ & ç³»çµ±ç‹€æ…‹</h2>
                            <button class="text-slate-400 hover:text-white close-modal">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- ç³»çµ±ç‹€æ…‹ -->
                        <div class="mb-6 p-4 bg-slate-700/30 rounded-lg">
                            <h3 class="text-sm font-medium text-slate-300 mb-2">ç³»çµ±ç‹€æ…‹</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400">è³‡æ–™åº«</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 rounded-full ${
                                            systemStatus.database === 'connected' ? 'bg-green-500' :
                                            systemStatus.database === 'warning' ? 'bg-yellow-500' :
                                            systemStatus.database === 'error' ? 'bg-red-500' : 'bg-gray-500'
                                        }"></div>
                                        <span class="text-xs">${
                                            systemStatus.database === 'connected' ? 'æ­£å¸¸' :
                                            systemStatus.database === 'warning' ? 'è­¦å‘Š' :
                                            systemStatus.database === 'error' ? 'éŒ¯èª¤' : 'æœªçŸ¥'
                                        }</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400">Steam API</span>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-3 h-3 rounded-full ${
                                            systemStatus.steamApi === 'connected' ? 'bg-green-500' :
                                            systemStatus.steamApi === 'warning' ? 'bg-yellow-500' :
                                            systemStatus.steamApi === 'error' ? 'bg-red-500' : 'bg-gray-500'
                                        }"></div>
                                        <span class="text-xs">${
                                            systemStatus.steamApi === 'connected' ? 'æ­£å¸¸' :
                                            systemStatus.steamApi === 'warning' ? 'è­¦å‘Š' :
                                            systemStatus.steamApi === 'error' ? 'éŒ¯èª¤' : 'æœªçŸ¥'
                                        }</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 gap-3">
                                <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                    <span class="text-slate-300">æœå°‹éŠæˆ²</span>
                                    <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + F</kbd>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                    <span class="text-slate-300">åªçœ‹å…±åŒéŠæˆ²</span>
                                    <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + C</kbd>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                    <span class="text-slate-300">é‡ç½®ç¯©é¸</span>
                                    <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + R</kbd>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                    <span class="text-slate-300">å°å‡ºæ¸…å–®</span>
                                    <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + E</kbd>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                    <span class="text-slate-300">å¿«é€Ÿç¯©é¸ 1-4</span>
                                    <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Ctrl + 1~4</kbd>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-slate-700/30 rounded-lg">
                                    <span class="text-slate-300">é—œé–‰å½ˆçª—/æ¸…é™¤æœå°‹</span>
                                    <kbd class="px-2 py-1 bg-slate-600 rounded text-xs text-slate-200">Esc</kbd>
                                </div>
                            </div>
                            
                            <div class="border-t border-slate-600/30 pt-4">
                                <h3 class="text-sm font-medium text-slate-300 mb-2">æ»‘é¼ æ“ä½œ</h3>
                                <div class="space-y-2 text-sm text-slate-400">
                                    <div>â€¢ å·¦éµé»æ“ŠéŠæˆ²å¡ç‰‡ï¼šæ‰“é–‹Steamå•†åº—é é¢</div>
                                    <div>â€¢ å³éµé»æ“ŠéŠæˆ²å¡ç‰‡ï¼šé¡¯ç¤ºéŠæˆ²è©³ç´°è³‡è¨Š</div>
                                    <div>â€¢ å³éµé»æ“ŠDiscordç”¨æˆ¶ï¼šæŸ¥çœ‹Steamå€‹äººè³‡æ–™/æ›´æ–°é€£çµ</div>
                                    <div>â€¢ æ‡¸åœåœ¨å¡ç‰‡ä¸Šï¼šé¡¯ç¤ºé¡å¤–è³‡è¨Š</div>
                                </div>
                            </div>
                            
                            <div class="border-t border-slate-600/30 pt-4">
                                <h3 class="text-sm font-medium text-slate-300 mb-2">Discordç¾¤çµ„åŠŸèƒ½</h3>
                                <div class="space-y-2 text-sm text-slate-400">
                                    <div>â€¢ ğŸŸ£ Discordæ¨™ç±¤ï¼šç¾¤çµ„æˆå“¡</div>
                                    <div>â€¢ ğŸ”µ å…±äº«æ¨™ç±¤ï¼šæ¸¬è©¦å¸³è™Ÿ</div>
                                    <div>â€¢ ğŸŸ¢ é¸ä¸­ç‹€æ…‹ï¼šå·²é¸æ“‡æ¯”è¼ƒ</div>
                                    <div>â€¢ ğŸ”´ éŒ¯èª¤ç‹€æ…‹ï¼šè¼‰å…¥å¤±æ•—</div>
                                    <div>â€¢ ğŸ‘¤ å€‹äººæ¨™è¨˜ï¼šä½ çš„å¸³è™Ÿ</div>
                                </div>
                            </div>
                            
                            ${ErrorLogger.errors.length > 0 ? `
                                <div class="border-t border-slate-600/30 pt-4">
                                    <h3 class="text-sm font-medium text-slate-300 mb-2">æœ€è¿‘éŒ¯èª¤ (${ErrorLogger.errors.length})</h3>
                                    <div class="space-y-1 text-xs text-slate-400 max-h-32 overflow-y-auto">
                                        ${ErrorLogger.errors.slice(-5).map(error => 
                                            `<div>${error.type}: ${error.message}</div>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-6">
                            <button class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors close-modal">
                                æˆ‘çŸ¥é“äº†
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            document.body.appendChild(modal);
        }

        // éµç›¤å¿«æ·éµè™•ç†
        function handleKeyboardShortcuts(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }

            switch (e.key.toLowerCase()) {
                case 'f':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        elements.searchInput?.focus();
                    }
                    break;
                case 'c':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        setQuickFilter('common');
                    }
                    break;
                case 'r':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        resetAllFilters();
                    }
                    break;
                case 'e':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        exportGameList();
                    }
                    break;
                case 'escape':
                    const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
                    if (modal) {
                        modal.remove();
                    } else if (elements.searchInput?.value) {
                        clearSearch();
                    }
                    break;
                case '1':
                case '2':
                case '3':
                case '4':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        const filterTypes = ['all', 'common', 'majority', 'popular'];
                        const filterIndex = parseInt(e.key) - 1;
                        if (filterTypes[filterIndex]) {
                            setQuickFilter(filterTypes[filterIndex]);
                        }
                    }
                    break;
            }
        }

        // æ”¹é€²çš„é€šçŸ¥ç³»çµ±
        function showNotification(message, type = 'info') {
            try {
                const existingNotification = document.querySelector('.notification');
                if (existingNotification) {
                    existingNotification.remove();
                }
                
                const notification = document.createElement('div');
                notification.className = `notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 max-w-sm ${
                    type === 'error' ? 'bg-red-600' : 
                    type === 'success' ? 'bg-green-600' : 
                    type === 'warning' ? 'bg-yellow-600' :
                    'bg-blue-600'
                } text-white`;
                
                const icon = type === 'error' ? 'âŒ' : 
                           type === 'success' ? 'âœ…' : 
                           type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
                
                notification.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <span class="flex-shrink-0">${icon}</span>
                        <div class="flex-1 text-sm">${escapeHtml(message)}</div>
                        <button class="text-white/80 hover:text-white flex-shrink-0" onclick="this.parentElement.parentElement.remove()">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                if (type !== 'error') {
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.style.transform = 'translateX(100%)';
                            setTimeout(() => {
                                if (notification.parentElement) {
                                    notification.remove();
                                }
                            }, 300);
                        }
                    }, type === 'warning' ? 5000 : 3000);
                }
            } catch (error) {
                console.error('é¡¯ç¤ºé€šçŸ¥å¤±æ•—:', error);
            }
        }

        // é˜²æŠ–å‡½æ•¸
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
