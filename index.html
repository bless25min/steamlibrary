import React, { useState, useEffect } from 'react';
import { Search, Heart, RefreshCw, Settings, AlertCircle, Download, Database, Github, Zap, User, LogOut } from 'lucide-react';

const SteamSupabaseSystem = () => {
  // Supabase設定
  const [supabaseConfig, setSupabaseConfig] = useState({
    url: '',
    anonKey: '',
    isConfigured: false
  });

  // Steam API設定
  const [steamConfig, setSteamConfig] = useState({
    steamIds: ['', '', '', ''],
    accountNames: ['帳號1', '帳號2', '帳號3', '帳號4']
  });

  // 用戶狀態
  const [user, setUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  // 系統狀態
  const [loading, setLoading] = useState(false);
  const [lastSync, setLastSync] = useState(null);
  const [syncStatus, setSyncStatus] = useState('未同步');
  const [showSettings, setShowSettings] = useState(false);
  const [activeTab, setActiveTab] = useState('setup');

  // 遊戲數據
  const [gameLibrary, setGameLibrary] = useState([]);
  const [wishlist, setWishlist] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedAccount, setSelectedAccount] = useState('all');

  // 模擬Supabase客戶端
  const createSupabaseClient = (url, key) => {
    return {
      // 模擬認證功能
      auth: {
        signInWithOAuth: async (provider) => {
          // 模擬GitHub登入
          setUser({ id: '123', email: 'user@example.com', name: '遊戲玩家' });
          setIsAuthenticated(true);
          localStorage.setItem('supabase-auth', JSON.stringify({ authenticated: true }));
        },
        signOut: async () => {
          setUser(null);
          setIsAuthenticated(false);
          localStorage.removeItem('supabase-auth');
        },
        getUser: async () => {
          const saved = localStorage.getItem('supabase-auth');
          if (saved) {
            setUser({ id: '123', email: 'user@example.com', name: '遊戲玩家' });
            setIsAuthenticated(true);
          }
        }
      },
      // 模擬數據庫操作
      from: (table) => ({
        select: () => ({
          eq: () => ({ data: [], error: null })
        }),
        insert: () => ({ data: null, error: null }),
        update: () => ({ data: null, error: null }),
        delete: () => ({ data: null, error: null })
      }),
      // 模擬Edge Functions
      functions: {
        invoke: async (functionName, options) => {
          if (functionName === 'sync-steam-games') {
            return await mockSteamSync(options.body.steamIds);
          }
          return { data: null, error: null };
        }
      }
    };
  };

  // 模擬Steam同步
  const mockSteamSync = async (steamIds) => {
    setLoading(true);
    setSyncStatus('透過Supabase Edge Function同步中...');
    
    // 模擬API延遲
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // 模擬返回遊戲數據
    const mockGames = [
      { id: 1, name: 'Valheim', accounts: [1, 2], playtime: 127, rating: 4.8, genre: '生存', price: 'NT$ 318' },
      { id: 2, name: 'Deep Rock Galactic', accounts: [1, 3, 4], playtime: 89, rating: 4.9, genre: '射擊', price: 'NT$ 590' },
      { id: 3, name: 'Among Us', accounts: [1, 2, 3, 4], playtime: 45, rating: 4.3, genre: '社交', price: 'NT$ 102' },
      { id: 4, name: 'Phasmophobia', accounts: [2, 3], playtime: 67, rating: 4.7, genre: '恐怖', price: 'NT$ 298' },
      { id: 5, name: 'Stardew Valley', accounts: [2, 4], playtime: 203, rating: 4.9, genre: '農場', price: 'NT$ 398' },
      { id: 6, name: 'Portal 2', accounts: [3, 4], playtime: 34, rating: 4.9, genre: '解謎', price: 'NT$ 188' },
      { id: 7, name: 'Terraria', accounts: [1, 3], playtime: 156, rating: 4.7, genre: '沙盒', price: 'NT$ 268' },
      { id: 8, name: 'Overcooked! 2', accounts: [2], playtime: 28, rating: 4.6, genre: '派對', price: 'NT$ 675' }
    ];
    
    setGameLibrary(mockGames);
    setLastSync(new Date());
    setSyncStatus('同步成功 (透過Supabase)');
    setLoading(false);
    
    return { data: mockGames, error: null };
  };

  // Supabase初始化
  useEffect(() => {
    const savedConfig = localStorage.getItem('supabase-config');
    if (savedConfig) {
      const config = JSON.parse(savedConfig);
      setSupabaseConfig(config);
      if (config.isConfigured) {
        const client = createSupabaseClient(config.url, config.anonKey);
        client.auth.getUser();
      }
    }

    const savedSteam = localStorage.getItem('steam-config');
    if (savedSteam) {
      setSteamConfig(JSON.parse(savedSteam));
    }
  }, []);

  // 儲存Supabase設定
  const saveSupabaseConfig = () => {
    const config = {
      ...supabaseConfig,
      isConfigured: supabaseConfig.url && supabaseConfig.anonKey
    };
    setSupabaseConfig(config);
    localStorage.setItem('supabase-config', JSON.stringify(config));
    alert('Supabase設定已儲存！');
  };

  // 儲存Steam設定
  const saveSteamConfig = () => {
    localStorage.setItem('steam-config', JSON.stringify(steamConfig));
    alert('Steam設定已儲存！');
  };

  // GitHub登入
  const signInWithGitHub = async () => {
    if (!supabaseConfig.isConfigured) {
      alert('請先設定Supabase');
      return;
    }
    
    const client = createSupabaseClient(supabaseConfig.url, supabaseConfig.anonKey);
    await client.auth.signInWithOAuth('github');
  };

  // 登出
  const signOut = async () => {
    const client = createSupabaseClient(supabaseConfig.url, supabaseConfig.anonKey);
    await client.auth.signOut();
  };

  // 同步Steam遊戲
  const syncSteamGames = async () => {
    if (!isAuthenticated) {
      alert('請先登入');
      return;
    }

    if (!steamConfig.steamIds.some(id => id.trim())) {
      alert('請先設定Steam ID');
      return;
    }

    const client = createSupabaseClient(supabaseConfig.url, supabaseConfig.anonKey);
    const result = await client.functions.invoke('sync-steam-games', {
      body: { steamIds: steamConfig.steamIds.filter(id => id.trim()) }
    });

    if (result.error) {
      alert('同步失敗: ' + result.error.message);
    }
  };

  // 篩選遊戲
  const filteredGames = gameLibrary.filter(game => {
    const matchesSearch = game.name.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesAccount = selectedAccount === 'all' || game.accounts.includes(parseInt(selectedAccount));
    return matchesSearch && matchesAccount;
  });

  // 統計數據
  const totalGames = gameLibrary.length;
  const accountGameCounts = [1, 2, 3, 4].map(acc => ({
    account: acc,
    count: gameLibrary.filter(game => game.accounts.includes(acc)).length
  }));

  return (
    <div className="min-h-screen bg-gray-900 text-white">
      {/* 頂部導航 */}
      <div className="bg-gray-800 border-b border-gray-700">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div className="flex items-center space-x-2">
                <div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded flex items-center justify-center">
                  <Database className="h-4 w-4 text-white" />
                </div>
                <h1 className="text-xl font-bold">Steam庫存管理系統</h1>
                <div className="flex items-center space-x-1 text-xs bg-gray-700 px-2 py-1 rounded">
                  <Github className="h-3 w-3" />
                  <span>GitHub Pages</span>
                  <span>+</span>
                  <Zap className="h-3 w-3" />
                  <span>Supabase</span>
                </div>
              </div>
            </div>
            
            <div className="flex items-center space-x-4">
              {isAuthenticated ? (
                <div className="flex items-center space-x-3">
                  <div className="flex items-center space-x-2">
                    <User className="h-4 w-4" />
                    <span className="text-sm">{user?.name}</span>
                  </div>
                  <button
                    onClick={signOut}
                    className="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm flex items-center space-x-1"
                  >
                    <LogOut className="h-4 w-4" />
                    <span>登出</span>
                  </button>
                </div>
              ) : (
                <button
                  onClick={signInWithGitHub}
                  disabled={!supabaseConfig.isConfigured}
                  className={`flex items-center space-x-2 px-4 py-2 rounded ${
                    supabaseConfig.isConfigured
                      ? 'bg-green-600 hover:bg-green-700'
                      : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                  }`}
                >
                  <Github className="h-4 w-4" />
                  <span>GitHub登入</span>
                </button>
              )}
              
              <button
                onClick={() => setShowSettings(true)}
                className="bg-gray-600 hover:bg-gray-700 p-2 rounded"
              >
                <Settings className="h-4 w-4" />
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* 狀態提示 */}
      {!supabaseConfig.isConfigured && (
        <div className="bg-blue-600 text-blue-100 px-4 py-3 text-center">
          <div className="flex items-center justify-center space-x-2">
            <AlertCircle className="h-4 w-4" />
            <span>請先設定Supabase連接以開始使用</span>
            <button
              onClick={() => setShowSettings(true)}
              className="underline hover:no-underline"
            >
              立即設定
            </button>
          </div>
        </div>
      )}

      {/* 主要內容 */}
      <div className="max-w-7xl mx-auto px-4 py-6">
        {supabaseConfig.isConfigured ? (
          isAuthenticated ? (
            <div>
              {/* 統計面板 */}
              <div className="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                  <h3 className="text-sm font-medium text-gray-400 mb-1">總遊戲數</h3>
                  <p className="text-2xl font-bold text-blue-400">{totalGames}</p>
                </div>
                {accountGameCounts.map(acc => (
                  <div key={acc.account} className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 className="text-sm font-medium text-gray-400 mb-1">{steamConfig.accountNames[acc.account - 1]}</h3>
                    <p className="text-2xl font-bold text-green-400">{acc.count}</p>
                  </div>
                ))}
                <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                  <h3 className="text-sm font-medium text-gray-400 mb-1">同步狀態</h3>
                  <p className={`text-xs font-bold ${
                    syncStatus.includes('成功') ? 'text-green-400' :
                    syncStatus.includes('失敗') ? 'text-red-400' :
                    'text-yellow-400'
                  }`}>
                    {syncStatus}
                  </p>
                  {lastSync && (
                    <p className="text-xs text-gray-400 mt-1">
                      {lastSync.toLocaleString('zh-TW')}
                    </p>
                  )}
                </div>
              </div>

              {/* 控制面板 */}
              <div className="bg-gray-800 rounded-lg p-4 mb-6 border border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold">控制面板</h3>
                  <button
                    onClick={syncSteamGames}
                    disabled={loading}
                    className={`flex items-center space-x-2 px-4 py-2 rounded ${
                      loading
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                        : 'bg-blue-600 hover:bg-blue-700'
                    }`}
                  >
                    <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
                    <span>{loading ? '同步中...' : '同步Steam遊戲'}</span>
                  </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <input
                      type="text"
                      placeholder="搜尋遊戲..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full bg-gray-700 border border-gray-600 rounded pl-10 pr-4 py-2"
                    />
                  </div>
                  
                  <select
                    value={selectedAccount}
                    onChange={(e) => setSelectedAccount(e.target.value)}
                    className="bg-gray-700 border border-gray-600 rounded px-4 py-2"
                  >
                    <option value="all">所有帳號</option>
                    {steamConfig.accountNames.map((name, index) => (
                      <option key={index + 1} value={index + 1}>{name}</option>
                    ))}
                  </select>
                </div>
              </div>

              {/* 遊戲列表 */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredGames.map(game => (
                  <div key={game.id} className="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 transition-colors">
                    <div className="flex items-start justify-between mb-3">
                      <h3 className="text-lg font-semibold">{game.name}</h3>
                      <div className="flex items-center space-x-1">
                        <span className="text-yellow-400">★</span>
                        <span className="text-sm">{game.rating}</span>
                      </div>
                    </div>

                    <div className="space-y-2 mb-4">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-400">類型：</span>
                        <span>{game.genre}</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-400">遊戲時間：</span>
                        <span>{game.playtime}小時</span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-400">價格：</span>
                        <span>{game.price}</span>
                      </div>
                    </div>

                    <div>
                      <div className="text-sm text-gray-400 mb-2">可用帳號：</div>
                      <div className="flex space-x-1">
                        {game.accounts.map(acc => (
                          <span key={acc} className="bg-blue-600 text-blue-100 px-2 py-1 rounded text-xs">
                            {steamConfig.accountNames[acc - 1]}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {gameLibrary.length === 0 && !loading && (
                <div className="text-center py-12">
                  <Download className="h-16 w-16 text-gray-400 mx-auto mb-4" />
                  <p className="text-gray-400 text-lg mb-2">尚未同步遊戲庫存</p>
                  <p className="text-gray-500">點擊「同步Steam遊戲」開始</p>
                </div>
              )}
            </div>
          ) : (
            <div className="text-center py-12">
              <Github className="h-16 w-16 text-gray-400 mx-auto mb-4" />
              <p className="text-gray-400 text-lg mb-4">請先登入以使用Steam庫存管理功能</p>
              <button
                onClick={signInWithGitHub}
                className="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg flex items-center space-x-2 mx-auto"
              >
                <Github className="h-5 w-5" />
                <span>使用GitHub登入</span>
              </button>
            </div>
          )
        ) : (
          <div className="text-center py-12">
            <Database className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <p className="text-gray-400 text-lg mb-4">請先設定Supabase連接</p>
            <button
              onClick={() => setShowSettings(true)}
              className="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg"
            >
              開始設定
            </button>
          </div>
        )}
      </div>

      {/* 設定彈窗 */}
      {showSettings && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <h3 className="text-xl font-bold mb-6">系統設定</h3>
            
            <div className="space-y-6">
              {/* Supabase設定 */}
              <div>
                <h4 className="text-lg font-semibold mb-3 flex items-center space-x-2">
                  <Zap className="h-5 w-5" />
                  <span>Supabase 設定</span>
                </h4>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium mb-2">Supabase Project URL</label>
                    <input
                      type="url"
                      value={supabaseConfig.url}
                      onChange={(e) => setSupabaseConfig({...supabaseConfig, url: e.target.value})}
                      placeholder="https://your-project.supabase.co"
                      className="w-full bg-gray-700 border border-gray-600 rounded p-2"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Supabase Anon Key</label>
                    <input
                      type="password"
                      value={supabaseConfig.anonKey}
                      onChange={(e) => setSupabaseConfig({...supabaseConfig, anonKey: e.target.value})}
                      placeholder="eyJhbGciOiJIUzI1NiIs..."
                      className="w-full bg-gray-700 border border-gray-600 rounded p-2"
                    />
                  </div>
                  <button
                    onClick={saveSupabaseConfig}
                    className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded"
                  >
                    儲存Supabase設定
                  </button>
                </div>
              </div>

              {/* Steam設定 */}
              <div>
                <h4 className="text-lg font-semibold mb-3">Steam 帳號設定</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {[1, 2, 3, 4].map(num => (
                    <div key={num} className="space-y-2">
                      <label className="block text-sm font-medium">帳號 #{num} 名稱</label>
                      <input
                        type="text"
                        value={steamConfig.accountNames[num - 1]}
                        onChange={(e) => {
                          const newNames = [...steamConfig.accountNames];
                          newNames[num - 1] = e.target.value;
                          setSteamConfig({...steamConfig, accountNames: newNames});
                        }}
                        className="w-full bg-gray-700 border border-gray-600 rounded p-2"
                      />
                      <label className="block text-sm font-medium">Steam ID</label>
                      <input
                        type="text"
                        value={steamConfig.steamIds[num - 1]}
                        onChange={(e) => {
                          const newIds = [...steamConfig.steamIds];
                          newIds[num - 1] = e.target.value;
                          setSteamConfig({...steamConfig, steamIds: newIds});
                        }}
                        placeholder="76561198xxxxxxxxx"
                        className="w-full bg-gray-700 border border-gray-600 rounded p-2"
                      />
                    </div>
                  ))}
                </div>
                <button
                  onClick={saveSteamConfig}
                  className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded mt-4"
                >
                  儲存Steam設定
                </button>
              </div>

              <div className="flex justify-end">
                <button
                  onClick={() => setShowSettings(false)}
                  className="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded"
                >
                  關閉
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default SteamSupabaseSystem;